<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BwanaBet Accounting System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    @keyframes spin { to { transform: rotate(360deg); } }
    .spinner { animation: spin 1s linear infinite; }
    .tab-btn.active { background: #FDF104; color: #000; }
    .notification { animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    
    /* Yellow Theme Overrides */
    .text-yellow-400 { color: #FDF104 !important; }
    .bg-yellow-400 { background-color: #FDF104 !important; }
    .bg-yellow-500 { background-color: #FDF104 !important; }
    .border-yellow-400 { border-color: #FDF104 !important; }
    .border-yellow-500 { border-color: #FDF104 !important; }
    .hover\:bg-yellow-400:hover { background-color: #E6DA00 !important; }
    .hover\:bg-yellow-500:hover { background-color: #E6DA00 !important; }
    .ring-yellow-400 { --tw-ring-color: #FDF104 !important; }
    .focus\:ring-yellow-400:focus { --tw-ring-color: #FDF104 !important; }
  </style>
</head>
<body class="bg-slate-100 min-h-screen">
  <!-- LOGIN SCREEN -->
  <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-900 to-slate-800 p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
      <div class="bg-black p-6 text-center border-b-4 border-yellow-400">
        <h1 class="text-yellow-400 font-extrabold text-3xl tracking-tight">BWANABET</h1>
        <p class="text-slate-400 text-sm mt-1" data-translate="accountingSystem">Accounting System v1.0</p>
      </div>
      <div class="p-6 sm:p-8">
        <div class="flex justify-center mb-6">
          <select id="loginLanguageSelect" class="px-3 py-1.5 bg-slate-100 text-slate-700 rounded-lg text-sm border cursor-pointer">
            <option value="en">üá¨üáß English</option>
            <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
          </select>
        </div>
        <h2 class="text-xl font-bold text-slate-800 mb-6 text-center" data-translate="signIn">Sign In</h2>
        <div id="loginError" class="hidden mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm"></div>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="email">Email</label>
            <input type="email" id="loginEmail" placeholder="you@example.com" class="w-full px-4 py-3 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-yellow-400 focus:border-transparent"/>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="password">Password</label>
            <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full px-4 py-3 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-yellow-400 focus:border-transparent"/>
          </div>
          <button id="loginBtn" class="w-full py-3 bg-yellow-500 text-black font-bold rounded-lg hover:bg-yellow-400 flex items-center justify-center gap-2">
            <i data-lucide="log-in" class="h-5 w-5"></i>
            <span data-translate="signIn">Sign In</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN APPLICATION -->
  <div id="mainApp" class="hidden">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black/30 flex items-center justify-center z-[100]">
      <div class="bg-white rounded-xl p-6 flex items-center gap-4 shadow-2xl">
        <svg class="spinner h-8 w-8 text-yellow-500" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
        </svg>
        <span class="text-lg font-medium text-slate-700" id="loadingText">Loading...</span>
      </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="hidden fixed top-4 right-4 left-4 sm:left-auto z-50 px-4 py-3 rounded-lg shadow-xl flex items-center gap-3 notification"></div>

    <!-- Header -->
    <header class="bg-black shadow-md border-b-4 border-yellow-400">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 py-3">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3 sm:gap-6">
            <div class="text-yellow-400 font-extrabold text-xl sm:text-2xl tracking-tight">BWANABET</div>
            <div class="hidden sm:block border-l-2 border-slate-600 pl-4">
              <h1 class="text-lg font-bold text-white" data-translate="accounting">Accounting</h1>
            </div>
          </div>
          <div class="flex items-center gap-2 sm:gap-4">
            <select id="languageSelect" class="px-2 py-1.5 bg-slate-700 text-slate-300 rounded-lg text-sm border-none cursor-pointer hover:bg-slate-600">
              <option value="en">üá¨üáß English</option>
              <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
            </select>
            <span id="userEmail" class="text-xs text-slate-400 hidden sm:inline truncate max-w-[120px]"></span>
            <button id="logoutBtn" class="flex items-center gap-1 px-2 sm:px-3 py-1.5 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-lg text-sm">
              <i data-lucide="log-out" class="h-4 w-4"></i>
              <span class="hidden sm:inline" data-translate="logout">Logout</span>
            </button>
          </div>
        </div>
        <!-- Navigation Tabs -->
        <div class="flex items-center gap-1 bg-slate-800 rounded-lg p-1 mt-3 overflow-x-auto">
          <button id="tab-overview" class="tab-btn active flex items-center gap-2 px-4 py-2 rounded-md font-medium text-slate-300 whitespace-nowrap">
            <i data-lucide="layout-dashboard" class="h-4 w-4"></i>
            <span data-translate="overview">Overview</span>
          </button>
          <button id="tab-revenue" class="tab-btn flex items-center gap-2 px-4 py-2 rounded-md font-medium text-slate-300 whitespace-nowrap">
            <i data-lucide="trending-up" class="h-4 w-4"></i>
            <span data-translate="revenue">Revenue</span>
          </button>
          <button id="tab-expenses" class="tab-btn flex items-center gap-2 px-4 py-2 rounded-md font-medium text-slate-300 whitespace-nowrap">
            <i data-lucide="trending-down" class="h-4 w-4"></i>
            <span data-translate="expenses">Expenses</span>
          </button>
          <button id="tab-reports" class="tab-btn flex items-center gap-2 px-4 py-2 rounded-md font-medium text-slate-300 whitespace-nowrap">
            <i data-lucide="bar-chart-3" class="h-4 w-4"></i>
            <span data-translate="reports">Reports</span>
          </button>
          <button id="tab-settings" class="tab-btn flex items-center gap-2 px-4 py-2 rounded-md font-medium text-slate-300 whitespace-nowrap">
            <i data-lucide="settings" class="h-4 w-4"></i>
            <span data-translate="settings">Settings</span>
          </button>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 py-4 sm:py-8">
      <!-- OVERVIEW TAB -->
      <div id="content-overview" class="tab-content">
        <!-- Summary Cards -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-emerald-500">
            <p class="text-xs text-slate-500" data-translate="totalRevenue">Total Revenue</p>
            <p class="text-2xl font-bold text-emerald-600" id="total-revenue">K0</p>
            <p class="text-xs text-emerald-500 mt-1" data-translate="thisMonth">This month</p>
          </div>
          <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-red-500">
            <p class="text-xs text-slate-500" data-translate="totalExpenses">Total Expenses</p>
            <p class="text-2xl font-bold text-red-600" id="total-expenses">K0</p>
            <p class="text-xs text-red-500 mt-1" data-translate="thisMonth">This month</p>
          </div>
          <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-blue-500">
            <p class="text-xs text-slate-500" data-translate="netProfit">Net Profit</p>
            <p class="text-2xl font-bold text-blue-600" id="net-profit">K0</p>
            <p class="text-xs text-blue-500 mt-1" data-translate="thisMonth">This month</p>
          </div>
          <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-purple-500">
            <p class="text-xs text-slate-500" data-translate="transactionCount">Transactions</p>
            <p class="text-2xl font-bold text-purple-600" id="transaction-count">0</p>
            <p class="text-xs text-purple-500 mt-1" data-translate="thisMonth">This month</p>
          </div>
        </div>

        <!-- Exchange Rates Bar -->
        <div class="bg-gradient-to-r from-slate-800 to-slate-900 rounded-xl p-4 mb-6">
          <div class="flex items-center justify-between flex-wrap gap-4">
            <div class="flex items-center gap-6">
              <span class="text-slate-400 text-sm" data-translate="exchangeRates">Exchange Rates:</span>
              <div class="flex items-center gap-4">
                <span class="text-white font-medium">1 USD = <span id="rate-usd" class="text-yellow-400">--</span> ZMW</span>
                <span class="text-white font-medium">1 EUR = <span id="rate-eur" class="text-yellow-400">--</span> ZMW</span>
              </div>
            </div>
            <button onclick="refreshExchangeRates()" class="flex items-center gap-2 px-3 py-1.5 bg-yellow-500 text-black rounded-lg text-sm font-medium hover:bg-yellow-400">
              <i data-lucide="refresh-cw" class="h-4 w-4"></i>
              <span data-translate="refresh">Refresh</span>
            </button>
          </div>
          <p class="text-xs text-slate-500 mt-2"><span data-translate="lastUpdated">Last updated</span>: <span id="rates-updated">Never</span></p>
        </div>

        <!-- Charts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div class="bg-white rounded-xl shadow-sm p-5">
            <div class="flex items-center justify-between mb-4">
              <h3 class="font-bold text-slate-800" data-translate="revenueVsExpenses">Revenue vs Expenses</h3>
              <select id="chartTypeRevExp" onchange="updateOverviewCharts()" class="text-xs border rounded px-2 py-1">
                <option value="line">Line</option>
                <option value="bar">Bar</option>
              </select>
            </div>
            <div class="h-64"><canvas id="revenueExpensesChart"></canvas></div>
          </div>
          <div class="bg-white rounded-xl shadow-sm p-5">
            <div class="flex items-center justify-between mb-4">
              <h3 class="font-bold text-slate-800" data-translate="expensesByCategory">Expenses by Category</h3>
              <select id="chartTypeCat" onchange="updateOverviewCharts()" class="text-xs border rounded px-2 py-1">
                <option value="doughnut">Pie</option>
                <option value="bar">Bar</option>
              </select>
            </div>
            <div class="h-64"><canvas id="categoryPieChart"></canvas></div>
          </div>
        </div>

        <!-- Recent Transactions -->
        <div class="bg-white rounded-xl shadow-sm p-5">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold text-slate-800" data-translate="recentTransactions">Recent Transactions</h3>
            <button onclick="switchTab('expenses')" class="text-sm text-yellow-600 hover:text-yellow-700" data-translate="viewAll">View All ‚Üí</button>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-slate-50">
                <tr>
                  <th class="px-4 py-2 text-left text-slate-600" data-translate="date">Date</th>
                  <th class="px-4 py-2 text-left text-slate-600" data-translate="type">Type</th>
                  <th class="px-4 py-2 text-left text-slate-600" data-translate="description">Description</th>
                  <th class="px-4 py-2 text-left text-slate-600" data-translate="category">Category</th>
                  <th class="px-4 py-2 text-right text-slate-600" data-translate="amount">Amount</th>
                </tr>
              </thead>
              <tbody id="recentTransactionsBody">
                <tr><td colspan="5" class="px-4 py-8 text-center text-slate-400" data-translate="noTransactions">No transactions yet</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- REVENUE TAB -->
      <div id="content-revenue" class="tab-content hidden">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold text-slate-800" data-translate="revenueManagement">Revenue Management</h2>
          <button onclick="openParamsModal('revenue')" class="flex items-center gap-2 px-3 py-1.5 bg-slate-100 text-slate-700 rounded-lg text-sm hover:bg-slate-200">
            <i data-lucide="settings" class="h-4 w-4"></i>
            <span data-translate="editParameters">Edit Parameters</span>
          </button>
        </div>

        <!-- Revenue Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-xl p-5 text-white">
            <p class="text-emerald-100 text-sm" data-translate="sportsRevenue">Sports Revenue</p>
            <p class="text-3xl font-bold mt-1" id="sports-revenue">K0</p>
            <p class="text-xs text-emerald-200 mt-2"><span data-translate="target">Target</span>: K<span id="paramSportsTarget">100,000</span></p>
          </div>
          <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-5 text-white">
            <p class="text-purple-100 text-sm" data-translate="casinoRevenue">Casino Revenue</p>
            <p class="text-3xl font-bold mt-1" id="casino-revenue">K0</p>
            <p class="text-xs text-purple-200 mt-2"><span data-translate="target">Target</span>: K<span id="paramCasinoTarget">50,000</span></p>
          </div>
          <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-5 text-white">
            <p class="text-blue-100 text-sm" data-translate="otherRevenue">Other Revenue</p>
            <p class="text-3xl font-bold mt-1" id="other-revenue">K0</p>
            <p class="text-xs text-blue-200 mt-2"><span data-translate="target">Target</span>: K<span id="paramOtherTarget">10,000</span></p>
          </div>
        </div>

        <!-- Add Revenue Form -->
        <div class="bg-white rounded-xl shadow-sm p-5 mb-6">
          <h3 class="font-bold text-slate-800 mb-4" data-translate="addRevenue">Add Revenue Entry</h3>
          <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="date">Date</label>
              <input type="date" id="revDate" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-yellow-400">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="type">Type</label>
              <select id="revType" class="w-full px-3 py-2 border rounded-lg">
                <option value="sports">Sports</option>
                <option value="casino">Casino</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="amount">Amount</label>
              <div class="flex">
                <select id="revCurrency" class="px-2 py-2 border border-r-0 rounded-l-lg bg-slate-50">
                  <option value="ZMW">K</option>
                  <option value="USD">$</option>
                  <option value="EUR">‚Ç¨</option>
                </select>
                <input type="number" id="revAmount" placeholder="0.00" class="w-full px-3 py-2 border rounded-r-lg">
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="reference">Reference</label>
              <input type="text" id="revReference" placeholder="REF-001" class="w-full px-3 py-2 border rounded-lg">
            </div>
            <div class="flex items-end">
              <button onclick="addRevenue()" class="w-full px-4 py-2 bg-emerald-500 text-white rounded-lg font-medium hover:bg-emerald-600">
                <i data-lucide="plus" class="h-4 w-4 inline mr-1"></i>
                <span data-translate="add">Add</span>
              </button>
            </div>
          </div>
          <div class="mt-3">
            <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="description">Description</label>
            <input type="text" id="revDescription" placeholder="Enter description..." class="w-full px-3 py-2 border rounded-lg">
          </div>
        </div>

        <!-- Revenue Table -->
        <div class="bg-white rounded-xl shadow-sm p-5">
          <h3 class="font-bold text-slate-800 mb-4" data-translate="revenueHistory">Revenue History</h3>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-slate-50">
                <tr>
                  <th class="px-4 py-2 text-left text-slate-600" data-translate="date">Date</th>
                  <th class="px-4 py-2 text-left text-slate-600" data-translate="type">Type</th>
                  <th class="px-4 py-2 text-left text-slate-600" data-translate="description">Description</th>
                  <th class="px-4 py-2 text-left text-slate-600" data-translate="reference">Reference</th>
                  <th class="px-4 py-2 text-right text-slate-600" data-translate="amount">Amount</th>
                  <th class="px-4 py-2 text-center text-slate-600" data-translate="actions">Actions</th>
                </tr>
              </thead>
              <tbody id="revenueTableBody">
                <tr><td colspan="6" class="px-4 py-8 text-center text-slate-400" data-translate="noRevenue">No revenue entries yet</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- EXPENSES TAB -->
      <div id="content-expenses" class="tab-content hidden">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold text-slate-800" data-translate="expenseManagement">Expense Management</h2>
          <div class="flex gap-2">
            <button onclick="openParamsModal('expenses')" class="flex items-center gap-2 px-3 py-1.5 bg-slate-100 text-slate-700 rounded-lg text-sm hover:bg-slate-200">
              <i data-lucide="settings" class="h-4 w-4"></i>
              <span data-translate="editParameters">Edit Parameters</span>
            </button>
            <button onclick="downloadExpenseTemplate()" class="flex items-center gap-2 px-3 py-1.5 bg-slate-100 text-slate-700 rounded-lg text-sm hover:bg-slate-200">
              <i data-lucide="download" class="h-4 w-4"></i>
              <span data-translate="template">Template</span>
            </button>
            <button onclick="showBulkUploadModal()" class="flex items-center gap-2 px-3 py-1.5 bg-slate-100 text-slate-700 rounded-lg text-sm hover:bg-slate-200">
              <i data-lucide="upload" class="h-4 w-4"></i>
              <span data-translate="bulkUpload">Bulk Upload</span>
            </button>
            <button onclick="showAddExpenseModal()" class="flex items-center gap-2 px-4 py-2 bg-yellow-500 text-black rounded-lg font-medium hover:bg-yellow-400">
              <i data-lucide="plus" class="h-4 w-4"></i>
              <span data-translate="addExpense">Add Expense</span>
            </button>
          </div>
        </div>

        <!-- Expense Category Summary -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-purple-500">
            <p class="text-xs text-slate-500" data-translate="gamingOperations">Gaming Operations</p>
            <p class="text-xl font-bold text-purple-600" id="exp-gaming">K0</p>
            <p class="text-xs text-slate-400"><span data-translate="budget">Budget</span>: K<span id="paramGamingBudget">50,000</span></p>
          </div>
          <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-amber-500">
            <p class="text-xs text-slate-500" data-translate="shopOperating">Shop Operating</p>
            <p class="text-xl font-bold text-amber-600" id="exp-shop">K0</p>
            <p class="text-xs text-slate-400"><span data-translate="budget">Budget</span>: K<span id="paramShopBudget">30,000</span></p>
          </div>
          <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-blue-500">
            <p class="text-xs text-slate-500" data-translate="officeOperations">Office Operations</p>
            <p class="text-xl font-bold text-blue-600" id="exp-office">K0</p>
            <p class="text-xs text-slate-400"><span data-translate="budget">Budget</span>: K<span id="paramOfficeBudget">20,000</span></p>
          </div>
          <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-emerald-500">
            <p class="text-xs text-slate-500" data-translate="administrative">Administrative</p>
            <p class="text-xl font-bold text-emerald-600" id="exp-admin">K0</p>
            <p class="text-xs text-slate-400"><span data-translate="budget">Budget</span>: K<span id="paramAdminBudget">25,000</span></p>
          </div>
        </div>

        <!-- Expense Filters -->
        <div class="bg-white rounded-xl shadow-sm p-4 mb-6">
          <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="fromDate">From Date</label>
              <input type="date" id="expFilterFrom" class="w-full px-3 py-2 border rounded-lg">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="toDate">To Date</label>
              <input type="date" id="expFilterTo" class="w-full px-3 py-2 border rounded-lg">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="category">Category</label>
              <select id="expFilterCategory" class="w-full px-3 py-2 border rounded-lg">
                <option value="" data-translate="allCategories">All Categories</option>
                <option value="gaming_operations">Gaming Operations</option>
                <option value="shop_operating">Shop Operating</option>
                <option value="office_operations">Office Operations</option>
                <option value="administrative">Administrative</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="currency">Currency</label>
              <select id="expFilterCurrency" class="w-full px-3 py-2 border rounded-lg">
                <option value="">All</option>
                <option value="ZMW">ZMW</option>
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
              </select>
            </div>
            <div class="flex items-end gap-2">
              <button onclick="filterExpenses()" class="flex-1 px-4 py-2 bg-slate-800 text-white rounded-lg font-medium hover:bg-slate-700">
                <i data-lucide="filter" class="h-4 w-4 inline mr-1"></i>
                <span data-translate="filter">Filter</span>
              </button>
              <button onclick="clearExpenseFilters()" class="px-3 py-2 bg-slate-100 text-slate-600 rounded-lg hover:bg-slate-200">
                <i data-lucide="x" class="h-4 w-4"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Expenses Table -->
        <div class="bg-white rounded-xl shadow-sm p-5">
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-slate-50">
                <tr>
                  <th class="px-4 py-2 text-left text-slate-600" data-translate="date">Date</th>
                  <th class="px-4 py-2 text-left text-slate-600" data-translate="category">Category</th>
                  <th class="px-4 py-2 text-left text-slate-600" data-translate="vendor">Vendor</th>
                  <th class="px-4 py-2 text-left text-slate-600" data-translate="description">Description</th>
                  <th class="px-4 py-2 text-right text-slate-600" data-translate="amount">Amount</th>
                  <th class="px-4 py-2 text-center text-slate-600" data-translate="receipt">Receipt</th>
                  <th class="px-4 py-2 text-center text-slate-600" data-translate="actions">Actions</th>
                </tr>
              </thead>
              <tbody id="expensesTableBody">
                <tr><td colspan="7" class="px-4 py-8 text-center text-slate-400" data-translate="noExpenses">No expenses recorded yet</td></tr>
              </tbody>
            </table>
          </div>
          <div class="mt-4 flex items-center justify-between text-sm text-slate-500">
            <span id="expensesCount">0 <span data-translate="expenses">expenses</span></span>
            <span><span data-translate="total">Total</span>: <span id="expensesTotal">K0</span></span>
          </div>
        </div>
      </div>

      <!-- REPORTS TAB -->
      <div id="content-reports" class="tab-content hidden">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold text-slate-800" data-translate="financialReports">Financial Reports</h2>
          <button onclick="openParamsModal('reports')" class="flex items-center gap-2 px-3 py-1.5 bg-slate-100 text-slate-700 rounded-lg text-sm hover:bg-slate-200">
            <i data-lucide="settings" class="h-4 w-4"></i>
            <span data-translate="editParameters">Edit Parameters</span>
          </button>
        </div>

        <!-- Report Controls -->
        <div class="bg-white rounded-xl shadow-sm p-4 mb-6">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="fromDate">From Date</label>
              <input type="date" id="reportDateFrom" class="w-full px-3 py-2 border rounded-lg">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="toDate">To Date</label>
              <input type="date" id="reportDateTo" class="w-full px-3 py-2 border rounded-lg">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="projectionMethod">Projection Method</label>
              <select id="projectionMethod" class="w-full px-3 py-2 border rounded-lg">
                <option value="historical" data-translate="historicalAverage">Historical Average</option>
                <option value="linear" data-translate="linearTrend">Linear Trend</option>
                <option value="manual" data-translate="manualTarget">Manual Target</option>
              </select>
            </div>
            <div class="flex items-end">
              <button onclick="generateReports()" class="w-full px-4 py-2 bg-yellow-500 text-black rounded-lg font-medium hover:bg-yellow-400">
                <i data-lucide="bar-chart-3" class="h-4 w-4 inline mr-1"></i>
                <span data-translate="generate">Generate</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Charts Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div class="bg-white rounded-xl shadow-sm p-5">
            <h3 class="font-bold text-slate-800 mb-4" data-translate="monthlyTrend">Monthly Trend</h3>
            <div class="h-64"><canvas id="reportTrendChart"></canvas></div>
          </div>
          <div class="bg-white rounded-xl shadow-sm p-5">
            <h3 class="font-bold text-slate-800 mb-4" data-translate="profitLoss">Profit/Loss by Month</h3>
            <div class="h-64"><canvas id="reportProfitChart"></canvas></div>
          </div>
          <div class="bg-white rounded-xl shadow-sm p-5">
            <h3 class="font-bold text-slate-800 mb-4" data-translate="revenueBySource">Revenue by Source</h3>
            <div class="h-64"><canvas id="reportRevenueSourceChart"></canvas></div>
          </div>
          <div class="bg-white rounded-xl shadow-sm p-5">
            <h3 class="font-bold text-slate-800 mb-4" data-translate="currencyBreakdown">Currency Breakdown</h3>
            <div class="h-64"><canvas id="reportCurrencyChart"></canvas></div>
          </div>
          <div class="bg-white rounded-xl shadow-sm p-5 lg:col-span-2">
            <h3 class="font-bold text-slate-800 mb-4" data-translate="projections">30-Day Projections</h3>
            <div class="h-64"><canvas id="reportProjectionChart"></canvas></div>
          </div>
        </div>

        <!-- Export Buttons -->
        <div class="flex gap-4">
          <button onclick="exportReportCSV()" class="flex items-center gap-2 px-4 py-2 bg-emerald-500 text-white rounded-lg font-medium hover:bg-emerald-600">
            <i data-lucide="file-spreadsheet" class="h-4 w-4"></i>
            <span data-translate="exportCsv">Export CSV</span>
          </button>
          <button onclick="printReport()" class="flex items-center gap-2 px-4 py-2 bg-slate-600 text-white rounded-lg font-medium hover:bg-slate-700">
            <i data-lucide="printer" class="h-4 w-4"></i>
            <span data-translate="print">Print</span>
          </button>
        </div>
      </div>

      <!-- SETTINGS TAB -->
      <div id="content-settings" class="tab-content hidden">
        <h2 class="text-xl font-bold text-slate-800 mb-6" data-translate="accountingSettings">Accounting Settings</h2>

        <!-- User Info -->
        <div class="bg-white rounded-xl shadow-sm p-5 mb-6">
          <h3 class="font-bold text-slate-800 mb-4" data-translate="accountInfo">Account Information</h3>
          <div class="flex items-center gap-4">
            <div class="w-16 h-16 bg-yellow-500 rounded-full flex items-center justify-center">
              <i data-lucide="user" class="h-8 w-8 text-black"></i>
            </div>
            <div>
              <p class="font-medium text-slate-800" id="settingsUserEmail">user@example.com</p>
              <p class="text-sm text-slate-500" data-translate="administrator">Administrator</p>
            </div>
          </div>
        </div>

        <!-- Subcategory Management -->
        <div class="bg-white rounded-xl shadow-sm p-5 mb-6">
          <h3 class="font-bold text-slate-800 mb-4" data-translate="expenseSubcategories">Expense Subcategories</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Gaming Operations -->
            <div class="border rounded-lg p-4">
              <div class="flex items-center justify-between mb-3">
                <h4 class="font-medium text-purple-700 flex items-center gap-2">
                  <span class="w-3 h-3 rounded-full bg-purple-500"></span>
                  <span data-translate="gamingOperations">Gaming Operations</span>
                </h4>
                <button onclick="addSubcategory('gaming_operations')" class="text-purple-600 hover:text-purple-700">
                  <i data-lucide="plus" class="h-4 w-4"></i>
                </button>
              </div>
              <div id="subcats-gaming_operations" class="space-y-2 text-sm">
                <p class="text-slate-400" data-translate="noSubcategories">No subcategories defined</p>
              </div>
            </div>
            <!-- Shop Operating -->
            <div class="border rounded-lg p-4">
              <div class="flex items-center justify-between mb-3">
                <h4 class="font-medium text-amber-700 flex items-center gap-2">
                  <span class="w-3 h-3 rounded-full bg-amber-500"></span>
                  <span data-translate="shopOperating">Shop Operating Expenses</span>
                </h4>
                <button onclick="addSubcategory('shop_operating')" class="text-amber-600 hover:text-amber-700">
                  <i data-lucide="plus" class="h-4 w-4"></i>
                </button>
              </div>
              <div id="subcats-shop_operating" class="space-y-2 text-sm">
                <p class="text-slate-400" data-translate="noSubcategories">No subcategories defined</p>
              </div>
            </div>
            <!-- Office Operations -->
            <div class="border rounded-lg p-4">
              <div class="flex items-center justify-between mb-3">
                <h4 class="font-medium text-blue-700 flex items-center gap-2">
                  <span class="w-3 h-3 rounded-full bg-blue-500"></span>
                  <span data-translate="officeOperations">Office Operations</span>
                </h4>
                <button onclick="addSubcategory('office_operations')" class="text-blue-600 hover:text-blue-700">
                  <i data-lucide="plus" class="h-4 w-4"></i>
                </button>
              </div>
              <div id="subcats-office_operations" class="space-y-2 text-sm">
                <p class="text-slate-400" data-translate="noSubcategories">No subcategories defined</p>
              </div>
            </div>
            <!-- Administrative -->
            <div class="border rounded-lg p-4">
              <div class="flex items-center justify-between mb-3">
                <h4 class="font-medium text-emerald-700 flex items-center gap-2">
                  <span class="w-3 h-3 rounded-full bg-emerald-500"></span>
                  <span data-translate="administrative">Administrative Operations</span>
                </h4>
                <button onclick="addSubcategory('administrative')" class="text-emerald-600 hover:text-emerald-700">
                  <i data-lucide="plus" class="h-4 w-4"></i>
                </button>
              </div>
              <div id="subcats-administrative" class="space-y-2 text-sm">
                <p class="text-slate-400" data-translate="noSubcategories">No subcategories defined</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Audit Log -->
        <div class="bg-white rounded-xl shadow-sm p-5">
          <h3 class="font-bold text-slate-800 mb-4" data-translate="auditLog">Audit Log</h3>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-slate-50">
                <tr>
                  <th class="px-4 py-2 text-left text-slate-600" data-translate="timestamp">Timestamp</th>
                  <th class="px-4 py-2 text-left text-slate-600" data-translate="user">User</th>
                  <th class="px-4 py-2 text-left text-slate-600" data-translate="action">Action</th>
                  <th class="px-4 py-2 text-left text-slate-600" data-translate="details">Details</th>
                </tr>
              </thead>
              <tbody id="auditLogBody">
                <tr><td colspan="4" class="px-4 py-8 text-center text-slate-400" data-translate="noAuditLogs">No audit logs yet</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>

    <!-- Add Expense Modal -->
    <div id="addExpenseModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden">
        <div class="px-6 py-4 border-b-2 border-yellow-400 bg-gradient-to-r from-slate-900 to-slate-800">
          <h3 class="text-lg font-bold text-white" data-translate="addExpense">Add Expense</h3>
        </div>
        <div class="p-6 space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="date">Date</label>
              <input type="date" id="expDate" class="w-full px-3 py-2 border rounded-lg">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="category">Category</label>
              <select id="expCategory" onchange="loadSubcategoriesDropdown()" class="w-full px-3 py-2 border rounded-lg">
                <option value="gaming_operations">Gaming Operations</option>
                <option value="shop_operating">Shop Operating</option>
                <option value="office_operations">Office Operations</option>
                <option value="administrative">Administrative</option>
              </select>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="subcategory">Subcategory</label>
            <select id="expSubcategory" class="w-full px-3 py-2 border rounded-lg">
              <option value="">Select subcategory...</option>
            </select>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="amount">Amount</label>
              <div class="flex">
                <select id="expCurrency" class="px-2 py-2 border border-r-0 rounded-l-lg bg-slate-50">
                  <option value="ZMW">K (ZMW)</option>
                  <option value="USD">$ (USD)</option>
                  <option value="EUR">‚Ç¨ (EUR)</option>
                </select>
                <input type="number" id="expAmount" placeholder="0.00" class="w-full px-3 py-2 border rounded-r-lg">
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="paymentMethod">Payment Method</label>
              <select id="expPaymentMethod" class="w-full px-3 py-2 border rounded-lg">
                <option value="cash">Cash</option>
                <option value="bank_transfer">Bank Transfer</option>
                <option value="mobile_money">Mobile Money</option>
                <option value="card">Card</option>
              </select>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="vendor">Vendor/Payee</label>
            <input type="text" id="expVendor" placeholder="Enter vendor name..." class="w-full px-3 py-2 border rounded-lg">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="description">Description</label>
            <input type="text" id="expDescription" placeholder="Enter description..." class="w-full px-3 py-2 border rounded-lg">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="receiptNumber">Receipt Number</label>
            <input type="text" id="expReceiptNum" placeholder="Optional..." class="w-full px-3 py-2 border rounded-lg">
          </div>
        </div>
        <div class="px-6 py-4 bg-slate-50 border-t flex gap-3">
          <button onclick="closeAddExpenseModal()" class="flex-1 py-2 px-4 border border-slate-300 rounded-lg text-slate-600 font-medium hover:bg-slate-100" data-translate="cancel">Cancel</button>
          <button onclick="saveExpense()" class="flex-1 py-2 px-4 bg-yellow-500 text-black rounded-lg font-medium hover:bg-yellow-400" data-translate="saveExpense">Save Expense</button>
        </div>
      </div>
    </div>

    <!-- Bulk Upload Modal -->
    <div id="bulkUploadModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden">
        <div class="px-6 py-4 border-b-2 border-yellow-400 bg-gradient-to-r from-slate-900 to-slate-800">
          <h3 class="text-lg font-bold text-white" data-translate="bulkUploadExpenses">Bulk Upload Expenses</h3>
        </div>
        <div class="p-6">
          <label class="block border-2 border-dashed border-slate-300 rounded-xl p-8 text-center cursor-pointer hover:border-yellow-400">
            <input type="file" id="bulkUploadFile" accept=".csv,.xlsx,.xls" class="hidden" onchange="handleBulkUpload(this.files[0])">
            <i data-lucide="upload-cloud" class="h-12 w-12 text-slate-400 mx-auto mb-3"></i>
            <p class="text-slate-600 font-medium" data-translate="dragDropFile">Drag & drop or click to upload</p>
            <p class="text-sm text-slate-400 mt-1">CSV, XLSX, XLS</p>
          </label>
          <div id="bulkUploadPreview" class="hidden mt-4 max-h-48 overflow-auto border rounded-lg"></div>
        </div>
        <div class="px-6 py-4 bg-slate-50 border-t flex gap-3">
          <button onclick="closeBulkUploadModal()" class="flex-1 py-2 px-4 border border-slate-300 rounded-lg text-slate-600 font-medium hover:bg-slate-100" data-translate="cancel">Cancel</button>
          <button id="confirmBulkUploadBtn" onclick="confirmBulkUpload()" class="flex-1 py-2 px-4 bg-yellow-500 text-black rounded-lg font-medium hover:bg-yellow-400 disabled:opacity-50" disabled data-translate="import">Import</button>
        </div>
      </div>
    </div>

    <!-- Parameters Modal -->
    <div id="paramsModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden max-h-[90vh] flex flex-col">
        <div class="px-6 py-4 border-b-2 border-yellow-400 bg-gradient-to-r from-slate-900 to-slate-800">
          <h3 class="text-lg font-bold text-white flex items-center gap-2">
            <i data-lucide="settings" class="h-5 w-5 text-yellow-400"></i>
            <span id="paramsModalTitle" data-translate="editParameters">Edit Parameters</span>
          </h3>
          <p class="text-xs text-slate-400 mt-1" id="paramsModalSubtitle" data-translate="adjustThresholds">Adjust thresholds and targets</p>
        </div>
        <div class="p-6 overflow-y-auto flex-1" id="paramsModalContent">
          <!-- Content will be dynamically loaded -->
        </div>
        <div class="px-6 py-4 bg-slate-50 border-t flex gap-3">
          <button onclick="closeParamsModal()" class="flex-1 py-2 px-4 border border-slate-300 rounded-lg text-slate-600 font-medium hover:bg-slate-100" data-translate="cancel">Cancel</button>
          <button onclick="saveParams()" class="flex-1 py-2 px-4 bg-yellow-500 text-black rounded-lg font-medium hover:bg-yellow-400" data-translate="saveAndApply">Save & Apply</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========== CONFIGURATION ==========
    var SUPABASE_URL = 'https://blrrcnrhixckfudiojwe.supabase.co';
    var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJscnJjbnJoaXhja2Z1ZGlvandlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3Nzg0MzMsImV4cCI6MjA4MzM1NDQzM30.2DGACAZz-f_r0ieYz3hvtsOG1y-3fqTD_ENH2ZR2g1k';
    
    var App = {
      db: null,
      user: null,
      currentLang: 'en',
      charts: {},
      expenses: [],
      revenue: [],
      auditLog: [],
      exchangeRates: { USD: 27.5, EUR: 29.8 },
      ratesLastUpdated: null,
      currentParamsTab: null,
      expenseCategories: {
        gaming_operations: { name: 'Gaming Operations', color: '#8B5CF6', subcategories: [] },
        shop_operating: { name: 'Shop Operating Expenses', color: '#F59E0B', subcategories: [] },
        office_operations: { name: 'Office Operations', color: '#3B82F6', subcategories: [] },
        administrative: { name: 'Administrative Operations', color: '#10B981', subcategories: [] }
      },
      params: {
        // Revenue targets
        sportsTarget: 100000,
        casinoTarget: 50000,
        otherTarget: 10000,
        // Expense budgets
        gamingBudget: 50000,
        shopBudget: 30000,
        officeBudget: 20000,
        adminBudget: 25000,
        // Report settings
        projectionMonths: 1,
        fiscalYearStart: 1 // January
      }
    };

    // ========== TRANSLATIONS ==========
    var TRANSLATIONS = {
      en: {
        // General
        accountingSystem: 'Accounting System v1.0',
        signIn: 'Sign In',
        email: 'Email',
        password: 'Password',
        logout: 'Logout',
        cancel: 'Cancel',
        save: 'Save',
        add: 'Add',
        edit: 'Edit',
        delete: 'Delete',
        actions: 'Actions',
        // Navigation
        overview: 'Overview',
        revenue: 'Revenue',
        expenses: 'Expenses',
        reports: 'Reports',
        settings: 'Settings',
        accounting: 'Accounting',
        // Dashboard
        totalRevenue: 'Total Revenue',
        totalExpenses: 'Total Expenses',
        netProfit: 'Net Profit',
        transactionCount: 'Transactions',
        thisMonth: 'This month',
        exchangeRates: 'Exchange Rates',
        lastUpdated: 'Last updated',
        refresh: 'Refresh',
        revenueVsExpenses: 'Revenue vs Expenses',
        expensesByCategory: 'Expenses by Category',
        recentTransactions: 'Recent Transactions',
        viewAll: 'View All ‚Üí',
        noTransactions: 'No transactions yet',
        // Revenue
        revenueManagement: 'Revenue Management',
        sportsRevenue: 'Sports Revenue',
        casinoRevenue: 'Casino Revenue',
        otherRevenue: 'Other Revenue',
        addRevenue: 'Add Revenue Entry',
        revenueHistory: 'Revenue History',
        noRevenue: 'No revenue entries yet',
        target: 'Target',
        reference: 'Reference',
        // Expenses
        expenseManagement: 'Expense Management',
        addExpense: 'Add Expense',
        saveExpense: 'Save Expense',
        bulkUpload: 'Bulk Upload',
        bulkUploadExpenses: 'Bulk Upload Expenses',
        template: 'Template',
        dragDropFile: 'Drag & drop or click to upload',
        import: 'Import',
        noExpenses: 'No expenses recorded yet',
        gamingOperations: 'Gaming Operations',
        shopOperating: 'Shop Operating',
        officeOperations: 'Office Operations',
        administrative: 'Administrative',
        budget: 'Budget',
        vendor: 'Vendor',
        receipt: 'Receipt',
        receiptNumber: 'Receipt Number',
        paymentMethod: 'Payment Method',
        allCategories: 'All Categories',
        filter: 'Filter',
        total: 'Total',
        // Reports
        financialReports: 'Financial Reports',
        generate: 'Generate',
        projectionMethod: 'Projection Method',
        historicalAverage: 'Historical Average',
        linearTrend: 'Linear Trend',
        manualTarget: 'Manual Target',
        monthlyTrend: 'Monthly Trend',
        profitLoss: 'Profit/Loss by Month',
        revenueBySource: 'Revenue by Source',
        currencyBreakdown: 'Currency Breakdown',
        projections: '30-Day Projections',
        exportCsv: 'Export CSV',
        print: 'Print',
        // Settings
        accountingSettings: 'Accounting Settings',
        accountInfo: 'Account Information',
        administrator: 'Administrator',
        expenseSubcategories: 'Expense Subcategories',
        noSubcategories: 'No subcategories defined',
        auditLog: 'Audit Log',
        timestamp: 'Timestamp',
        user: 'User',
        action: 'Action',
        details: 'Details',
        noAuditLogs: 'No audit logs yet',
        // Parameters
        editParameters: 'Edit Parameters',
        adjustThresholds: 'Adjust thresholds and targets',
        saveAndApply: 'Save & Apply',
        revenueTargets: 'Revenue Targets',
        expenseBudgets: 'Expense Budgets',
        // Common
        date: 'Date',
        type: 'Type',
        description: 'Description',
        category: 'Category',
        subcategory: 'Subcategory',
        amount: 'Amount',
        currency: 'Currency',
        fromDate: 'From Date',
        toDate: 'To Date'
      },
      ru: {
        // General
        accountingSystem: '–°–∏—Å—Ç–µ–º–∞ –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏–∏ v1.0',
        signIn: '–í–æ–π—Ç–∏',
        email: '–≠–ª. –ø–æ—á—Ç–∞',
        password: '–ü–∞—Ä–æ–ª—å',
        logout: '–í—ã–π—Ç–∏',
        cancel: '–û—Ç–º–µ–Ω–∞',
        save: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
        add: '–î–æ–±–∞–≤–∏—Ç—å',
        edit: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å',
        delete: '–£–¥–∞–ª–∏—Ç—å',
        actions: '–î–µ–π—Å—Ç–≤–∏—è',
        // Navigation
        overview: '–û–±–∑–æ—Ä',
        revenue: '–î–æ—Ö–æ–¥—ã',
        expenses: '–†–∞—Å—Ö–æ–¥—ã',
        reports: '–û—Ç—á—ë—Ç—ã',
        settings: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏',
        accounting: '–ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è',
        // Dashboard
        totalRevenue: '–û–±—â–∏–π –¥–æ—Ö–æ–¥',
        totalExpenses: '–û–±—â–∏–µ —Ä–∞—Å—Ö–æ–¥—ã',
        netProfit: '–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å',
        transactionCount: '–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏',
        thisMonth: '–≠—Ç–æ—Ç –º–µ—Å—è—Ü',
        exchangeRates: '–ö—É—Ä—Å—ã –≤–∞–ª—é—Ç',
        lastUpdated: '–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ',
        refresh: '–û–±–Ω–æ–≤–∏—Ç—å',
        revenueVsExpenses: '–î–æ—Ö–æ–¥—ã vs –†–∞—Å—Ö–æ–¥—ã',
        expensesByCategory: '–†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º',
        recentTransactions: '–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏',
        viewAll: '–°–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ ‚Üí',
        noTransactions: '–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–æ–∫–∞ –Ω–µ—Ç',
        // Revenue
        revenueManagement: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Ö–æ–¥–∞–º–∏',
        sportsRevenue: '–î–æ—Ö–æ–¥ –æ—Ç —Å–ø–æ—Ä—Ç–∞',
        casinoRevenue: '–î–æ—Ö–æ–¥ –æ—Ç –∫–∞–∑–∏–Ω–æ',
        otherRevenue: '–ü—Ä–æ—á–∏–µ –¥–æ—Ö–æ–¥—ã',
        addRevenue: '–î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥',
        revenueHistory: '–ò—Å—Ç–æ—Ä–∏—è –¥–æ—Ö–æ–¥–æ–≤',
        noRevenue: '–ó–∞–ø–∏—Å–µ–π –æ –¥–æ—Ö–æ–¥–∞—Ö –ø–æ–∫–∞ –Ω–µ—Ç',
        target: '–¶–µ–ª—å',
        reference: '–ù–æ–º–µ—Ä',
        // Expenses
        expenseManagement: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞–º–∏',
        addExpense: '–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥',
        saveExpense: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å—Ö–æ–¥',
        bulkUpload: '–ú–∞—Å—Å–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞',
        bulkUploadExpenses: '–ú–∞—Å—Å–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤',
        template: '–®–∞–±–ª–æ–Ω',
        dragDropFile: '–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏',
        import: '–ò–º–ø–æ—Ä—Ç',
        noExpenses: '–†–∞—Å—Ö–æ–¥–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç',
        gamingOperations: '–ò–≥—Ä–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏',
        shopOperating: '–û–ø–µ—Ä–∞—Ü–∏–∏ –º–∞–≥–∞–∑–∏–Ω–∞',
        officeOperations: '–û—Ñ–∏—Å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏',
        administrative: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ',
        budget: '–ë—é–¥–∂–µ—Ç',
        vendor: '–ü–æ—Å—Ç–∞–≤—â–∏–∫',
        receipt: '–ß–µ–∫',
        receiptNumber: '–ù–æ–º–µ—Ä —á–µ–∫–∞',
        paymentMethod: '–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã',
        allCategories: '–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏',
        filter: '–§–∏–ª—å—Ç—Ä',
        total: '–ò—Ç–æ–≥–æ',
        // Reports
        financialReports: '–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ—Ç—á—ë—Ç—ã',
        generate: '–°–æ–∑–¥–∞—Ç—å',
        projectionMethod: '–ú–µ—Ç–æ–¥ –ø—Ä–æ–≥–Ω–æ–∑–∞',
        historicalAverage: '–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π —Å—Ä–µ–¥–Ω–∏–π',
        linearTrend: '–õ–∏–Ω–µ–π–Ω—ã–π —Ç—Ä–µ–Ω–¥',
        manualTarget: '–†—É—á–Ω–∞—è —Ü–µ–ª—å',
        monthlyTrend: '–ú–µ—Å—è—á–Ω—ã–π —Ç—Ä–µ–Ω–¥',
        profitLoss: '–ü—Ä–∏–±—ã–ª—å/–£–±—ã—Ç–æ–∫ –ø–æ –º–µ—Å—è—Ü–∞–º',
        revenueBySource: '–î–æ—Ö–æ–¥—ã –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º',
        currencyBreakdown: '–†–∞–∑–±–∏–≤–∫–∞ –ø–æ –≤–∞–ª—é—Ç–∞–º',
        projections: '–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 30 –¥–Ω–µ–π',
        exportCsv: '–≠–∫—Å–ø–æ—Ä—Ç CSV',
        print: '–ü–µ—á–∞—Ç—å',
        // Settings
        accountingSettings: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏–∏',
        accountInfo: '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–∫–∫–∞—É–Ω—Ç–µ',
        administrator: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
        expenseSubcategories: '–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤',
        noSubcategories: '–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã',
        auditLog: '–ñ—É—Ä–Ω–∞–ª –∞—É–¥–∏—Ç–∞',
        timestamp: '–í—Ä–µ–º—è',
        user: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
        action: '–î–µ–π—Å—Ç–≤–∏–µ',
        details: '–î–µ—Ç–∞–ª–∏',
        noAuditLogs: '–ó–∞–ø–∏—Å–µ–π –∞—É–¥–∏—Ç–∞ –ø–æ–∫–∞ –Ω–µ—Ç',
        // Parameters
        editParameters: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã',
        adjustThresholds: '–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ü–µ–ª–µ–π –∏ –ø–æ—Ä–æ–≥–æ–≤',
        saveAndApply: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å',
        revenueTargets: '–¶–µ–ª–∏ –ø–æ –¥–æ—Ö–æ–¥–∞–º',
        expenseBudgets: '–ë—é–¥–∂–µ—Ç—ã —Ä–∞—Å—Ö–æ–¥–æ–≤',
        // Common
        date: '–î–∞—Ç–∞',
        type: '–¢–∏–ø',
        description: '–û–ø–∏—Å–∞–Ω–∏–µ',
        category: '–ö–∞—Ç–µ–≥–æ—Ä–∏—è',
        subcategory: '–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è',
        amount: '–°—É–º–º–∞',
        currency: '–í–∞–ª—é—Ç–∞',
        fromDate: '–° –¥–∞—Ç—ã',
        toDate: '–ü–æ –¥–∞—Ç—É'
      }
    };

    // ========== INITIALIZATION ==========
    document.addEventListener('DOMContentLoaded', async function() {
      App.db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      lucide.createIcons();
      loadParams();
      
      // Auth listener
      App.db.auth.onAuthStateChange((event, session) => {
        if (event === 'SIGNED_IN' && session) {
          App.user = session.user;
          showMainApp();
        } else if (event === 'SIGNED_OUT') {
          showLoginScreen();
        }
      });
      
      // Check existing session
      var { data: { session } } = await App.db.auth.getSession();
      if (session) {
        App.user = session.user;
        showMainApp();
      }
      
      // Login form
      document.getElementById('loginBtn').addEventListener('click', handleLogin);
      document.getElementById('loginPassword').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') handleLogin();
      });
      
      // Login language selector
      document.getElementById('loginLanguageSelect').addEventListener('change', function(e) {
        setLanguage(e.target.value);
      });
    });

    // ========== AUTH FUNCTIONS ==========
    async function handleLogin() {
      var email = document.getElementById('loginEmail').value;
      var password = document.getElementById('loginPassword').value;
      var btn = document.getElementById('loginBtn');
      var errorDiv = document.getElementById('loginError');
      
      btn.disabled = true;
      btn.innerHTML = '<svg class="spinner h-5 w-5" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg> ' + t('signIn') + '...';
      errorDiv.classList.add('hidden');
      
      try {
        var { data, error } = await App.db.auth.signInWithPassword({ email, password });
        if (error) throw error;
      } catch (e) {
        errorDiv.textContent = e.message;
        errorDiv.classList.remove('hidden');
        btn.disabled = false;
        btn.innerHTML = '<i data-lucide="log-in" class="h-5 w-5"></i> ' + t('signIn');
        lucide.createIcons();
      }
    }

    function showLoginScreen() {
      document.getElementById('loginScreen').classList.remove('hidden');
      document.getElementById('mainApp').classList.add('hidden');
    }

    function showMainApp() {
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');
      
      if (App.user) {
        document.getElementById('userEmail').textContent = App.user.email;
        document.getElementById('settingsUserEmail').textContent = App.user.email;
      }
      
      setupEventListeners();
      applyTranslations();
      loadData();
    }

    // ========== EVENT LISTENERS ==========
    function setupEventListeners() {
      // Logout
      document.getElementById('logoutBtn').addEventListener('click', () => App.db.auth.signOut());
      
      // Language selector
      document.getElementById('languageSelect').value = App.currentLang;
      document.getElementById('languageSelect').addEventListener('change', function(e) {
        setLanguage(e.target.value);
      });
      
      // Tab switching
      ['overview', 'revenue', 'expenses', 'reports', 'settings'].forEach(tab => {
        document.getElementById('tab-' + tab).addEventListener('click', () => switchTab(tab));
      });
      
      // Keyboard shortcuts
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeAddExpenseModal();
          closeBulkUploadModal();
          closeParamsModal();
        }
      });
      
      lucide.createIcons();
    }

    // ========== TAB SWITCHING ==========
    function switchTab(tabName) {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.classList.add('text-slate-300');
      });
      
      var activeBtn = document.getElementById('tab-' + tabName);
      if (activeBtn) activeBtn.classList.add('active');
      
      document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
      var activeContent = document.getElementById('content-' + tabName);
      if (activeContent) activeContent.classList.remove('hidden');
      
      lucide.createIcons();
    }

    // ========== LANGUAGE FUNCTIONS ==========
    function t(key) {
      return TRANSLATIONS[App.currentLang][key] || TRANSLATIONS['en'][key] || key;
    }

    function setLanguage(lang) {
      App.currentLang = lang;
      localStorage.setItem('bwanabet_acc_lang', lang);
      document.getElementById('languageSelect').value = lang;
      document.getElementById('loginLanguageSelect').value = lang;
      applyTranslations();
    }

    function applyTranslations() {
      document.querySelectorAll('[data-translate]').forEach(el => {
        var key = el.getAttribute('data-translate');
        var translation = t(key);
        if (translation) el.textContent = translation;
      });
    }

    // ========== DATA LOADING ==========
    async function loadData() {
      showLoading('Loading data...');
      
      await refreshExchangeRates();
      
      try {
        var { data: expenses } = await App.db.from('acc_expenses').select('*').order('date', { ascending: false });
        if (expenses) App.expenses = expenses;
        
        var { data: revenue } = await App.db.from('acc_revenue').select('*').order('date', { ascending: false });
        if (revenue) App.revenue = revenue;
        
        var { data: audit } = await App.db.from('acc_audit_log').select('*').order('timestamp', { ascending: false }).limit(50);
        if (audit) App.auditLog = audit;
      } catch (e) {
        console.log('Accounting tables not yet created:', e.message);
      }
      
      updateDashboard();
      updateRevenueDisplay();
      updateExpensesDisplay();
      updateAuditLog();
      hideLoading();
    }

    // ========== EXCHANGE RATES ==========
    async function refreshExchangeRates() {
      try {
        var response = await fetch('https://open.er-api.com/v6/latest/USD');
        var data = await response.json();
        if (data && data.rates) {
          App.exchangeRates = {
            USD: data.rates.ZMW || 27.5,
            EUR: (data.rates.ZMW || 27.5) / (data.rates.EUR || 0.92)
          };
          App.ratesLastUpdated = new Date();
        }
      } catch (e) {
        console.log('Could not fetch exchange rates:', e.message);
      }
      
      document.getElementById('rate-usd').textContent = App.exchangeRates.USD.toFixed(2);
      document.getElementById('rate-eur').textContent = App.exchangeRates.EUR.toFixed(2);
      document.getElementById('rates-updated').textContent = App.ratesLastUpdated ? App.ratesLastUpdated.toLocaleString() : 'Using cached rates';
    }

    function convertToBase(amount, currency) {
      if (currency === 'ZMW') return amount;
      return amount * App.exchangeRates[currency];
    }

    // ========== DASHBOARD ==========
    function updateDashboard() {
      var totalRevenue = App.revenue.reduce((sum, r) => sum + (parseFloat(r.amount_base) || parseFloat(r.amount) || 0), 0);
      var totalExpenses = App.expenses.reduce((sum, e) => sum + (parseFloat(e.amount_base) || parseFloat(e.amount) || 0), 0);
      var netProfit = totalRevenue - totalExpenses;
      var transactionCount = App.revenue.length + App.expenses.length;
      
      document.getElementById('total-revenue').textContent = 'K' + totalRevenue.toLocaleString();
      document.getElementById('total-expenses').textContent = 'K' + totalExpenses.toLocaleString();
      document.getElementById('net-profit').textContent = 'K' + netProfit.toLocaleString();
      document.getElementById('net-profit').className = 'text-2xl font-bold ' + (netProfit >= 0 ? 'text-blue-600' : 'text-red-600');
      document.getElementById('transaction-count').textContent = transactionCount;
      
      updateOverviewCharts();
      updateRecentTransactions();
    }

    function updateOverviewCharts() {
      // Revenue vs Expenses Chart
      var ctx1 = document.getElementById('revenueExpensesChart');
      if (ctx1) {
        if (App.charts['revExp']) App.charts['revExp'].destroy();
        
        var chartType = document.getElementById('chartTypeRevExp').value;
        var labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
        var revenueData = labels.map(() => Math.random() * 50000 + 20000);
        var expenseData = labels.map(() => Math.random() * 30000 + 10000);
        
        App.charts['revExp'] = new Chart(ctx1, {
          type: chartType,
          data: {
            labels: labels,
            datasets: [
              { label: t('revenue'), data: revenueData, borderColor: '#10B981', backgroundColor: chartType === 'line' ? 'rgba(16, 185, 129, 0.1)' : '#10B981', fill: chartType === 'line', tension: 0.4 },
              { label: t('expenses'), data: expenseData, borderColor: '#EF4444', backgroundColor: chartType === 'line' ? 'rgba(239, 68, 68, 0.1)' : '#EF4444', fill: chartType === 'line', tension: 0.4 }
            ]
          },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
      }
      
      // Category Pie Chart
      var ctx2 = document.getElementById('categoryPieChart');
      if (ctx2) {
        if (App.charts['catPie']) App.charts['catPie'].destroy();
        
        var chartType = document.getElementById('chartTypeCat').value;
        var catData = calculateExpensesByCategory();
        
        App.charts['catPie'] = new Chart(ctx2, {
          type: chartType,
          data: {
            labels: [t('gamingOperations'), t('shopOperating'), t('officeOperations'), t('administrative')],
            datasets: [{
              data: [catData.gaming || 1, catData.shop || 1, catData.office || 1, catData.admin || 1],
              backgroundColor: ['#8B5CF6', '#F59E0B', '#3B82F6', '#10B981']
            }]
          },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
      }
    }

    function calculateExpensesByCategory() {
      var result = { gaming: 0, shop: 0, office: 0, admin: 0 };
      App.expenses.forEach(e => {
        var amount = parseFloat(e.amount_base) || parseFloat(e.amount) || 0;
        if (e.category_id === 'gaming_operations') result.gaming += amount;
        else if (e.category_id === 'shop_operating') result.shop += amount;
        else if (e.category_id === 'office_operations') result.office += amount;
        else if (e.category_id === 'administrative') result.admin += amount;
      });
      return result;
    }

    function updateRecentTransactions() {
      var tbody = document.getElementById('recentTransactionsBody');
      var transactions = [];
      
      App.expenses.slice(0, 5).forEach(e => {
        transactions.push({
          date: e.date,
          type: 'expense',
          description: e.description || e.vendor || 'Expense',
          category: getCategoryName(e.category_id),
          amount: -(parseFloat(e.amount) || 0),
          currency: e.currency || 'ZMW'
        });
      });
      
      App.revenue.slice(0, 5).forEach(r => {
        transactions.push({
          date: r.date,
          type: 'revenue',
          description: r.description || r.type || 'Revenue',
          category: r.type || 'Revenue',
          amount: parseFloat(r.amount) || 0,
          currency: r.currency || 'ZMW'
        });
      });
      
      transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
      transactions = transactions.slice(0, 5);
      
      if (transactions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-slate-400">' + t('noTransactions') + '</td></tr>';
        return;
      }
      
      tbody.innerHTML = transactions.map(tx => {
        var amountClass = tx.amount >= 0 ? 'text-emerald-600' : 'text-red-600';
        var symbol = tx.currency === 'USD' ? '$' : (tx.currency === 'EUR' ? '‚Ç¨' : 'K');
        var amountStr = (tx.amount >= 0 ? '+' : '') + symbol + Math.abs(tx.amount).toLocaleString();
        var typeClass = tx.type === 'revenue' ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700';
        return '<tr class="border-b hover:bg-slate-50">' +
          '<td class="px-4 py-3 text-sm">' + (tx.date || '-') + '</td>' +
          '<td class="px-4 py-3"><span class="px-2 py-1 rounded-full text-xs font-medium ' + typeClass + '">' + tx.type + '</span></td>' +
          '<td class="px-4 py-3 text-sm">' + tx.description + '</td>' +
          '<td class="px-4 py-3 text-sm">' + tx.category + '</td>' +
          '<td class="px-4 py-3 text-sm text-right font-medium ' + amountClass + '">' + amountStr + '</td>' +
          '</tr>';
      }).join('');
    }

    function getCategoryName(key) {
      var names = {
        gaming_operations: t('gamingOperations'),
        shop_operating: t('shopOperating'),
        office_operations: t('officeOperations'),
        administrative: t('administrative')
      };
      return names[key] || key || '-';
    }

    // ========== REVENUE FUNCTIONS ==========
    function updateRevenueDisplay() {
      var sports = App.revenue.filter(r => r.type === 'sports').reduce((sum, r) => sum + (parseFloat(r.amount_base) || parseFloat(r.amount) || 0), 0);
      var casino = App.revenue.filter(r => r.type === 'casino').reduce((sum, r) => sum + (parseFloat(r.amount_base) || parseFloat(r.amount) || 0), 0);
      var other = App.revenue.filter(r => r.type !== 'sports' && r.type !== 'casino').reduce((sum, r) => sum + (parseFloat(r.amount_base) || parseFloat(r.amount) || 0), 0);
      
      document.getElementById('sports-revenue').textContent = 'K' + sports.toLocaleString();
      document.getElementById('casino-revenue').textContent = 'K' + casino.toLocaleString();
      document.getElementById('other-revenue').textContent = 'K' + other.toLocaleString();
      
      updateRevenueTable();
    }

    function updateRevenueTable() {
      var tbody = document.getElementById('revenueTableBody');
      
      if (App.revenue.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-slate-400">' + t('noRevenue') + '</td></tr>';
        return;
      }
      
      tbody.innerHTML = App.revenue.map(r => {
        var symbol = r.currency === 'USD' ? '$' : (r.currency === 'EUR' ? '‚Ç¨' : 'K');
        return '<tr class="border-b hover:bg-slate-50">' +
          '<td class="px-4 py-3 text-sm">' + (r.date || '-') + '</td>' +
          '<td class="px-4 py-3"><span class="px-2 py-1 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700">' + (r.type || '-') + '</span></td>' +
          '<td class="px-4 py-3 text-sm">' + (r.description || '-') + '</td>' +
          '<td class="px-4 py-3 text-sm">' + (r.reference_number || '-') + '</td>' +
          '<td class="px-4 py-3 text-sm text-right font-medium text-emerald-600">' + symbol + (parseFloat(r.amount) || 0).toLocaleString() + '</td>' +
          '<td class="px-4 py-3 text-center"><button onclick="deleteRevenue(\'' + r.id + '\')" class="text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="h-4 w-4"></i></button></td>' +
          '</tr>';
      }).join('');
      
      lucide.createIcons();
    }

    async function addRevenue() {
      var revenue = {
        date: document.getElementById('revDate').value || new Date().toISOString().split('T')[0],
        type: document.getElementById('revType').value,
        amount: parseFloat(document.getElementById('revAmount').value) || 0,
        currency: document.getElementById('revCurrency').value,
        description: document.getElementById('revDescription').value,
        reference_number: document.getElementById('revReference').value,
        created_by: App.user?.id
      };
      
      if (revenue.currency !== 'ZMW') {
        revenue.amount_base = convertToBase(revenue.amount, revenue.currency);
        revenue.exchange_rate = App.exchangeRates[revenue.currency];
      } else {
        revenue.amount_base = revenue.amount;
        revenue.exchange_rate = 1;
      }
      
      try {
        var { data, error } = await App.db.from('acc_revenue').insert([revenue]).select();
        if (error) throw error;
        
        App.revenue.unshift(data[0]);
        await logAudit('revenue_created', 'revenue', data[0].id, null, revenue);
        
        document.getElementById('revAmount').value = '';
        document.getElementById('revDescription').value = '';
        document.getElementById('revReference').value = '';
        
        updateDashboard();
        updateRevenueDisplay();
        showNotification(t('addRevenue') + ' ‚úì', 'success');
      } catch (e) {
        console.error('Error saving revenue:', e);
        showNotification('Error: ' + e.message, 'error');
      }
    }

    async function deleteRevenue(id) {
      if (!confirm('Delete this revenue entry?')) return;
      
      try {
        var { error } = await App.db.from('acc_revenue').delete().eq('id', id);
        if (error) throw error;
        
        App.revenue = App.revenue.filter(r => r.id !== id);
        await logAudit('revenue_deleted', 'revenue', id, null, null);
        
        updateDashboard();
        updateRevenueDisplay();
        showNotification('Revenue deleted', 'success');
      } catch (e) {
        showNotification('Error: ' + e.message, 'error');
      }
    }

    // ========== EXPENSE FUNCTIONS ==========
    function updateExpensesDisplay() {
      var catData = calculateExpensesByCategory();
      
      document.getElementById('exp-gaming').textContent = 'K' + catData.gaming.toLocaleString();
      document.getElementById('exp-shop').textContent = 'K' + catData.shop.toLocaleString();
      document.getElementById('exp-office').textContent = 'K' + catData.office.toLocaleString();
      document.getElementById('exp-admin').textContent = 'K' + catData.admin.toLocaleString();
      
      updateExpensesTable();
    }

    function updateExpensesTable() {
      var tbody = document.getElementById('expensesTableBody');
      var total = 0;
      
      if (App.expenses.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-slate-400">' + t('noExpenses') + '</td></tr>';
        document.getElementById('expensesCount').textContent = '0 ' + t('expenses');
        document.getElementById('expensesTotal').textContent = 'K0';
        return;
      }
      
      tbody.innerHTML = App.expenses.map(e => {
        var amount = parseFloat(e.amount) || 0;
        total += parseFloat(e.amount_base) || amount;
        var symbol = e.currency === 'USD' ? '$' : (e.currency === 'EUR' ? '‚Ç¨' : 'K');
        var catColors = {
          gaming_operations: 'bg-purple-100 text-purple-700',
          shop_operating: 'bg-amber-100 text-amber-700',
          office_operations: 'bg-blue-100 text-blue-700',
          administrative: 'bg-emerald-100 text-emerald-700'
        };
        
        return '<tr class="border-b hover:bg-slate-50">' +
          '<td class="px-4 py-3 text-sm">' + (e.date || '-') + '</td>' +
          '<td class="px-4 py-3"><span class="px-2 py-1 rounded-full text-xs font-medium ' + (catColors[e.category_id] || 'bg-slate-100') + '">' + getCategoryName(e.category_id) + '</span></td>' +
          '<td class="px-4 py-3 text-sm">' + (e.vendor || '-') + '</td>' +
          '<td class="px-4 py-3 text-sm">' + (e.description || '-') + '</td>' +
          '<td class="px-4 py-3 text-sm text-right font-medium text-red-600">' + symbol + amount.toLocaleString() + '</td>' +
          '<td class="px-4 py-3 text-center">' + (e.receipt_number ? '<span class="text-slate-500">' + e.receipt_number + '</span>' : '-') + '</td>' +
          '<td class="px-4 py-3 text-center"><button onclick="deleteExpense(\'' + e.id + '\')" class="text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="h-4 w-4"></i></button></td>' +
          '</tr>';
      }).join('');
      
      document.getElementById('expensesCount').textContent = App.expenses.length + ' ' + t('expenses');
      document.getElementById('expensesTotal').textContent = 'K' + total.toLocaleString();
      
      lucide.createIcons();
    }

    function showAddExpenseModal() {
      document.getElementById('expDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('addExpenseModal').classList.remove('hidden');
      lucide.createIcons();
    }

    function closeAddExpenseModal() {
      document.getElementById('addExpenseModal').classList.add('hidden');
    }

    function loadSubcategoriesDropdown() {
      var category = document.getElementById('expCategory').value;
      var subcatSelect = document.getElementById('expSubcategory');
      var subcats = App.expenseCategories[category]?.subcategories || [];
      
      subcatSelect.innerHTML = '<option value="">Select subcategory...</option>';
      subcats.forEach(s => {
        subcatSelect.innerHTML += '<option value="' + s.id + '">' + s.name + '</option>';
      });
    }

    async function saveExpense() {
      var expense = {
        date: document.getElementById('expDate').value,
        category_id: document.getElementById('expCategory').value,
        subcategory_id: document.getElementById('expSubcategory').value || null,
        amount: parseFloat(document.getElementById('expAmount').value) || 0,
        currency: document.getElementById('expCurrency').value,
        vendor: document.getElementById('expVendor').value,
        description: document.getElementById('expDescription').value,
        receipt_number: document.getElementById('expReceiptNum').value,
        payment_method: document.getElementById('expPaymentMethod').value,
        created_by: App.user?.id
      };
      
      if (expense.currency !== 'ZMW') {
        expense.amount_base = convertToBase(expense.amount, expense.currency);
        expense.exchange_rate = App.exchangeRates[expense.currency];
      } else {
        expense.amount_base = expense.amount;
        expense.exchange_rate = 1;
      }
      
      try {
        var { data, error } = await App.db.from('acc_expenses').insert([expense]).select();
        if (error) throw error;
        
        App.expenses.unshift(data[0]);
        await logAudit('expense_created', 'expense', data[0].id, null, expense);
        
        closeAddExpenseModal();
        updateDashboard();
        updateExpensesDisplay();
        showNotification(t('saveExpense') + ' ‚úì', 'success');
      } catch (e) {
        console.error('Error saving expense:', e);
        showNotification('Error: ' + e.message, 'error');
      }
    }

    async function deleteExpense(id) {
      if (!confirm('Delete this expense?')) return;
      
      try {
        var { error } = await App.db.from('acc_expenses').delete().eq('id', id);
        if (error) throw error;
        
        App.expenses = App.expenses.filter(e => e.id !== id);
        await logAudit('expense_deleted', 'expense', id, null, null);
        
        updateDashboard();
        updateExpensesDisplay();
        showNotification('Expense deleted', 'success');
      } catch (e) {
        showNotification('Error: ' + e.message, 'error');
      }
    }

    function filterExpenses() {
      // TODO: Implement filtering
      showNotification('Filter applied', 'success');
    }

    function clearExpenseFilters() {
      document.getElementById('expFilterFrom').value = '';
      document.getElementById('expFilterTo').value = '';
      document.getElementById('expFilterCategory').value = '';
      document.getElementById('expFilterCurrency').value = '';
    }

    // ========== BULK UPLOAD ==========
    function showBulkUploadModal() {
      document.getElementById('bulkUploadModal').classList.remove('hidden');
      lucide.createIcons();
    }

    function closeBulkUploadModal() {
      document.getElementById('bulkUploadModal').classList.add('hidden');
      document.getElementById('bulkUploadPreview').classList.add('hidden');
      document.getElementById('bulkUploadPreview').innerHTML = '';
      document.getElementById('confirmBulkUploadBtn').disabled = true;
    }

    function handleBulkUpload(file) {
      var reader = new FileReader();
      reader.onload = function(e) {
        var content = e.target.result;
        var lines = content.split('\n').slice(0, 6);
        
        var preview = '<table class="w-full text-xs"><thead class="bg-slate-100"><tr>';
        var headers = lines[0].split(',');
        headers.forEach(h => preview += '<th class="px-2 py-1 text-left">' + h.trim() + '</th>');
        preview += '</tr></thead><tbody>';
        
        lines.slice(1).forEach(line => {
          if (line.trim()) {
            preview += '<tr>';
            line.split(',').forEach(cell => preview += '<td class="px-2 py-1 border-t">' + cell.trim() + '</td>');
            preview += '</tr>';
          }
        });
        preview += '</tbody></table>';
        
        document.getElementById('bulkUploadPreview').innerHTML = preview;
        document.getElementById('bulkUploadPreview').classList.remove('hidden');
        document.getElementById('confirmBulkUploadBtn').disabled = false;
      };
      reader.readAsText(file);
    }

    function confirmBulkUpload() {
      showNotification('Bulk upload feature coming soon', 'success');
      closeBulkUploadModal();
    }

    function downloadExpenseTemplate() {
      var csv = 'Date,Category,Subcategory,Amount,Currency,Vendor,Description,Receipt Number,Payment Method\n';
      csv += '2026-01-15,gaming_operations,,5000,ZMW,Vendor Name,Description here,REC-001,cash\n';
      csv += '2026-01-16,shop_operating,,2500,USD,Another Vendor,Another expense,REC-002,bank_transfer\n';
      
      var blob = new Blob([csv], { type: 'text/csv' });
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = 'expense_template.csv';
      a.click();
    }

    // ========== REPORTS ==========
    function generateReports() {
      updateReportCharts();
      showNotification(t('financialReports') + ' ‚úì', 'success');
    }

    function updateReportCharts() {
      var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
      
      // Trend Chart
      var ctx1 = document.getElementById('reportTrendChart');
      if (ctx1) {
        if (App.charts['trend']) App.charts['trend'].destroy();
        App.charts['trend'] = new Chart(ctx1, {
          type: 'line',
          data: {
            labels: months,
            datasets: [
              { label: t('revenue'), data: months.map(() => Math.random() * 50000 + 20000), borderColor: '#10B981', tension: 0.4 },
              { label: t('expenses'), data: months.map(() => Math.random() * 30000 + 10000), borderColor: '#EF4444', tension: 0.4 }
            ]
          },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
      }
      
      // Profit Chart
      var ctx2 = document.getElementById('reportProfitChart');
      if (ctx2) {
        if (App.charts['profit']) App.charts['profit'].destroy();
        var profitData = months.map(() => Math.random() * 30000 - 10000);
        App.charts['profit'] = new Chart(ctx2, {
          type: 'bar',
          data: {
            labels: months,
            datasets: [{
              label: t('profitLoss'),
              data: profitData,
              backgroundColor: profitData.map(v => v >= 0 ? '#10B981' : '#EF4444')
            }]
          },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
      }
      
      // Revenue Source Chart
      var ctx3 = document.getElementById('reportRevenueSourceChart');
      if (ctx3) {
        if (App.charts['source']) App.charts['source'].destroy();
        App.charts['source'] = new Chart(ctx3, {
          type: 'doughnut',
          data: {
            labels: [t('sportsRevenue'), t('casinoRevenue'), t('otherRevenue')],
            datasets: [{ data: [55, 35, 10], backgroundColor: ['#10B981', '#8B5CF6', '#3B82F6'] }]
          },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
      }
      
      // Currency Chart
      var ctx4 = document.getElementById('reportCurrencyChart');
      if (ctx4) {
        if (App.charts['currency']) App.charts['currency'].destroy();
        App.charts['currency'] = new Chart(ctx4, {
          type: 'doughnut',
          data: {
            labels: ['ZMW', 'USD', 'EUR'],
            datasets: [{ data: [70, 20, 10], backgroundColor: ['#FDF104', '#3B82F6', '#10B981'] }]
          },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
      }
      
      // Projection Chart
      var ctx5 = document.getElementById('reportProjectionChart');
      if (ctx5) {
        if (App.charts['projection']) App.charts['projection'].destroy();
        var days = Array.from({length: 30}, (_, i) => 'Day ' + (i + 1));
        App.charts['projection'] = new Chart(ctx5, {
          type: 'line',
          data: {
            labels: days,
            datasets: [
              { label: t('revenue') + ' (Projected)', data: days.map(() => Math.random() * 5000 + 2000), borderColor: '#10B981', borderDash: [5, 5], tension: 0.4 },
              { label: t('expenses') + ' (Projected)', data: days.map(() => Math.random() * 3000 + 1000), borderColor: '#EF4444', borderDash: [5, 5], tension: 0.4 }
            ]
          },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
      }
      
      lucide.createIcons();
    }

    function exportReportCSV() {
      var csv = 'Date,Type,Category,Description,Amount,Currency\n';
      
      App.revenue.forEach(r => {
        csv += [r.date, 'Revenue', r.type, r.description || '', r.amount, r.currency].join(',') + '\n';
      });
      
      App.expenses.forEach(e => {
        csv += [e.date, 'Expense', e.category_id, e.description || '', e.amount, e.currency].join(',') + '\n';
      });
      
      var blob = new Blob([csv], { type: 'text/csv' });
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = 'financial_report_' + new Date().toISOString().split('T')[0] + '.csv';
      a.click();
      
      showNotification(t('exportCsv') + ' ‚úì', 'success');
    }

    function printReport() {
      window.print();
    }

    // ========== SETTINGS & SUBCATEGORIES ==========
    function addSubcategory(categoryKey) {
      var name = prompt('Enter subcategory name:');
      if (name) {
        App.expenseCategories[categoryKey].subcategories.push({ id: Date.now().toString(), name: name });
        saveSubcategories();
        updateSubcategoryDisplay(categoryKey);
        showNotification('Subcategory added', 'success');
      }
    }

    function updateSubcategoryDisplay(categoryKey) {
      var container = document.getElementById('subcats-' + categoryKey);
      if (!container) return;
      
      var subcats = App.expenseCategories[categoryKey].subcategories;
      if (subcats.length === 0) {
        container.innerHTML = '<p class="text-slate-400">' + t('noSubcategories') + '</p>';
      } else {
        container.innerHTML = subcats.map(s => 
          '<div class="flex items-center justify-between p-2 bg-slate-50 rounded">' +
          '<span>' + s.name + '</span>' +
          '<button onclick="deleteSubcategory(\'' + categoryKey + '\', \'' + s.id + '\')" class="text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="h-3 w-3"></i></button>' +
          '</div>'
        ).join('');
        lucide.createIcons();
      }
    }

    function deleteSubcategory(categoryKey, subcatId) {
      App.expenseCategories[categoryKey].subcategories = App.expenseCategories[categoryKey].subcategories.filter(s => s.id !== subcatId);
      saveSubcategories();
      updateSubcategoryDisplay(categoryKey);
    }

    function saveSubcategories() {
      localStorage.setItem('bwanabet_acc_subcats', JSON.stringify(App.expenseCategories));
    }

    function loadSubcategories() {
      var saved = localStorage.getItem('bwanabet_acc_subcats');
      if (saved) {
        try {
          App.expenseCategories = JSON.parse(saved);
        } catch (e) {}
      }
      
      Object.keys(App.expenseCategories).forEach(key => {
        updateSubcategoryDisplay(key);
      });
    }

    // ========== AUDIT LOG ==========
    async function logAudit(action, entityType, entityId, oldValues, newValues) {
      try {
        await App.db.from('acc_audit_log').insert([{
          user_id: App.user?.id,
          user_email: App.user?.email,
          action: action,
          entity_type: entityType,
          entity_id: entityId,
          old_values: oldValues,
          new_values: newValues
        }]);
      } catch (e) {
        console.log('Could not log audit:', e.message);
      }
    }

    function updateAuditLog() {
      var tbody = document.getElementById('auditLogBody');
      
      if (App.auditLog.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-slate-400">' + t('noAuditLogs') + '</td></tr>';
        return;
      }
      
      tbody.innerHTML = App.auditLog.map(log => {
        return '<tr class="border-b">' +
          '<td class="px-4 py-3 text-sm">' + new Date(log.timestamp).toLocaleString() + '</td>' +
          '<td class="px-4 py-3 text-sm">' + (log.user_email || '-') + '</td>' +
          '<td class="px-4 py-3"><span class="px-2 py-1 rounded text-xs bg-slate-100">' + log.action + '</span></td>' +
          '<td class="px-4 py-3 text-sm text-slate-500">' + log.entity_type + ' ' + (log.entity_id ? log.entity_id.substring(0, 8) + '...' : '') + '</td>' +
          '</tr>';
      }).join('');
    }

    // ========== PARAMETERS ==========
    function loadParams() {
      var saved = localStorage.getItem('bwanabet_acc_params');
      if (saved) {
        try {
          App.params = { ...App.params, ...JSON.parse(saved) };
        } catch (e) {}
      }
      updateParamDisplays();
      loadSubcategories();
    }

    function saveParamsToStorage() {
      localStorage.setItem('bwanabet_acc_params', JSON.stringify(App.params));
    }

    function updateParamDisplays() {
      var displays = {
        'paramSportsTarget': App.params.sportsTarget.toLocaleString(),
        'paramCasinoTarget': App.params.casinoTarget.toLocaleString(),
        'paramOtherTarget': App.params.otherTarget.toLocaleString(),
        'paramGamingBudget': App.params.gamingBudget.toLocaleString(),
        'paramShopBudget': App.params.shopBudget.toLocaleString(),
        'paramOfficeBudget': App.params.officeBudget.toLocaleString(),
        'paramAdminBudget': App.params.adminBudget.toLocaleString()
      };
      
      Object.keys(displays).forEach(id => {
        var el = document.getElementById(id);
        if (el) el.textContent = displays[id];
      });
    }

    function openParamsModal(tab) {
      App.currentParamsTab = tab;
      var content = '';
      
      if (tab === 'revenue') {
        content = '<h4 class="font-medium text-slate-800 mb-4">' + t('revenueTargets') + '</h4>' +
          '<div class="space-y-4">' +
          '<div><label class="block text-sm font-medium text-slate-700 mb-1">' + t('sportsRevenue') + ' ' + t('target') + '</label>' +
          '<input type="number" id="paramInputSportsTarget" value="' + App.params.sportsTarget + '" class="w-full px-3 py-2 border rounded-lg"></div>' +
          '<div><label class="block text-sm font-medium text-slate-700 mb-1">' + t('casinoRevenue') + ' ' + t('target') + '</label>' +
          '<input type="number" id="paramInputCasinoTarget" value="' + App.params.casinoTarget + '" class="w-full px-3 py-2 border rounded-lg"></div>' +
          '<div><label class="block text-sm font-medium text-slate-700 mb-1">' + t('otherRevenue') + ' ' + t('target') + '</label>' +
          '<input type="number" id="paramInputOtherTarget" value="' + App.params.otherTarget + '" class="w-full px-3 py-2 border rounded-lg"></div>' +
          '</div>';
      } else if (tab === 'expenses') {
        content = '<h4 class="font-medium text-slate-800 mb-4">' + t('expenseBudgets') + '</h4>' +
          '<div class="space-y-4">' +
          '<div><label class="block text-sm font-medium text-slate-700 mb-1">' + t('gamingOperations') + ' ' + t('budget') + '</label>' +
          '<input type="number" id="paramInputGamingBudget" value="' + App.params.gamingBudget + '" class="w-full px-3 py-2 border rounded-lg"></div>' +
          '<div><label class="block text-sm font-medium text-slate-700 mb-1">' + t('shopOperating') + ' ' + t('budget') + '</label>' +
          '<input type="number" id="paramInputShopBudget" value="' + App.params.shopBudget + '" class="w-full px-3 py-2 border rounded-lg"></div>' +
          '<div><label class="block text-sm font-medium text-slate-700 mb-1">' + t('officeOperations') + ' ' + t('budget') + '</label>' +
          '<input type="number" id="paramInputOfficeBudget" value="' + App.params.officeBudget + '" class="w-full px-3 py-2 border rounded-lg"></div>' +
          '<div><label class="block text-sm font-medium text-slate-700 mb-1">' + t('administrative') + ' ' + t('budget') + '</label>' +
          '<input type="number" id="paramInputAdminBudget" value="' + App.params.adminBudget + '" class="w-full px-3 py-2 border rounded-lg"></div>' +
          '</div>';
      } else {
        content = '<p class="text-slate-500">No parameters to edit for this section.</p>';
      }
      
      document.getElementById('paramsModalContent').innerHTML = content;
      document.getElementById('paramsModal').classList.remove('hidden');
      lucide.createIcons();
    }

    function closeParamsModal() {
      document.getElementById('paramsModal').classList.add('hidden');
    }

    function saveParams() {
      if (App.currentParamsTab === 'revenue') {
        App.params.sportsTarget = parseInt(document.getElementById('paramInputSportsTarget').value) || 0;
        App.params.casinoTarget = parseInt(document.getElementById('paramInputCasinoTarget').value) || 0;
        App.params.otherTarget = parseInt(document.getElementById('paramInputOtherTarget').value) || 0;
      } else if (App.currentParamsTab === 'expenses') {
        App.params.gamingBudget = parseInt(document.getElementById('paramInputGamingBudget').value) || 0;
        App.params.shopBudget = parseInt(document.getElementById('paramInputShopBudget').value) || 0;
        App.params.officeBudget = parseInt(document.getElementById('paramInputOfficeBudget').value) || 0;
        App.params.adminBudget = parseInt(document.getElementById('paramInputAdminBudget').value) || 0;
      }
      
      saveParamsToStorage();
      updateParamDisplays();
      closeParamsModal();
      showNotification(t('saveAndApply') + ' ‚úì', 'success');
    }

    // ========== UI HELPERS ==========
    function showLoading(text) {
      document.getElementById('loadingText').textContent = text || 'Loading...';
      document.getElementById('loadingOverlay').classList.remove('hidden');
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').classList.add('hidden');
    }

    function showNotification(message, type) {
      var notif = document.getElementById('notification');
      notif.className = 'fixed top-4 right-4 left-4 sm:left-auto z-50 px-4 py-3 rounded-lg shadow-xl flex items-center gap-3 notification ' +
        (type === 'success' ? 'bg-emerald-500 text-white' : 'bg-red-500 text-white');
      notif.innerHTML = '<i data-lucide="' + (type === 'success' ? 'check-circle' : 'alert-circle') + '" class="h-5 w-5"></i>' + message;
      notif.classList.remove('hidden');
      lucide.createIcons();
      
      setTimeout(() => notif.classList.add('hidden'), 3000);
    }
  </script>
</body>
</html>
