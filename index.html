<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BwanaBet Accounting System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    @keyframes spin { to { transform: rotate(360deg); } }
    .spinner { animation: spin 1s linear infinite; }
    .tab-btn.active { background: #FDF104; color: #000; }
    .exp-cat-tab.active { border-color: #FDF104 !important; color: #CA8A04 !important; background: #FEFCE8; }
    .notification { animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    
    /* Yellow Theme Overrides */
    .text-yellow-400 { color: #FDF104 !important; }
    .bg-yellow-400 { background-color: #FDF104 !important; }
    .bg-yellow-500 { background-color: #FDF104 !important; }
    .border-yellow-400 { border-color: #FDF104 !important; }
    .border-yellow-500 { border-color: #FDF104 !important; }
    .hover\:bg-yellow-400:hover { background-color: #E6DA00 !important; }
    .hover\:bg-yellow-500:hover { background-color: #E6DA00 !important; }
    .ring-yellow-400 { --tw-ring-color: #FDF104 !important; }
    .focus\:ring-yellow-400:focus { --tw-ring-color: #FDF104 !important; }
    
    /* Import Modal Styles */
    .import-tab { transition: all 0.2s; }
    .import-tab.active { background: #FDF104; color: #000; }
    .import-tab:not(.active) { background: #f1f5f9; color: #64748b; }
    .import-tab:not(.active):hover { background: #e2e8f0; }
    .drop-zone {
      border: 2px dashed #cbd5e1;
      border-radius: 12px;
      padding: 40px 20px;
      text-align: center;
      transition: all 0.3s;
      cursor: pointer;
    }
    .drop-zone:hover, .drop-zone.dragover {
      border-color: #FDF104;
      background: #fefce8;
    }
    .drop-zone.dragover {
      transform: scale(1.02);
    }
    .receipt-preview {
      max-height: 200px;
      object-fit: contain;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }
    .receipt-card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      overflow: hidden;
      transition: all 0.2s;
    }
    .receipt-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .receipt-card.processing {
      opacity: 0.7;
    }
    .receipt-card.error {
      border-color: #ef4444;
      background: #fef2f2;
    }
    .receipt-card.success {
      border-color: #22c55e;
      background: #f0fdf4;
    }
    .scan-progress {
      height: 4px;
      background: #e2e8f0;
      border-radius: 2px;
      overflow: hidden;
    }
    .scan-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #FDF104, #CA8A04);
      transition: width 0.3s;
    }
    .editable-field {
      background: #fefce8;
      border: 1px solid #fde047;
      border-radius: 6px;
      padding: 8px 12px;
      transition: all 0.2s;
    }
    .editable-field:focus {
      outline: none;
      border-color: #FDF104;
      box-shadow: 0 0 0 3px rgba(253, 241, 4, 0.2);
    }
    
    /* Receipts Gallery Styles */
    .receipt-gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }
    .receipt-gallery-card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      overflow: hidden;
      transition: all 0.2s;
      cursor: pointer;
    }
    .receipt-gallery-card:hover {
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }
    .receipt-gallery-card img {
      width: 100%;
      height: 160px;
      object-fit: cover;
      border-bottom: 1px solid #e2e8f0;
    }
    .receipt-lightbox {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .receipt-lightbox img {
      max-width: 90%;
      max-height: 80vh;
      border-radius: 8px;
      box-shadow: 0 10px 50px rgba(0,0,0,0.5);
    }
    .receipt-lightbox-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: white;
      border: none;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .receipt-filter-btn {
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
      border: 1px solid #e2e8f0;
      background: white;
    }
    .receipt-filter-btn.active {
      background: #FDF104;
      border-color: #FDF104;
      color: #000;
    }
    .receipt-filter-btn:not(.active):hover {
      background: #f1f5f9;
    }
    
    /* AI Agent Widget Styles */
    .ai-widget-btn {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #FDF104 0%, #CA8A04 100%);
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(253, 241, 4, 0.4);
      z-index: 1000;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .ai-widget-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 30px rgba(253, 241, 4, 0.5);
    }
    .ai-widget-btn svg { width: 28px; height: 28px; color: #000; }
    .ai-widget-btn .notification-dot {
      position: absolute;
      top: 0;
      right: 0;
      width: 16px;
      height: 16px;
      background: #ef4444;
      border-radius: 50%;
      border: 2px solid white;
      animation: aiPulse 2s infinite;
    }
    @keyframes aiPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
    
    .ai-chat-panel {
      position: fixed;
      bottom: 100px;
      right: 24px;
      width: 400px;
      max-width: calc(100vw - 48px);
      height: 550px;
      max-height: calc(100vh - 150px);
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 50px rgba(0, 0, 0, 0.2);
      z-index: 999;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: all 0.3s ease;
      opacity: 0;
      transform: translateY(20px) scale(0.95);
      pointer-events: none;
    }
    .ai-chat-panel.open {
      opacity: 1;
      transform: translateY(0) scale(1);
      pointer-events: all;
    }
    .ai-chat-header {
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 3px solid #FDF104;
    }
    .ai-chat-header h3 {
      color: #FDF104;
      font-weight: 700;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .ai-chat-header .close-btn {
      background: transparent;
      border: none;
      color: #94a3b8;
      cursor: pointer;
      padding: 4px;
      border-radius: 6px;
      transition: all 0.2s;
    }
    .ai-chat-header .close-btn:hover { background: #334155; color: white; }
    .ai-chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: #f8fafc;
    }
    .ai-chat-messages::-webkit-scrollbar { width: 6px; }
    .ai-chat-messages::-webkit-scrollbar-track { background: transparent; }
    .ai-chat-messages::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .chat-message {
      max-width: 85%;
      padding: 12px 16px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.5;
      animation: msgSlide 0.3s ease;
    }
    @keyframes msgSlide { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .chat-message.user {
      align-self: flex-end;
      background: linear-gradient(135deg, #FDF104 0%, #CA8A04 100%);
      color: #000;
      border-bottom-right-radius: 4px;
    }
    .chat-message.assistant {
      align-self: flex-start;
      background: white;
      color: #1e293b;
      border: 1px solid #e2e8f0;
      border-bottom-left-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .chat-message.assistant pre {
      background: #1e293b;
      color: #f8fafc;
      padding: 8px 12px;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 12px;
      margin: 8px 0;
    }
    .chat-message.assistant code {
      background: #e2e8f0;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 13px;
    }
    .chat-message.system {
      align-self: center;
      background: #fef3c7;
      color: #92400e;
      font-size: 12px;
      padding: 8px 16px;
    }
    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 12px 16px;
      background: white;
      border-radius: 16px;
      border: 1px solid #e2e8f0;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }
    .typing-indicator span {
      width: 8px;
      height: 8px;
      background: #94a3b8;
      border-radius: 50%;
      animation: typingBounce 1.4s infinite;
    }
    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typingBounce { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-8px); } }
    .ai-chat-input-area {
      padding: 16px;
      background: white;
      border-top: 1px solid #e2e8f0;
    }
    .ai-chat-input-container {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }
    .ai-chat-input {
      flex: 1;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 12px 16px;
      font-size: 14px;
      resize: none;
      min-height: 44px;
      max-height: 120px;
      outline: none;
      transition: border-color 0.2s;
    }
    .ai-chat-input:focus { border-color: #FDF104; }
    .ai-chat-input::placeholder { color: #94a3b8; }
    .ai-send-btn {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: linear-gradient(135deg, #FDF104 0%, #CA8A04 100%);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    .ai-send-btn:hover { transform: scale(1.05); }
    .ai-send-btn:disabled { background: #e2e8f0; cursor: not-allowed; transform: none; }
    .ai-send-btn svg { width: 20px; height: 20px; color: #000; }
    .quick-actions {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .quick-action-btn {
      padding: 6px 12px;
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      border-radius: 20px;
      font-size: 12px;
      color: #475569;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .quick-action-btn:hover {
      background: #fef9c3;
      border-color: #FDF104;
      color: #713f12;
    }
    @media (max-width: 480px) {
      .ai-chat-panel {
        right: 12px;
        left: 12px;
        width: auto;
        bottom: 90px;
        height: calc(100vh - 120px);
      }
      .ai-widget-btn { right: 16px; bottom: 16px; width: 56px; height: 56px; }
    }
  </style>
</head>
<body class="bg-slate-100 min-h-screen">
  <!-- LOGIN SCREEN -->
  <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-900 to-slate-800 p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
      <div class="bg-black p-6 text-center border-b-4 border-yellow-400">
        <h1 class="text-yellow-400 font-extrabold text-3xl tracking-tight">BWANABET</h1>
        <p class="text-slate-400 text-sm mt-1" data-translate="accountingSystem">Accounting System v1.0</p>
      </div>
      <div class="p-6 sm:p-8">
        <div class="flex justify-center mb-6">
          <select id="loginLanguageSelect" class="px-3 py-1.5 bg-slate-100 text-slate-700 rounded-lg text-sm border cursor-pointer">
            <option value="en">üá¨üáß English</option>
            <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
          </select>
        </div>
        <h2 class="text-xl font-bold text-slate-800 mb-6 text-center" data-translate="signIn">Sign In</h2>
        <div id="loginError" class="hidden mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm"></div>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="email">Email</label>
            <input type="email" id="loginEmail" placeholder="you@example.com" class="w-full px-4 py-3 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-yellow-400 focus:border-transparent"/>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="password">Password</label>
            <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full px-4 py-3 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-yellow-400 focus:border-transparent"/>
          </div>
          <button id="loginBtn" class="w-full py-3 bg-yellow-500 text-black font-bold rounded-lg hover:bg-yellow-400 flex items-center justify-center gap-2">
            <i data-lucide="log-in" class="h-5 w-5"></i>
            <span data-translate="signIn">Sign In</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN APPLICATION -->
  <div id="mainApp" class="hidden">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black/30 flex items-center justify-center z-[100]">
      <div class="bg-white rounded-xl p-6 flex items-center gap-4 shadow-2xl">
        <svg class="spinner h-8 w-8 text-yellow-500" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
        </svg>
        <span class="text-lg font-medium text-slate-700" id="loadingText">Loading...</span>
      </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="hidden fixed top-4 right-4 left-4 sm:left-auto z-50 px-4 py-3 rounded-lg shadow-xl flex items-center gap-3 notification"></div>

    <!-- Header -->
    <header class="bg-black shadow-md border-b-4 border-yellow-400">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 py-3">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3 sm:gap-6">
            <div class="text-yellow-400 font-extrabold text-xl sm:text-2xl tracking-tight">BWANABET</div>
            <div class="hidden sm:block border-l-2 border-slate-600 pl-4">
              <h1 class="text-lg font-bold text-white" data-translate="accounting">Accounting</h1>
            </div>
          </div>
          <div class="flex items-center gap-2 sm:gap-4">
            <select id="languageSelect" class="px-2 py-1.5 bg-slate-700 text-slate-300 rounded-lg text-sm border-none cursor-pointer hover:bg-slate-600">
              <option value="en">üá¨üáß English</option>
              <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
            </select>
            <!-- Display Currency Selector -->
            <div class="flex items-center gap-1 px-2 py-1 bg-yellow-500 rounded-lg">
              <i data-lucide="coins" class="h-4 w-4 text-black"></i>
              <select id="displayCurrencySelect" class="bg-yellow-500 text-black text-sm font-medium border-none cursor-pointer focus:outline-none">
                <option value="ZMW">K (ZMW)</option>
                <option value="USD">$ (USD)</option>
                <option value="EUR">‚Ç¨ (EUR)</option>
              </select>
            </div>
            <span id="userEmail" class="text-xs text-slate-400 hidden sm:inline truncate max-w-[120px]"></span>
            <button id="logoutBtn" class="flex items-center gap-1 px-2 sm:px-3 py-1.5 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-lg text-sm">
              <i data-lucide="log-out" class="h-4 w-4"></i>
              <span class="hidden sm:inline" data-translate="logout">Logout</span>
            </button>
          </div>
        </div>
        <!-- Navigation Tabs -->
        <div class="flex items-center gap-1 bg-slate-800 rounded-lg p-1 mt-3 overflow-x-auto">
          <button id="tab-overview" class="tab-btn active flex items-center gap-2 px-4 py-2 rounded-md font-medium text-slate-300 whitespace-nowrap">
            <i data-lucide="layout-dashboard" class="h-4 w-4"></i>
            <span data-translate="overview">Overview</span>
          </button>
          <button id="tab-revenue" class="tab-btn flex items-center gap-2 px-4 py-2 rounded-md font-medium text-slate-300 whitespace-nowrap">
            <i data-lucide="trending-up" class="h-4 w-4"></i>
            <span data-translate="revenue">Revenue</span>
          </button>
          <button id="tab-expenses" class="tab-btn flex items-center gap-2 px-4 py-2 rounded-md font-medium text-slate-300 whitespace-nowrap">
            <i data-lucide="trending-down" class="h-4 w-4"></i>
            <span data-translate="expenses">Expenses</span>
          </button>
          <button id="tab-reports" class="tab-btn flex items-center gap-2 px-4 py-2 rounded-md font-medium text-slate-300 whitespace-nowrap">
            <i data-lucide="bar-chart-3" class="h-4 w-4"></i>
            <span data-translate="reports">Reports</span>
          </button>
          <button id="tab-settings" class="tab-btn flex items-center gap-2 px-4 py-2 rounded-md font-medium text-slate-300 whitespace-nowrap">
            <i data-lucide="settings" class="h-4 w-4"></i>
            <span data-translate="settings">Settings</span>
          </button>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 py-4 sm:py-8">
      <!-- OVERVIEW TAB -->
      <div id="content-overview" class="tab-content">
        <!-- Summary Cards -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-emerald-500">
            <p class="text-xs text-slate-500" data-translate="totalRevenue">Total Revenue</p>
            <p class="text-2xl font-bold text-emerald-600" id="total-revenue">K0</p>
            <p class="text-xs text-emerald-500 mt-1" data-translate="thisMonth">This month</p>
          </div>
          <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-red-500">
            <p class="text-xs text-slate-500" data-translate="totalExpenses">Total Expenses</p>
            <p class="text-2xl font-bold text-red-600" id="total-expenses">K0</p>
            <p class="text-xs text-red-500 mt-1" data-translate="thisMonth">This month</p>
          </div>
          <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-blue-500">
            <p class="text-xs text-slate-500" data-translate="netProfit">Net Profit</p>
            <p class="text-2xl font-bold text-blue-600" id="net-profit">K0</p>
            <p class="text-xs text-blue-500 mt-1" data-translate="thisMonth">This month</p>
          </div>
          <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-purple-500">
            <p class="text-xs text-slate-500" data-translate="transactionCount">Transactions</p>
            <p class="text-2xl font-bold text-purple-600" id="transaction-count">0</p>
            <p class="text-xs text-purple-500 mt-1" data-translate="thisMonth">This month</p>
          </div>
        </div>

        <!-- Exchange Rates Bar -->
        <div class="bg-gradient-to-r from-slate-800 to-slate-900 rounded-xl p-4 mb-6">
          <div class="flex items-center justify-between flex-wrap gap-4">
            <div class="flex items-center gap-6">
              <span class="text-slate-400 text-sm" data-translate="exchangeRates">Exchange Rates:</span>
              <div class="flex items-center gap-4">
                <span class="text-white font-medium">1 USD = <span id="rate-usd" class="text-yellow-400">--</span> ZMW</span>
                <span class="text-white font-medium">1 EUR = <span id="rate-eur" class="text-yellow-400">--</span> ZMW</span>
              </div>
            </div>
            <button onclick="refreshExchangeRates()" class="flex items-center gap-2 px-3 py-1.5 bg-yellow-500 text-black rounded-lg text-sm font-medium hover:bg-yellow-400">
              <i data-lucide="refresh-cw" class="h-4 w-4"></i>
              <span data-translate="refresh">Refresh</span>
            </button>
          </div>
          <p class="text-xs text-slate-500 mt-2"><span data-translate="lastUpdated">Last updated</span>: <span id="rates-updated">Never</span></p>
        </div>

        <!-- Charts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div class="bg-white rounded-xl shadow-sm p-5">
            <div class="flex items-center justify-between mb-4">
              <h3 class="font-bold text-slate-800" data-translate="revenueVsExpenses">Revenue vs Expenses</h3>
              <select id="chartTypeRevExp" onchange="updateOverviewCharts()" class="text-xs border rounded px-2 py-1">
                <option value="line">Line</option>
                <option value="bar">Bar</option>
              </select>
            </div>
            <div class="h-64"><canvas id="revenueExpensesChart"></canvas></div>
          </div>
          <div class="bg-white rounded-xl shadow-sm p-5">
            <div class="flex items-center justify-between mb-4">
              <h3 class="font-bold text-slate-800" data-translate="expensesByCategory">Expenses by Category</h3>
              <select id="chartTypeCat" onchange="updateOverviewCharts()" class="text-xs border rounded px-2 py-1">
                <option value="doughnut">Pie</option>
                <option value="bar">Bar</option>
              </select>
            </div>
            <div class="h-64"><canvas id="categoryPieChart"></canvas></div>
          </div>
        </div>

        <!-- Recent Transactions -->
        <div class="bg-white rounded-xl shadow-sm p-5">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold text-slate-800" data-translate="recentTransactions">Recent Transactions</h3>
            <button onclick="switchTab('expenses')" class="text-sm text-yellow-600 hover:text-yellow-700" data-translate="viewAll">View All ‚Üí</button>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-slate-50">
                <tr>
                  <th class="px-4 py-2 text-left text-slate-600" data-translate="date">Date</th>
                  <th class="px-4 py-2 text-left text-slate-600" data-translate="type">Type</th>
                  <th class="px-4 py-2 text-left text-slate-600" data-translate="description">Description</th>
                  <th class="px-4 py-2 text-left text-slate-600" data-translate="category">Category</th>
                  <th class="px-4 py-2 text-right text-slate-600" data-translate="amount">Amount</th>
                </tr>
              </thead>
              <tbody id="recentTransactionsBody">
                <tr><td colspan="5" class="px-4 py-8 text-center text-slate-400" data-translate="noTransactions">No transactions yet</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- REVENUE TAB -->
      <div id="content-revenue" class="tab-content hidden">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold text-slate-800" data-translate="revenueManagement">Revenue Management</h2>
          <div class="flex gap-2">
            <button onclick="openImportModal('revenue')" class="flex items-center gap-2 px-3 py-1.5 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600">
              <i data-lucide="upload" class="h-4 w-4"></i>
              <span data-translate="importData">Import Data</span>
            </button>
            <button onclick="openReceiptsGallery()" class="flex items-center gap-2 px-3 py-1.5 bg-purple-500 text-white rounded-lg text-sm hover:bg-purple-600">
              <i data-lucide="image" class="h-4 w-4"></i>
              <span>View Receipts</span>
            </button>
            <button onclick="openParamsModal('revenue')" class="flex items-center gap-2 px-3 py-1.5 bg-slate-100 text-slate-700 rounded-lg text-sm hover:bg-slate-200">
              <i data-lucide="settings" class="h-4 w-4"></i>
              <span data-translate="editParameters">Edit Parameters</span>
            </button>
            <!-- Revenue Export Dropdown -->
            <div class="relative" id="revenueExportDropdownContainer">
              <button onclick="toggleRevenueExportDropdown()" class="flex items-center gap-2 px-3 py-1.5 bg-emerald-500 text-white rounded-lg text-sm hover:bg-emerald-600">
                <i data-lucide="file-down" class="h-4 w-4"></i>
                <span data-translate="export">Export</span>
                <i data-lucide="chevron-down" class="h-3 w-3"></i>
              </button>
              <div id="revenueExportDropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl border z-50">
                <button onclick="exportRevenue('csv')" class="w-full px-4 py-2 text-left text-sm hover:bg-slate-50 flex items-center gap-2 rounded-t-lg">
                  <i data-lucide="file-text" class="h-4 w-4 text-emerald-500"></i>
                  Export as CSV
                </button>
                <button onclick="exportRevenue('excel')" class="w-full px-4 py-2 text-left text-sm hover:bg-slate-50 flex items-center gap-2">
                  <i data-lucide="file-spreadsheet" class="h-4 w-4 text-emerald-600"></i>
                  Export as Excel
                </button>
                <button onclick="exportRevenue('json')" class="w-full px-4 py-2 text-left text-sm hover:bg-slate-50 flex items-center gap-2 rounded-b-lg">
                  <i data-lucide="file-json" class="h-4 w-4 text-blue-500"></i>
                  Export as JSON
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Revenue Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-xl p-5 text-white">
            <p class="text-emerald-100 text-sm" data-translate="sportsRevenue">Sports Revenue</p>
            <p class="text-3xl font-bold mt-1" id="sports-revenue">K0</p>
            <p class="text-xs text-emerald-200 mt-2"><span data-translate="target">Target</span>: <span id="paramSportsTarget">K100,000</span></p>
          </div>
          <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-5 text-white">
            <p class="text-purple-100 text-sm" data-translate="casinoRevenue">Casino Revenue</p>
            <p class="text-3xl font-bold mt-1" id="casino-revenue">K0</p>
            <p class="text-xs text-purple-200 mt-2"><span data-translate="target">Target</span>: <span id="paramCasinoTarget">K50,000</span></p>
          </div>
          <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-5 text-white">
            <p class="text-blue-100 text-sm" data-translate="otherRevenue">Other Revenue</p>
            <p class="text-3xl font-bold mt-1" id="other-revenue">K0</p>
            <p class="text-xs text-blue-200 mt-2"><span data-translate="target">Target</span>: <span id="paramOtherTarget">K10,000</span></p>
          </div>
        </div>

        <!-- Add Revenue Form -->
        <div class="bg-white rounded-xl shadow-sm p-5 mb-6">
          <h3 class="font-bold text-slate-800 mb-4" data-translate="addRevenue">Add Revenue Entry</h3>
          <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="date">Date</label>
              <input type="date" id="revDate" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-yellow-400">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="type">Type</label>
              <select id="revType" class="w-full px-3 py-2 border rounded-lg">
                <option value="sports">Sports</option>
                <option value="casino">Casino</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="amount">Amount</label>
              <div class="flex">
                <select id="revCurrency" class="px-2 py-2 border border-r-0 rounded-l-lg bg-slate-50">
                  <option value="ZMW">K</option>
                  <option value="USD">$</option>
                  <option value="EUR">‚Ç¨</option>
                </select>
                <input type="number" id="revAmount" placeholder="0.00" class="w-full px-3 py-2 border rounded-r-lg">
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="reference">Reference</label>
              <input type="text" id="revReference" placeholder="REF-001" class="w-full px-3 py-2 border rounded-lg">
            </div>
            <div class="flex items-end">
              <button onclick="addRevenue()" class="w-full px-4 py-2 bg-emerald-500 text-white rounded-lg font-medium hover:bg-emerald-600">
                <i data-lucide="plus" class="h-4 w-4 inline mr-1"></i>
                <span data-translate="add">Add</span>
              </button>
            </div>
          </div>
          <div class="mt-3">
            <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="description">Description</label>
            <input type="text" id="revDescription" placeholder="Enter description..." class="w-full px-3 py-2 border rounded-lg">
          </div>
        </div>

        <!-- Revenue Table -->
        <div class="bg-white rounded-xl shadow-sm p-5">
          <h3 class="font-bold text-slate-800 mb-4" data-translate="revenueHistory">Revenue History</h3>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-slate-50">
                <tr>
                  <th class="px-4 py-2 text-left text-slate-600" data-translate="date">Date</th>
                  <th class="px-4 py-2 text-left text-slate-600" data-translate="type">Type</th>
                  <th class="px-4 py-2 text-left text-slate-600" data-translate="description">Description</th>
                  <th class="px-4 py-2 text-left text-slate-600" data-translate="reference">Reference</th>
                  <th class="px-4 py-2 text-right text-slate-600" data-translate="amount">Amount</th>
                  <th class="px-4 py-2 text-center text-slate-600" data-translate="actions">Actions</th>
                </tr>
              </thead>
              <tbody id="revenueTableBody">
                <tr><td colspan="6" class="px-4 py-8 text-center text-slate-400" data-translate="noRevenue">No revenue entries yet</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- EXPENSES TAB -->
      <div id="content-expenses" class="tab-content hidden">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold text-slate-800" data-translate="expenseManagement">Expense Management</h2>
          <div class="flex gap-2">
            <button onclick="openImportModal('expenses')" class="flex items-center gap-2 px-3 py-1.5 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600">
              <i data-lucide="upload" class="h-4 w-4"></i>
              <span data-translate="importData">Import Data</span>
            </button>
            <button onclick="openReceiptsGallery()" class="flex items-center gap-2 px-3 py-1.5 bg-purple-500 text-white rounded-lg text-sm hover:bg-purple-600">
              <i data-lucide="image" class="h-4 w-4"></i>
              <span>View Receipts</span>
              <span id="receiptsCountBadge" class="bg-white/20 px-1.5 py-0.5 rounded text-xs hidden">0</span>
            </button>
            <button onclick="openParamsModal('expenses')" class="flex items-center gap-2 px-3 py-1.5 bg-slate-100 text-slate-700 rounded-lg text-sm hover:bg-slate-200">
              <i data-lucide="settings" class="h-4 w-4"></i>
              <span data-translate="editParameters">Edit Parameters</span>
            </button>
            <button onclick="downloadExpenseTemplate()" class="flex items-center gap-2 px-3 py-1.5 bg-slate-100 text-slate-700 rounded-lg text-sm hover:bg-slate-200">
              <i data-lucide="download" class="h-4 w-4"></i>
              <span data-translate="template">Template</span>
            </button>
            <button onclick="showBulkUploadModal()" class="flex items-center gap-2 px-3 py-1.5 bg-slate-100 text-slate-700 rounded-lg text-sm hover:bg-slate-200">
              <i data-lucide="upload" class="h-4 w-4"></i>
              <span data-translate="bulkUpload">Bulk Upload</span>
            </button>
            <!-- Export Dropdown -->
            <div class="relative" id="exportDropdownContainer">
              <button onclick="toggleExportDropdown()" class="flex items-center gap-2 px-3 py-1.5 bg-emerald-500 text-white rounded-lg text-sm hover:bg-emerald-600">
                <i data-lucide="file-down" class="h-4 w-4"></i>
                <span data-translate="export">Export</span>
                <i data-lucide="chevron-down" class="h-3 w-3"></i>
              </button>
              <div id="exportDropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl border z-50">
                <button onclick="exportExpenses('csv')" class="w-full px-4 py-2 text-left text-sm hover:bg-slate-50 flex items-center gap-2 rounded-t-lg">
                  <i data-lucide="file-text" class="h-4 w-4 text-emerald-500"></i>
                  Export as CSV
                </button>
                <button onclick="exportExpenses('excel')" class="w-full px-4 py-2 text-left text-sm hover:bg-slate-50 flex items-center gap-2">
                  <i data-lucide="file-spreadsheet" class="h-4 w-4 text-emerald-600"></i>
                  Export as Excel
                </button>
                <button onclick="exportExpenses('json')" class="w-full px-4 py-2 text-left text-sm hover:bg-slate-50 flex items-center gap-2 rounded-b-lg">
                  <i data-lucide="file-json" class="h-4 w-4 text-blue-500"></i>
                  Export as JSON
                </button>
              </div>
            </div>
            <button onclick="showAddExpenseModal()" class="flex items-center gap-2 px-4 py-2 bg-yellow-500 text-black rounded-lg font-medium hover:bg-yellow-400">
              <i data-lucide="plus" class="h-4 w-4"></i>
              <span data-translate="addExpense">Add Expense</span>
            </button>
          </div>
        </div>

        <!-- Category Tabs -->
        <div class="bg-white rounded-xl shadow-sm mb-6">
          <div class="flex border-b overflow-x-auto">
            <button onclick="selectExpenseCategory('all')" id="expCatTab-all" class="exp-cat-tab active flex items-center gap-2 px-6 py-4 text-sm font-medium border-b-2 border-yellow-500 text-yellow-600 whitespace-nowrap">
              <i data-lucide="layers" class="h-4 w-4"></i>
              <span data-translate="allCategories">All Categories</span>
              <span class="bg-slate-200 text-slate-700 px-2 py-0.5 rounded-full text-xs" id="expCount-all">0</span>
            </button>
            <button onclick="selectExpenseCategory('gaming_operations')" id="expCatTab-gaming_operations" class="exp-cat-tab flex items-center gap-2 px-6 py-4 text-sm font-medium border-b-2 border-transparent text-slate-500 hover:text-purple-600 hover:border-purple-300 whitespace-nowrap">
              <span class="w-3 h-3 rounded-full bg-purple-500"></span>
              <span data-translate="gamingOperations">Gaming Operations</span>
              <span class="bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full text-xs" id="expCount-gaming_operations">0</span>
            </button>
            <button onclick="selectExpenseCategory('shop_operating')" id="expCatTab-shop_operating" class="exp-cat-tab flex items-center gap-2 px-6 py-4 text-sm font-medium border-b-2 border-transparent text-slate-500 hover:text-amber-600 hover:border-amber-300 whitespace-nowrap">
              <span class="w-3 h-3 rounded-full bg-amber-500"></span>
              <span data-translate="shopOperating">Shop Operating</span>
              <span class="bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full text-xs" id="expCount-shop_operating">0</span>
            </button>
            <button onclick="selectExpenseCategory('office_operations')" id="expCatTab-office_operations" class="exp-cat-tab flex items-center gap-2 px-6 py-4 text-sm font-medium border-b-2 border-transparent text-slate-500 hover:text-blue-600 hover:border-blue-300 whitespace-nowrap">
              <span class="w-3 h-3 rounded-full bg-blue-500"></span>
              <span data-translate="officeOperations">Office Operations</span>
              <span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full text-xs" id="expCount-office_operations">0</span>
            </button>
            <button onclick="selectExpenseCategory('administrative')" id="expCatTab-administrative" class="exp-cat-tab flex items-center gap-2 px-6 py-4 text-sm font-medium border-b-2 border-transparent text-slate-500 hover:text-emerald-600 hover:border-emerald-300 whitespace-nowrap">
              <span class="w-3 h-3 rounded-full bg-emerald-500"></span>
              <span data-translate="administrative">Administrative</span>
              <span class="bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded-full text-xs" id="expCount-administrative">0</span>
            </button>
          </div>
          
          <!-- Category Summary Cards (shown when category selected) -->
          <div id="categoryDetailCard" class="hidden p-4 bg-gradient-to-r from-slate-50 to-white border-b">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="font-bold text-lg" id="selectedCategoryName">Category Name</h3>
                <p class="text-sm text-slate-500" id="selectedCategoryDesc">Category expenses summary</p>
              </div>
              <div class="text-right">
                <p class="text-2xl font-bold" id="selectedCategoryTotal">K0</p>
                <p class="text-xs text-slate-500"><span data-translate="budget">Budget</span>: <span id="selectedCategoryBudget">K0</span></p>
              </div>
            </div>
          </div>
        </div>

        <!-- Expense Filters -->
        <div class="bg-white rounded-xl shadow-sm p-4 mb-6">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="fromDate">From Date</label>
              <input type="date" id="expFilterFrom" class="w-full px-3 py-2 border rounded-lg" onchange="filterExpenses()">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="toDate">To Date</label>
              <input type="date" id="expFilterTo" class="w-full px-3 py-2 border rounded-lg" onchange="filterExpenses()">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="currency">Currency</label>
              <select id="expFilterCurrency" class="w-full px-3 py-2 border rounded-lg" onchange="filterExpenses()">
                <option value="">All Currencies</option>
                <option value="ZMW">ZMW (Kwacha)</option>
                <option value="USD">USD (Dollar)</option>
                <option value="EUR">EUR (Euro)</option>
              </select>
            </div>
            <div class="flex items-end gap-2">
              <button onclick="filterExpenses()" class="flex-1 px-4 py-2 bg-slate-800 text-white rounded-lg font-medium hover:bg-slate-700">
                <i data-lucide="filter" class="h-4 w-4 inline mr-1"></i>
                <span data-translate="filter">Filter</span>
              </button>
              <button onclick="clearExpenseFilters()" class="px-3 py-2 bg-slate-100 text-slate-600 rounded-lg hover:bg-slate-200" title="Clear filters">
                <i data-lucide="x" class="h-4 w-4"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Expenses Table -->
        <div class="bg-white rounded-xl shadow-sm p-5">
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-slate-50">
                <tr>
                  <th class="px-4 py-2 text-left text-slate-600" data-translate="date">Date</th>
                  <th class="px-4 py-2 text-left text-slate-600" data-translate="category">Category</th>
                  <th class="px-4 py-2 text-left text-slate-600" data-translate="vendor">Vendor</th>
                  <th class="px-4 py-2 text-left text-slate-600" data-translate="description">Description</th>
                  <th class="px-4 py-2 text-right text-slate-600" data-translate="amount">Amount</th>
                  <th class="px-4 py-2 text-center text-slate-600" data-translate="receipt">Receipt</th>
                  <th class="px-4 py-2 text-center text-slate-600" data-translate="actions">Actions</th>
                </tr>
              </thead>
              <tbody id="expensesTableBody">
                <tr><td colspan="7" class="px-4 py-8 text-center text-slate-400" data-translate="noExpenses">No expenses recorded yet</td></tr>
              </tbody>
            </table>
          </div>
          <div class="mt-4 flex items-center justify-between text-sm text-slate-500">
            <span id="expensesCount">0 <span data-translate="expenses">expenses</span></span>
            <span><span data-translate="total">Total</span>: <span id="expensesTotal">K0</span></span>
          </div>
        </div>
      </div>

      <!-- REPORTS TAB -->
      <div id="content-reports" class="tab-content hidden">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold text-slate-800" data-translate="financialReports">Financial Reports</h2>
          <div class="flex gap-2">
            <button onclick="openImportModal('reports')" class="flex items-center gap-2 px-3 py-1.5 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600">
              <i data-lucide="upload" class="h-4 w-4"></i>
              <span data-translate="importData">Import Data</span>
            </button>
            <button onclick="openParamsModal('reports')" class="flex items-center gap-2 px-3 py-1.5 bg-slate-100 text-slate-700 rounded-lg text-sm hover:bg-slate-200">
              <i data-lucide="settings" class="h-4 w-4"></i>
              <span data-translate="editParameters">Edit Parameters</span>
            </button>
          </div>
        </div>

        <!-- Report Controls -->
        <div class="bg-white rounded-xl shadow-sm p-4 mb-6">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="fromDate">From Date</label>
              <input type="date" id="reportDateFrom" class="w-full px-3 py-2 border rounded-lg">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="toDate">To Date</label>
              <input type="date" id="reportDateTo" class="w-full px-3 py-2 border rounded-lg">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="projectionMethod">Projection Method</label>
              <select id="projectionMethod" class="w-full px-3 py-2 border rounded-lg">
                <option value="historical" data-translate="historicalAverage">Historical Average</option>
                <option value="linear" data-translate="linearTrend">Linear Trend</option>
                <option value="manual" data-translate="manualTarget">Manual Target</option>
              </select>
            </div>
            <div class="flex items-end">
              <button onclick="generateReports()" class="w-full px-4 py-2 bg-yellow-500 text-black rounded-lg font-medium hover:bg-yellow-400">
                <i data-lucide="bar-chart-3" class="h-4 w-4 inline mr-1"></i>
                <span data-translate="generate">Generate</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Charts Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div class="bg-white rounded-xl shadow-sm p-5">
            <h3 class="font-bold text-slate-800 mb-4" data-translate="monthlyTrend">Monthly Trend</h3>
            <div class="h-64"><canvas id="reportTrendChart"></canvas></div>
          </div>
          <div class="bg-white rounded-xl shadow-sm p-5">
            <h3 class="font-bold text-slate-800 mb-4" data-translate="profitLoss">Profit/Loss by Month</h3>
            <div class="h-64"><canvas id="reportProfitChart"></canvas></div>
          </div>
          <div class="bg-white rounded-xl shadow-sm p-5">
            <h3 class="font-bold text-slate-800 mb-4" data-translate="revenueBySource">Revenue by Source</h3>
            <div class="h-64"><canvas id="reportRevenueSourceChart"></canvas></div>
          </div>
          <div class="bg-white rounded-xl shadow-sm p-5">
            <h3 class="font-bold text-slate-800 mb-4" data-translate="currencyBreakdown">Currency Breakdown</h3>
            <div class="h-64"><canvas id="reportCurrencyChart"></canvas></div>
          </div>
          <div class="bg-white rounded-xl shadow-sm p-5 lg:col-span-2">
            <h3 class="font-bold text-slate-800 mb-4" data-translate="projections">30-Day Projections</h3>
            <div class="h-64"><canvas id="reportProjectionChart"></canvas></div>
          </div>
        </div>

        <!-- Export Buttons -->
        <div class="flex gap-4">
          <button onclick="exportReportCSV()" class="flex items-center gap-2 px-4 py-2 bg-emerald-500 text-white rounded-lg font-medium hover:bg-emerald-600">
            <i data-lucide="file-spreadsheet" class="h-4 w-4"></i>
            <span data-translate="exportCsv">Export CSV</span>
          </button>
          <button onclick="printReport()" class="flex items-center gap-2 px-4 py-2 bg-slate-600 text-white rounded-lg font-medium hover:bg-slate-700">
            <i data-lucide="printer" class="h-4 w-4"></i>
            <span data-translate="print">Print</span>
          </button>
        </div>
      </div>

      <!-- SETTINGS TAB -->
      <div id="content-settings" class="tab-content hidden">
        <h2 class="text-xl font-bold text-slate-800 mb-6" data-translate="accountingSettings">Accounting Settings</h2>

        <!-- User Info -->
        <div class="bg-white rounded-xl shadow-sm p-5 mb-6">
          <h3 class="font-bold text-slate-800 mb-4" data-translate="accountInfo">Account Information</h3>
          <div class="flex items-center gap-4">
            <div class="w-16 h-16 bg-yellow-500 rounded-full flex items-center justify-center">
              <i data-lucide="user" class="h-8 w-8 text-black"></i>
            </div>
            <div>
              <p class="font-medium text-slate-800" id="settingsUserEmail"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="d9acaabcab99bca1b8b4a9b5bcf7bab6b4">[email&#160;protected]</a></p>
              <p class="text-sm text-slate-500" data-translate="administrator">Administrator</p>
            </div>
          </div>
        </div>

        <!-- Subcategory Management -->
        <div class="bg-white rounded-xl shadow-sm p-5 mb-6">
          <h3 class="font-bold text-slate-800 mb-4" data-translate="expenseSubcategories">Expense Subcategories</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Gaming Operations -->
            <div class="border rounded-lg p-4">
              <div class="flex items-center justify-between mb-3">
                <h4 class="font-medium text-purple-700 flex items-center gap-2">
                  <span class="w-3 h-3 rounded-full bg-purple-500"></span>
                  <span data-translate="gamingOperations">Gaming Operations</span>
                </h4>
                <button onclick="addSubcategory('gaming_operations')" class="text-purple-600 hover:text-purple-700">
                  <i data-lucide="plus" class="h-4 w-4"></i>
                </button>
              </div>
              <div id="subcats-gaming_operations" class="space-y-2 text-sm">
                <p class="text-slate-400" data-translate="noSubcategories">No subcategories defined</p>
              </div>
            </div>
            <!-- Shop Operating -->
            <div class="border rounded-lg p-4">
              <div class="flex items-center justify-between mb-3">
                <h4 class="font-medium text-amber-700 flex items-center gap-2">
                  <span class="w-3 h-3 rounded-full bg-amber-500"></span>
                  <span data-translate="shopOperating">Shop Operating Expenses</span>
                </h4>
                <button onclick="addSubcategory('shop_operating')" class="text-amber-600 hover:text-amber-700">
                  <i data-lucide="plus" class="h-4 w-4"></i>
                </button>
              </div>
              <div id="subcats-shop_operating" class="space-y-2 text-sm">
                <p class="text-slate-400" data-translate="noSubcategories">No subcategories defined</p>
              </div>
            </div>
            <!-- Office Operations -->
            <div class="border rounded-lg p-4">
              <div class="flex items-center justify-between mb-3">
                <h4 class="font-medium text-blue-700 flex items-center gap-2">
                  <span class="w-3 h-3 rounded-full bg-blue-500"></span>
                  <span data-translate="officeOperations">Office Operations</span>
                </h4>
                <button onclick="addSubcategory('office_operations')" class="text-blue-600 hover:text-blue-700">
                  <i data-lucide="plus" class="h-4 w-4"></i>
                </button>
              </div>
              <div id="subcats-office_operations" class="space-y-2 text-sm">
                <p class="text-slate-400" data-translate="noSubcategories">No subcategories defined</p>
              </div>
            </div>
            <!-- Administrative -->
            <div class="border rounded-lg p-4">
              <div class="flex items-center justify-between mb-3">
                <h4 class="font-medium text-emerald-700 flex items-center gap-2">
                  <span class="w-3 h-3 rounded-full bg-emerald-500"></span>
                  <span data-translate="administrative">Administrative Operations</span>
                </h4>
                <button onclick="addSubcategory('administrative')" class="text-emerald-600 hover:text-emerald-700">
                  <i data-lucide="plus" class="h-4 w-4"></i>
                </button>
              </div>
              <div id="subcats-administrative" class="space-y-2 text-sm">
                <p class="text-slate-400" data-translate="noSubcategories">No subcategories defined</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Audit Log -->
        <div class="bg-white rounded-xl shadow-sm p-5">
          <h3 class="font-bold text-slate-800 mb-4" data-translate="auditLog">Audit Log</h3>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-slate-50">
                <tr>
                  <th class="px-4 py-2 text-left text-slate-600" data-translate="timestamp">Timestamp</th>
                  <th class="px-4 py-2 text-left text-slate-600" data-translate="user">User</th>
                  <th class="px-4 py-2 text-left text-slate-600" data-translate="action">Action</th>
                  <th class="px-4 py-2 text-left text-slate-600" data-translate="details">Details</th>
                </tr>
              </thead>
              <tbody id="auditLogBody">
                <tr><td colspan="4" class="px-4 py-8 text-center text-slate-400" data-translate="noAuditLogs">No audit logs yet</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- CSV Import Section -->
        <div class="bg-white rounded-xl shadow-sm p-5 mt-6">
          <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
            <i data-lucide="file-spreadsheet" class="h-5 w-5 text-yellow-500"></i>
            <span data-translate="importData">Import Data from CSV</span>
          </h3>
          <p class="text-sm text-slate-500 mb-4" data-translate="importDescription">Upload CSV files to bulk import revenue and expense data. Download templates to see the required format.</p>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Import Revenue -->
            <div class="border-2 border-dashed border-slate-200 rounded-xl p-5 hover:border-emerald-400 transition-colors">
              <div class="flex items-center gap-3 mb-3">
                <div class="w-10 h-10 bg-emerald-100 rounded-lg flex items-center justify-center">
                  <i data-lucide="trending-up" class="h-5 w-5 text-emerald-600"></i>
                </div>
                <div>
                  <h4 class="font-medium text-slate-800" data-translate="importRevenue">Import Revenue</h4>
                  <p class="text-xs text-slate-500" data-translate="csvFormat">CSV format</p>
                </div>
              </div>
              <div class="space-y-2">
                <button onclick="downloadRevenueTemplate()" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-slate-100 text-slate-700 rounded-lg text-sm hover:bg-slate-200">
                  <i data-lucide="download" class="h-4 w-4"></i>
                  <span data-translate="downloadTemplate">Download Template</span>
                </button>
                <label class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-emerald-500 text-white rounded-lg text-sm hover:bg-emerald-600 cursor-pointer">
                  <i data-lucide="upload" class="h-4 w-4"></i>
                  <span data-translate="uploadCsv">Upload CSV</span>
                  <input type="file" accept=".csv" class="hidden" onchange="importRevenueCSV(this.files[0])">
                </label>
              </div>
            </div>

            <!-- Import Expenses -->
            <div class="border-2 border-dashed border-slate-200 rounded-xl p-5 hover:border-red-400 transition-colors">
              <div class="flex items-center gap-3 mb-3">
                <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center">
                  <i data-lucide="trending-down" class="h-5 w-5 text-red-600"></i>
                </div>
                <div>
                  <h4 class="font-medium text-slate-800" data-translate="importExpenses">Import Expenses</h4>
                  <p class="text-xs text-slate-500" data-translate="csvFormat">CSV format</p>
                </div>
              </div>
              <div class="space-y-2">
                <button onclick="downloadExpensesTemplate()" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-slate-100 text-slate-700 rounded-lg text-sm hover:bg-slate-200">
                  <i data-lucide="download" class="h-4 w-4"></i>
                  <span data-translate="downloadTemplate">Download Template</span>
                </button>
                <label class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-red-500 text-white rounded-lg text-sm hover:bg-red-600 cursor-pointer">
                  <i data-lucide="upload" class="h-4 w-4"></i>
                  <span data-translate="uploadCsv">Upload CSV</span>
                  <input type="file" accept=".csv" class="hidden" onchange="importExpensesCSV(this.files[0])">
                </label>
              </div>
            </div>
          </div>

          <!-- Import Preview -->
          <div id="importPreview" class="hidden mt-6">
            <div class="flex items-center justify-between mb-3">
              <h4 class="font-medium text-slate-800" data-translate="previewData">Preview Data</h4>
              <span class="text-sm text-slate-500" id="importPreviewCount">0 rows</span>
            </div>
            <div class="max-h-64 overflow-auto border rounded-lg" id="importPreviewTable"></div>
            <div class="flex gap-3 mt-4">
              <button onclick="cancelImport()" class="flex-1 px-4 py-2 border border-slate-300 rounded-lg text-slate-600 font-medium hover:bg-slate-100" data-translate="cancel">Cancel</button>
              <button onclick="confirmImport()" class="flex-1 px-4 py-2 bg-yellow-500 text-black rounded-lg font-medium hover:bg-yellow-400" data-translate="confirmImport">Confirm Import</button>
            </div>
          </div>

          <!-- Load Mock Data Button -->
          <div class="mt-6 pt-6 border-t">
            <h4 class="font-medium text-slate-800 mb-2" data-translate="testData">Test Data</h4>
            <p class="text-sm text-slate-500 mb-3" data-translate="testDataDescription">Load sample data to test the system without importing CSV files.</p>
            <button onclick="loadMockData()" class="flex items-center gap-2 px-4 py-2 bg-purple-500 text-white rounded-lg text-sm font-medium hover:bg-purple-600">
              <i data-lucide="database" class="h-4 w-4"></i>
              <span data-translate="loadMockData">Load Mock Data</span>
            </button>
          </div>
        </div>
      </div>
    </main>

    <!-- Add Expense Modal -->
    <div id="addExpenseModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden">
        <div class="px-6 py-4 border-b-2 border-yellow-400 bg-gradient-to-r from-slate-900 to-slate-800">
          <h3 class="text-lg font-bold text-white" data-translate="addExpense">Add Expense</h3>
        </div>
        <div class="p-6 space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="date">Date</label>
              <input type="date" id="expDate" class="w-full px-3 py-2 border rounded-lg">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="category">Category</label>
              <select id="expCategory" onchange="loadSubcategoriesDropdown()" class="w-full px-3 py-2 border rounded-lg">
                <option value="gaming_operations">Gaming Operations</option>
                <option value="shop_operating">Shop Operating</option>
                <option value="office_operations">Office Operations</option>
                <option value="administrative">Administrative</option>
              </select>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="subcategory">Subcategory</label>
            <select id="expSubcategory" class="w-full px-3 py-2 border rounded-lg">
              <option value="">Select subcategory...</option>
            </select>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="amount">Amount</label>
              <div class="flex">
                <select id="expCurrency" class="px-2 py-2 border border-r-0 rounded-l-lg bg-slate-50">
                  <option value="ZMW">K (ZMW)</option>
                  <option value="USD">$ (USD)</option>
                  <option value="EUR">‚Ç¨ (EUR)</option>
                </select>
                <input type="number" id="expAmount" placeholder="0.00" class="w-full px-3 py-2 border rounded-r-lg">
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="paymentMethod">Payment Method</label>
              <select id="expPaymentMethod" class="w-full px-3 py-2 border rounded-lg">
                <option value="cash">Cash</option>
                <option value="bank_transfer">Bank Transfer</option>
                <option value="mobile_money">Mobile Money</option>
                <option value="card">Card</option>
              </select>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="vendor">Vendor/Payee</label>
            <input type="text" id="expVendor" placeholder="Enter vendor name..." class="w-full px-3 py-2 border rounded-lg">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="description">Description</label>
            <input type="text" id="expDescription" placeholder="Enter description..." class="w-full px-3 py-2 border rounded-lg">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1" data-translate="receiptNumber">Receipt Number</label>
            <input type="text" id="expReceiptNum" placeholder="Optional..." class="w-full px-3 py-2 border rounded-lg">
          </div>
        </div>
        <div class="px-6 py-4 bg-slate-50 border-t flex gap-3">
          <button onclick="closeAddExpenseModal()" class="flex-1 py-2 px-4 border border-slate-300 rounded-lg text-slate-600 font-medium hover:bg-slate-100" data-translate="cancel">Cancel</button>
          <button onclick="saveExpense()" class="flex-1 py-2 px-4 bg-yellow-500 text-black rounded-lg font-medium hover:bg-yellow-400" data-translate="saveExpense">Save Expense</button>
        </div>
      </div>
    </div>

    <!-- Bulk Upload Modal -->
    <div id="bulkUploadModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden">
        <div class="px-6 py-4 border-b-2 border-yellow-400 bg-gradient-to-r from-slate-900 to-slate-800">
          <h3 class="text-lg font-bold text-white" data-translate="bulkUploadExpenses">Bulk Upload Expenses</h3>
        </div>
        <div class="p-6">
          <label class="block border-2 border-dashed border-slate-300 rounded-xl p-8 text-center cursor-pointer hover:border-yellow-400">
            <input type="file" id="bulkUploadFile" accept=".csv,.xlsx,.xls" class="hidden" onchange="handleBulkUpload(this.files[0])">
            <i data-lucide="upload-cloud" class="h-12 w-12 text-slate-400 mx-auto mb-3"></i>
            <p class="text-slate-600 font-medium" data-translate="dragDropFile">Drag & drop or click to upload</p>
            <p class="text-sm text-slate-400 mt-1">CSV, XLSX, XLS</p>
          </label>
          <div id="bulkUploadPreview" class="hidden mt-4 max-h-48 overflow-auto border rounded-lg"></div>
        </div>
        <div class="px-6 py-4 bg-slate-50 border-t flex gap-3">
          <button onclick="closeBulkUploadModal()" class="flex-1 py-2 px-4 border border-slate-300 rounded-lg text-slate-600 font-medium hover:bg-slate-100" data-translate="cancel">Cancel</button>
          <button id="confirmBulkUploadBtn" onclick="confirmBulkUpload()" class="flex-1 py-2 px-4 bg-yellow-500 text-black rounded-lg font-medium hover:bg-yellow-400 disabled:opacity-50" disabled data-translate="import">Import</button>
        </div>
      </div>
    </div>

    <!-- Parameters Modal -->
    <div id="paramsModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden max-h-[90vh] flex flex-col">
        <div class="px-6 py-4 border-b-2 border-yellow-400 bg-gradient-to-r from-slate-900 to-slate-800">
          <h3 class="text-lg font-bold text-white flex items-center gap-2">
            <i data-lucide="settings" class="h-5 w-5 text-yellow-400"></i>
            <span id="paramsModalTitle" data-translate="editParameters">Edit Parameters</span>
          </h3>
          <p class="text-xs text-slate-400 mt-1" id="paramsModalSubtitle" data-translate="adjustThresholds">Adjust thresholds and targets</p>
        </div>
        <div class="p-6 overflow-y-auto flex-1" id="paramsModalContent">
          <!-- Content will be dynamically loaded -->
        </div>
        <div class="px-6 py-4 bg-slate-50 border-t flex gap-3">
          <button onclick="closeParamsModal()" class="flex-1 py-2 px-4 border border-slate-300 rounded-lg text-slate-600 font-medium hover:bg-slate-100" data-translate="cancel">Cancel</button>
          <button onclick="saveParams()" class="flex-1 py-2 px-4 bg-yellow-500 text-black rounded-lg font-medium hover:bg-yellow-400" data-translate="saveAndApply">Save & Apply</button>
        </div>
      </div>
    </div>

    <!-- ==================== IMPORT DATA MODAL ==================== -->
    <div id="importModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl overflow-hidden max-h-[95vh] flex flex-col">
        <!-- Header -->
        <div class="px-6 py-4 border-b-2 border-blue-400 bg-gradient-to-r from-slate-900 to-slate-800">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-lg font-bold text-white flex items-center gap-2">
                <i data-lucide="upload" class="h-5 w-5 text-blue-400"></i>
                <span id="importModalTitle">Import Data</span>
              </h3>
              <p class="text-xs text-slate-400 mt-1" id="importModalSubtitle">Import revenue or expense data</p>
            </div>
            <button onclick="closeImportModal()" class="text-slate-400 hover:text-white p-2">
              <i data-lucide="x" class="h-6 w-6"></i>
            </button>
          </div>
        </div>
        
        <!-- Import Method Tabs -->
        <div class="flex border-b bg-slate-50">
          <button onclick="switchImportTab('csv')" id="importTab-csv" class="import-tab active flex-1 flex items-center justify-center gap-2 px-4 py-3 font-medium text-sm">
            <i data-lucide="file-text" class="h-4 w-4"></i>
            CSV File
          </button>
          <button onclick="switchImportTab('excel')" id="importTab-excel" class="import-tab flex-1 flex items-center justify-center gap-2 px-4 py-3 font-medium text-sm">
            <i data-lucide="file-spreadsheet" class="h-4 w-4"></i>
            Excel File
          </button>
          <button onclick="switchImportTab('manual')" id="importTab-manual" class="import-tab flex-1 flex items-center justify-center gap-2 px-4 py-3 font-medium text-sm">
            <i data-lucide="edit-3" class="h-4 w-4"></i>
            Manual Entry
          </button>
          <button onclick="switchImportTab('receipt')" id="importTab-receipt" class="import-tab flex-1 flex items-center justify-center gap-2 px-4 py-3 font-medium text-sm">
            <i data-lucide="camera" class="h-4 w-4"></i>
            Receipt/Invoice Scan
          </button>
        </div>
        
        <!-- Tab Content -->
        <div class="flex-1 overflow-y-auto p-6">
          <!-- CSV Import Tab -->
          <div id="importContent-csv" class="import-content">
            <div class="mb-4">
              <p class="text-sm text-slate-600 mb-4">Upload a CSV file with your data. <a href="#" onclick="downloadImportTemplate()" class="text-blue-500 hover:underline">Download template</a></p>
              <div class="drop-zone" id="csvDropZone" onclick="document.getElementById('csvFileInput').click()" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleCsvDrop(event)">
                <i data-lucide="upload-cloud" class="h-12 w-12 mx-auto text-slate-400 mb-3"></i>
                <p class="text-slate-600 font-medium">Drop CSV file here or click to browse</p>
                <p class="text-xs text-slate-400 mt-1">Maximum file size: 10MB</p>
                <input type="file" id="csvFileInput" accept=".csv" class="hidden" onchange="handleCsvFile(this.files[0])">
              </div>
            </div>
            <div id="csvPreview" class="hidden">
              <div class="flex items-center justify-between mb-3">
                <h4 class="font-medium text-slate-800">Preview Data</h4>
                <span class="text-sm text-slate-500" id="csvRowCount">0 rows</span>
              </div>
              <div class="max-h-64 overflow-auto border rounded-lg" id="csvPreviewTable"></div>
            </div>
          </div>
          
          <!-- Excel Import Tab -->
          <div id="importContent-excel" class="import-content hidden">
            <div class="mb-4">
              <p class="text-sm text-slate-600 mb-4">Upload an Excel file (.xlsx, .xls) with your data.</p>
              <div class="drop-zone" id="excelDropZone" onclick="document.getElementById('excelFileInput').click()" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleExcelDrop(event)">
                <i data-lucide="file-spreadsheet" class="h-12 w-12 mx-auto text-slate-400 mb-3"></i>
                <p class="text-slate-600 font-medium">Drop Excel file here or click to browse</p>
                <p class="text-xs text-slate-400 mt-1">Supports .xlsx and .xls formats</p>
                <input type="file" id="excelFileInput" accept=".xlsx,.xls" class="hidden" onchange="handleExcelFile(this.files[0])">
              </div>
            </div>
            <div id="excelPreview" class="hidden">
              <div class="flex items-center justify-between mb-3">
                <h4 class="font-medium text-slate-800">Preview Data</h4>
                <span class="text-sm text-slate-500" id="excelRowCount">0 rows</span>
              </div>
              <div class="max-h-64 overflow-auto border rounded-lg" id="excelPreviewTable"></div>
            </div>
          </div>
          
          <!-- Manual Entry Tab -->
          <div id="importContent-manual" class="import-content hidden">
            <p class="text-sm text-slate-600 mb-4">Add entries manually. You can add multiple entries before importing.</p>
            <div id="manualEntriesContainer">
              <!-- Entry form will be added here -->
            </div>
            <button onclick="addManualEntryRow()" class="mt-4 flex items-center gap-2 px-4 py-2 border-2 border-dashed border-slate-300 rounded-lg text-slate-600 hover:border-yellow-400 hover:text-yellow-600 w-full justify-center">
              <i data-lucide="plus" class="h-4 w-4"></i>
              Add Another Entry
            </button>
            <div id="manualEntriesPreview" class="hidden mt-6">
              <h4 class="font-medium text-slate-800 mb-3">Entries to Import (<span id="manualEntryCount">0</span>)</h4>
              <div class="max-h-48 overflow-auto border rounded-lg" id="manualEntriesTable"></div>
            </div>
          </div>
          
          <!-- Receipt/Invoice Scan Tab -->
          <div id="importContent-receipt" class="import-content hidden">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
              <div class="flex items-start gap-3">
                <i data-lucide="info" class="h-5 w-5 text-blue-500 mt-0.5"></i>
                <div>
                  <p class="text-sm text-blue-800 font-medium">AI-Powered Receipt Scanning</p>
                  <p class="text-xs text-blue-600 mt-1">Upload images of receipts or invoices. Our AI will automatically extract the information. You can review and edit before importing.</p>
                </div>
              </div>
            </div>
            
            <div class="drop-zone" id="receiptDropZone" onclick="document.getElementById('receiptFileInput').click()" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleReceiptDrop(event)">
              <i data-lucide="camera" class="h-12 w-12 mx-auto text-slate-400 mb-3"></i>
              <p class="text-slate-600 font-medium">Drop receipt/invoice images here or click to browse</p>
              <p class="text-xs text-slate-400 mt-1">Supports JPG, PNG, PDF ‚Ä¢ Multiple files allowed</p>
              <input type="file" id="receiptFileInput" accept="image/*,.pdf" multiple class="hidden" onchange="handleReceiptFiles(this.files)">
            </div>
            
            <!-- Scanning Progress -->
            <div id="scanningProgress" class="hidden mt-4">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-slate-700">Scanning receipts...</span>
                <span class="text-sm text-slate-500" id="scanProgressText">0/0</span>
              </div>
              <div class="scan-progress">
                <div class="scan-progress-bar" id="scanProgressBar" style="width: 0%"></div>
              </div>
            </div>
            
            <!-- Scanned Receipts Grid -->
            <div id="scannedReceiptsContainer" class="hidden mt-6">
              <div class="flex items-center justify-between mb-4">
                <h4 class="font-medium text-slate-800">Scanned Receipts (<span id="scannedReceiptCount">0</span>)</h4>
                <button onclick="clearScannedReceipts()" class="text-sm text-red-500 hover:text-red-600">Clear All</button>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="scannedReceiptsGrid">
                <!-- Scanned receipt cards will be added here -->
              </div>
            </div>
          </div>
        </div>
        
        <!-- Footer -->
        <div class="px-6 py-4 bg-slate-50 border-t flex justify-between items-center">
          <div class="text-sm text-slate-500">
            <span id="importSummary">No data to import</span>
          </div>
          <div class="flex gap-3">
            <button onclick="closeImportModal()" class="px-4 py-2 border border-slate-300 rounded-lg text-slate-600 font-medium hover:bg-slate-100">Cancel</button>
            <button onclick="executeImport()" id="executeImportBtn" disabled class="px-6 py-2 bg-blue-500 text-white rounded-lg font-medium hover:bg-blue-600 disabled:bg-slate-300 disabled:cursor-not-allowed">
              <i data-lucide="check" class="h-4 w-4 inline mr-1"></i>
              Import Data
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- ==================== END IMPORT MODAL ==================== -->

    <!-- ==================== RECEIPTS GALLERY MODAL ==================== -->
    <div id="receiptsGalleryModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-6xl overflow-hidden max-h-[95vh] flex flex-col">
        <!-- Header -->
        <div class="px-6 py-4 border-b-2 border-purple-400 bg-gradient-to-r from-slate-900 to-slate-800">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-lg font-bold text-white flex items-center gap-2">
                <i data-lucide="image" class="h-5 w-5 text-purple-400"></i>
                <span>Receipts & Invoices Gallery</span>
              </h3>
              <p class="text-xs text-slate-400 mt-1">View all uploaded receipts and invoices</p>
            </div>
            <button onclick="closeReceiptsGallery()" class="text-slate-400 hover:text-white p-2">
              <i data-lucide="x" class="h-6 w-6"></i>
            </button>
          </div>
        </div>
        
        <!-- Filters & Search -->
        <div class="px-6 py-4 bg-slate-50 border-b flex flex-wrap items-center gap-4">
          <div class="flex items-center gap-2">
            <span class="text-sm text-slate-600">Filter:</span>
            <button onclick="filterReceipts('all')" class="receipt-filter-btn active" data-filter="all">All</button>
            <button onclick="filterReceipts('expense')" class="receipt-filter-btn" data-filter="expense">Expenses</button>
            <button onclick="filterReceipts('revenue')" class="receipt-filter-btn" data-filter="revenue">Revenue</button>
          </div>
          <div class="flex-1"></div>
          <div class="relative">
            <i data-lucide="search" class="h-4 w-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
            <input type="text" id="receiptSearchInput" placeholder="Search receipts..." 
                   class="pl-9 pr-4 py-2 border rounded-lg text-sm w-64" 
                   oninput="searchReceipts(this.value)">
          </div>
          <div class="text-sm text-slate-500">
            <span id="receiptsGalleryCount">0</span> receipts
          </div>
        </div>
        
        <!-- Gallery Grid -->
        <div class="flex-1 overflow-y-auto p-6">
          <div id="receiptsGalleryGrid" class="receipt-gallery-grid">
            <!-- Receipt cards will be rendered here -->
          </div>
          
          <!-- Empty State -->
          <div id="receiptsEmptyState" class="hidden text-center py-16">
            <i data-lucide="image-off" class="h-16 w-16 mx-auto text-slate-300 mb-4"></i>
            <h3 class="text-lg font-medium text-slate-600 mb-2">No Receipts Found</h3>
            <p class="text-sm text-slate-400 mb-6">Upload receipts through the Import Data feature to see them here.</p>
            <button onclick="closeReceiptsGallery(); openImportModal('expenses');" class="px-4 py-2 bg-purple-500 text-white rounded-lg text-sm hover:bg-purple-600">
              <i data-lucide="upload" class="h-4 w-4 inline mr-1"></i>
              Import Receipts
            </button>
          </div>
        </div>
        
        <!-- Footer -->
        <div class="px-6 py-4 bg-slate-50 border-t flex justify-between items-center">
          <div class="text-sm text-slate-500">
            Total: <span id="receiptsTotalAmount">K0</span>
          </div>
          <div class="flex gap-3">
            <button onclick="exportReceiptsData()" class="px-4 py-2 bg-emerald-500 text-white rounded-lg text-sm hover:bg-emerald-600">
              <i data-lucide="download" class="h-4 w-4 inline mr-1"></i>
              Export List
            </button>
            <button onclick="closeReceiptsGallery()" class="px-4 py-2 border border-slate-300 rounded-lg text-slate-600 font-medium hover:bg-slate-100">
              Close
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Receipt Lightbox (for viewing full-size receipt) -->
    <div id="receiptLightbox" class="receipt-lightbox hidden" onclick="closeReceiptLightbox()">
      <button class="receipt-lightbox-close" onclick="closeReceiptLightbox()">
        <i data-lucide="x" class="h-6 w-6"></i>
      </button>
      <img id="receiptLightboxImage" src="" alt="Receipt">
      <div class="absolute bottom-6 left-1/2 -translate-x-1/2 bg-white rounded-xl p-4 shadow-xl max-w-md">
        <div id="receiptLightboxDetails" class="text-sm">
          <!-- Receipt details shown here -->
        </div>
      </div>
    </div>
    <!-- ==================== END RECEIPTS GALLERY MODAL ==================== -->

    <!-- ==================== AI AGENT WIDGET ==================== -->
    <!-- Floating Button -->
    <button id="aiWidgetBtn" class="ai-widget-btn" onclick="AIAgent.toggle()" title="AI Assistant">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 8V4H8"></path>
        <rect width="16" height="12" x="4" y="8" rx="2"></rect>
        <path d="M2 14h2"></path>
        <path d="M20 14h2"></path>
        <path d="M15 13v2"></path>
        <path d="M9 13v2"></path>
      </svg>
      <span class="notification-dot" id="aiNotificationDot"></span>
    </button>

    <!-- Chat Panel -->
    <div id="aiChatPanel" class="ai-chat-panel">
      <div class="ai-chat-header">
        <h3>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 8V4H8"></path>
            <rect width="16" height="12" x="4" y="8" rx="2"></rect>
            <path d="M2 14h2"></path>
            <path d="M20 14h2"></path>
            <path d="M15 13v2"></path>
            <path d="M9 13v2"></path>
          </svg>
          Accounting AI Assistant
        </h3>
        <div style="display:flex;gap:8px;align-items:center;">
          <button onclick="AIAgent.clearConversation()" title="Clear chat history" style="background:transparent;border:none;color:#94a3b8;cursor:pointer;padding:4px;border-radius:6px;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 6h18"></path>
              <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
              <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
            </svg>
          </button>
          <button class="close-btn" onclick="AIAgent.toggle()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
      </div>
      
      <div id="aiChatMessages" class="ai-chat-messages">
        <div class="chat-message assistant">
          üëã Hello! I'm your BwanaBet Accounting AI Assistant. I can help you with:
          <br><br>
          ‚Ä¢ <strong>Financial Analysis</strong> - Revenue, expenses, profit calculations
          <br>‚Ä¢ <strong>Navigation</strong> - Go to any tab or section
          <br>‚Ä¢ <strong>Transaction Lookup</strong> - Find any revenue or expense entry
          <br>‚Ä¢ <strong>Export Data</strong> - Export reports and transactions
          <br><br>
          How can I help you today?
        </div>
      </div>
      
      <div class="ai-chat-input-area">
        <div class="quick-actions">
          <button class="quick-action-btn" onclick="AIAgent.quickAction('What is our net profit this month?')">üí∞ Net Profit</button>
          <button class="quick-action-btn" onclick="AIAgent.quickAction('Show me the expenses breakdown')">üìä Expenses</button>
          <button class="quick-action-btn" onclick="AIAgent.quickAction('Go to reports tab')">üìà Reports</button>
          <button class="quick-action-btn" onclick="AIAgent.quickAction('Export revenue data')">üì• Export</button>
        </div>
        <div class="ai-chat-input-container">
          <textarea 
            id="aiChatInput" 
            class="ai-chat-input" 
            placeholder="Try: 'What is total revenue?' or 'Show gaming expenses' or 'Export expenses'"
            rows="1"
            onkeydown="AIAgent.handleKeydown(event)"
            oninput="AIAgent.autoResize(this)"
          ></textarea>
          <button id="aiSendBtn" class="ai-send-btn" onclick="AIAgent.send()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="22" y1="2" x2="11" y2="13"></line>
              <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
          </button>
        </div>
      </div>
    </div>
    <!-- ==================== END AI AGENT WIDGET ==================== -->

  </div>

  <script>
    // ========== CONFIGURATION ==========
    var SUPABASE_URL = 'https://blrrcnrhixckfudiojwe.supabase.co';
    var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJscnJjbnJoaXhja2Z1ZGlvandlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3Nzg0MzMsImV4cCI6MjA4MzM1NDQzM30.2DGACAZz-f_r0ieYz3hvtsOG1y-3fqTD_ENH2ZR2g1k';
    
    var App = {
      db: null,
      user: null,
      currentLang: 'en',
      displayCurrency: 'ZMW', // Currency for displaying all amounts
      charts: {},
      expenses: [],
      revenue: [],
      auditLog: [],
      exchangeRates: { USD: 27.5, EUR: 29.8 }, // How many ZMW per 1 USD/EUR
      ratesLastUpdated: null,
      currentParamsTab: null,
      expenseCategories: {
        gaming_operations: { name: 'Gaming Operations', color: '#8B5CF6', subcategories: [] },
        shop_operating: { name: 'Shop Operating Expenses', color: '#F59E0B', subcategories: [] },
        office_operations: { name: 'Office Operations', color: '#3B82F6', subcategories: [] },
        administrative: { name: 'Administrative Operations', color: '#10B981', subcategories: [] }
      },
      params: {
        // Revenue targets
        sportsTarget: 100000,
        casinoTarget: 50000,
        otherTarget: 10000,
        // Expense budgets
        gamingBudget: 50000,
        shopBudget: 30000,
        officeBudget: 20000,
        adminBudget: 25000,
        // Report settings
        projectionMonths: 1,
        fiscalYearStart: 1 // January
      }
    };

    // Currency display symbols
    var CURRENCY_SYMBOLS = {
      ZMW: 'K',
      USD: '$',
      EUR: '‚Ç¨'
    };

    // Convert ZMW amount to display currency
    function convertToDisplayCurrency(amountInZMW) {
      if (App.displayCurrency === 'ZMW') return amountInZMW;
      // Divide by exchange rate to get foreign currency amount
      return amountInZMW / (App.exchangeRates[App.displayCurrency] || 1);
    }

    // Format amount in display currency
    function formatCurrency(amountInZMW) {
      var converted = convertToDisplayCurrency(amountInZMW);
      var symbol = CURRENCY_SYMBOLS[App.displayCurrency] || 'K';
      return symbol + converted.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }

    // Format with sign (+ or -)
    function formatCurrencyWithSign(amountInZMW) {
      var converted = convertToDisplayCurrency(amountInZMW);
      var symbol = CURRENCY_SYMBOLS[App.displayCurrency] || 'K';
      var sign = converted >= 0 ? '+' : '';
      return sign + symbol + Math.abs(converted).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }

    // Change display currency
    function setDisplayCurrency(currency) {
      App.displayCurrency = currency;
      localStorage.setItem('bwanabet_acc_display_currency', currency);
      document.getElementById('displayCurrencySelect').value = currency;
      
      // Refresh all displays
      updateDashboard();
      updateRevenueDisplay();
      updateExpensesDisplay();
      updateParamDisplays();
    }

    // ========== TRANSLATIONS ==========
    var TRANSLATIONS = {
      en: {
        // General
        accountingSystem: 'Accounting System v1.0',
        signIn: 'Sign In',
        email: 'Email',
        password: 'Password',
        logout: 'Logout',
        cancel: 'Cancel',
        save: 'Save',
        add: 'Add',
        edit: 'Edit',
        delete: 'Delete',
        actions: 'Actions',
        // Navigation
        overview: 'Overview',
        revenue: 'Revenue',
        expenses: 'Expenses',
        reports: 'Reports',
        settings: 'Settings',
        accounting: 'Accounting',
        // Dashboard
        totalRevenue: 'Total Revenue',
        totalExpenses: 'Total Expenses',
        netProfit: 'Net Profit',
        transactionCount: 'Transactions',
        thisMonth: 'This month',
        exchangeRates: 'Exchange Rates',
        lastUpdated: 'Last updated',
        refresh: 'Refresh',
        revenueVsExpenses: 'Revenue vs Expenses',
        expensesByCategory: 'Expenses by Category',
        recentTransactions: 'Recent Transactions',
        viewAll: 'View All ‚Üí',
        noTransactions: 'No transactions yet',
        // Revenue
        revenueManagement: 'Revenue Management',
        sportsRevenue: 'Sports Revenue',
        casinoRevenue: 'Casino Revenue',
        otherRevenue: 'Other Revenue',
        addRevenue: 'Add Revenue Entry',
        revenueHistory: 'Revenue History',
        noRevenue: 'No revenue entries yet',
        target: 'Target',
        reference: 'Reference',
        // Expenses
        expenseManagement: 'Expense Management',
        addExpense: 'Add Expense',
        saveExpense: 'Save Expense',
        bulkUpload: 'Bulk Upload',
        bulkUploadExpenses: 'Bulk Upload Expenses',
        template: 'Template',
        dragDropFile: 'Drag & drop or click to upload',
        import: 'Import',
        noExpenses: 'No expenses recorded yet',
        gamingOperations: 'Gaming Operations',
        shopOperating: 'Shop Operating',
        officeOperations: 'Office Operations',
        administrative: 'Administrative',
        budget: 'Budget',
        vendor: 'Vendor',
        receipt: 'Receipt',
        receiptNumber: 'Receipt Number',
        paymentMethod: 'Payment Method',
        allCategories: 'All Categories',
        filter: 'Filter',
        total: 'Total',
        // Reports
        financialReports: 'Financial Reports',
        generate: 'Generate',
        projectionMethod: 'Projection Method',
        historicalAverage: 'Historical Average',
        linearTrend: 'Linear Trend',
        manualTarget: 'Manual Target',
        monthlyTrend: 'Monthly Trend',
        profitLoss: 'Profit/Loss by Month',
        revenueBySource: 'Revenue by Source',
        currencyBreakdown: 'Currency Breakdown',
        projections: '30-Day Projections',
        exportCsv: 'Export CSV',
        print: 'Print',
        // Settings
        accountingSettings: 'Accounting Settings',
        accountInfo: 'Account Information',
        administrator: 'Administrator',
        expenseSubcategories: 'Expense Subcategories',
        noSubcategories: 'No subcategories defined',
        auditLog: 'Audit Log',
        timestamp: 'Timestamp',
        user: 'User',
        action: 'Action',
        details: 'Details',
        noAuditLogs: 'No audit logs yet',
        // Parameters
        editParameters: 'Edit Parameters',
        adjustThresholds: 'Adjust thresholds and targets',
        saveAndApply: 'Save & Apply',
        revenueTargets: 'Revenue Targets',
        expenseBudgets: 'Expense Budgets',
        // Common
        date: 'Date',
        type: 'Type',
        description: 'Description',
        category: 'Category',
        subcategory: 'Subcategory',
        amount: 'Amount',
        currency: 'Currency',
        fromDate: 'From Date',
        toDate: 'To Date'
      },
      ru: {
        // General
        accountingSystem: '–°–∏—Å—Ç–µ–º–∞ –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏–∏ v1.0',
        signIn: '–í–æ–π—Ç–∏',
        email: '–≠–ª. –ø–æ—á—Ç–∞',
        password: '–ü–∞—Ä–æ–ª—å',
        logout: '–í—ã–π—Ç–∏',
        cancel: '–û—Ç–º–µ–Ω–∞',
        save: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
        add: '–î–æ–±–∞–≤–∏—Ç—å',
        edit: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å',
        delete: '–£–¥–∞–ª–∏—Ç—å',
        actions: '–î–µ–π—Å—Ç–≤–∏—è',
        // Navigation
        overview: '–û–±–∑–æ—Ä',
        revenue: '–î–æ—Ö–æ–¥—ã',
        expenses: '–†–∞—Å—Ö–æ–¥—ã',
        reports: '–û—Ç—á—ë—Ç—ã',
        settings: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏',
        accounting: '–ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è',
        // Dashboard
        totalRevenue: '–û–±—â–∏–π –¥–æ—Ö–æ–¥',
        totalExpenses: '–û–±—â–∏–µ —Ä–∞—Å—Ö–æ–¥—ã',
        netProfit: '–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å',
        transactionCount: '–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏',
        thisMonth: '–≠—Ç–æ—Ç –º–µ—Å—è—Ü',
        exchangeRates: '–ö—É—Ä—Å—ã –≤–∞–ª—é—Ç',
        lastUpdated: '–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ',
        refresh: '–û–±–Ω–æ–≤–∏—Ç—å',
        revenueVsExpenses: '–î–æ—Ö–æ–¥—ã vs –†–∞—Å—Ö–æ–¥—ã',
        expensesByCategory: '–†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º',
        recentTransactions: '–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏',
        viewAll: '–°–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ ‚Üí',
        noTransactions: '–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–æ–∫–∞ –Ω–µ—Ç',
        // Revenue
        revenueManagement: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Ö–æ–¥–∞–º–∏',
        sportsRevenue: '–î–æ—Ö–æ–¥ –æ—Ç —Å–ø–æ—Ä—Ç–∞',
        casinoRevenue: '–î–æ—Ö–æ–¥ –æ—Ç –∫–∞–∑–∏–Ω–æ',
        otherRevenue: '–ü—Ä–æ—á–∏–µ –¥–æ—Ö–æ–¥—ã',
        addRevenue: '–î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥',
        revenueHistory: '–ò—Å—Ç–æ—Ä–∏—è –¥–æ—Ö–æ–¥–æ–≤',
        noRevenue: '–ó–∞–ø–∏—Å–µ–π –æ –¥–æ—Ö–æ–¥–∞—Ö –ø–æ–∫–∞ –Ω–µ—Ç',
        target: '–¶–µ–ª—å',
        reference: '–ù–æ–º–µ—Ä',
        // Expenses
        expenseManagement: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞–º–∏',
        addExpense: '–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥',
        saveExpense: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å—Ö–æ–¥',
        bulkUpload: '–ú–∞—Å—Å–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞',
        bulkUploadExpenses: '–ú–∞—Å—Å–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤',
        template: '–®–∞–±–ª–æ–Ω',
        dragDropFile: '–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏',
        import: '–ò–º–ø–æ—Ä—Ç',
        noExpenses: '–†–∞—Å—Ö–æ–¥–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç',
        gamingOperations: '–ò–≥—Ä–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏',
        shopOperating: '–û–ø–µ—Ä–∞—Ü–∏–∏ –º–∞–≥–∞–∑–∏–Ω–∞',
        officeOperations: '–û—Ñ–∏—Å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏',
        administrative: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ',
        budget: '–ë—é–¥–∂–µ—Ç',
        vendor: '–ü–æ—Å—Ç–∞–≤—â–∏–∫',
        receipt: '–ß–µ–∫',
        receiptNumber: '–ù–æ–º–µ—Ä —á–µ–∫–∞',
        paymentMethod: '–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã',
        allCategories: '–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏',
        filter: '–§–∏–ª—å—Ç—Ä',
        total: '–ò—Ç–æ–≥–æ',
        // Reports
        financialReports: '–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ—Ç—á—ë—Ç—ã',
        generate: '–°–æ–∑–¥–∞—Ç—å',
        projectionMethod: '–ú–µ—Ç–æ–¥ –ø—Ä–æ–≥–Ω–æ–∑–∞',
        historicalAverage: '–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π —Å—Ä–µ–¥–Ω–∏–π',
        linearTrend: '–õ–∏–Ω–µ–π–Ω—ã–π —Ç—Ä–µ–Ω–¥',
        manualTarget: '–†—É—á–Ω–∞—è —Ü–µ–ª—å',
        monthlyTrend: '–ú–µ—Å—è—á–Ω—ã–π —Ç—Ä–µ–Ω–¥',
        profitLoss: '–ü—Ä–∏–±—ã–ª—å/–£–±—ã—Ç–æ–∫ –ø–æ –º–µ—Å—è—Ü–∞–º',
        revenueBySource: '–î–æ—Ö–æ–¥—ã –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º',
        currencyBreakdown: '–†–∞–∑–±–∏–≤–∫–∞ –ø–æ –≤–∞–ª—é—Ç–∞–º',
        projections: '–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 30 –¥–Ω–µ–π',
        exportCsv: '–≠–∫—Å–ø–æ—Ä—Ç CSV',
        print: '–ü–µ—á–∞—Ç—å',
        // Settings
        accountingSettings: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏–∏',
        accountInfo: '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–∫–∫–∞—É–Ω—Ç–µ',
        administrator: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
        expenseSubcategories: '–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤',
        noSubcategories: '–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã',
        auditLog: '–ñ—É—Ä–Ω–∞–ª –∞—É–¥–∏—Ç–∞',
        timestamp: '–í—Ä–µ–º—è',
        user: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
        action: '–î–µ–π—Å—Ç–≤–∏–µ',
        details: '–î–µ—Ç–∞–ª–∏',
        noAuditLogs: '–ó–∞–ø–∏—Å–µ–π –∞—É–¥–∏—Ç–∞ –ø–æ–∫–∞ –Ω–µ—Ç',
        // Parameters
        editParameters: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã',
        adjustThresholds: '–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ü–µ–ª–µ–π –∏ –ø–æ—Ä–æ–≥–æ–≤',
        saveAndApply: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å',
        revenueTargets: '–¶–µ–ª–∏ –ø–æ –¥–æ—Ö–æ–¥–∞–º',
        expenseBudgets: '–ë—é–¥–∂–µ—Ç—ã —Ä–∞—Å—Ö–æ–¥–æ–≤',
        // Common
        date: '–î–∞—Ç–∞',
        type: '–¢–∏–ø',
        description: '–û–ø–∏—Å–∞–Ω–∏–µ',
        category: '–ö–∞—Ç–µ–≥–æ—Ä–∏—è',
        subcategory: '–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è',
        amount: '–°—É–º–º–∞',
        currency: '–í–∞–ª—é—Ç–∞',
        fromDate: '–° –¥–∞—Ç—ã',
        toDate: '–ü–æ –¥–∞—Ç—É'
      }
    };

    // ========== INITIALIZATION ==========
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('Initializing app...');
      
      try {
        App.db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('Supabase client created successfully');
      } catch (e) {
        console.error('Failed to create Supabase client:', e);
        alert('Failed to connect to database: ' + e.message);
        return;
      }
      
      lucide.createIcons();
      loadParams();
      
      // Auth listener
      App.db.auth.onAuthStateChange((event, session) => {
        console.log('Auth state changed:', event);
        if (event === 'SIGNED_IN' && session) {
          App.user = session.user;
          showMainApp();
        } else if (event === 'SIGNED_OUT') {
          showLoginScreen();
        }
      });
      
      // Check existing session
      try {
        var { data: { session } } = await App.db.auth.getSession();
        console.log('Existing session:', session ? 'Found' : 'None');
        if (session) {
          App.user = session.user;
          showMainApp();
        }
      } catch (e) {
        console.error('Error checking session:', e);
      }
      
      // Login form
      document.getElementById('loginBtn').addEventListener('click', handleLogin);
      document.getElementById('loginPassword').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') handleLogin();
      });
      
      // Login language selector
      document.getElementById('loginLanguageSelect').addEventListener('change', function(e) {
        setLanguage(e.target.value);
      });
      
      console.log('App initialization complete');
    });

    // ========== AUTH FUNCTIONS ==========
    async function handleLogin() {
      var email = document.getElementById('loginEmail').value;
      var password = document.getElementById('loginPassword').value;
      var btn = document.getElementById('loginBtn');
      var errorDiv = document.getElementById('loginError');
      
      console.log('Login attempt for:', email);
      
      if (!email || !password) {
        errorDiv.textContent = 'Please enter email and password';
        errorDiv.classList.remove('hidden');
        return;
      }
      
      btn.disabled = true;
      btn.innerHTML = '<svg class="spinner h-5 w-5" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg> ' + t('signIn') + '...';
      errorDiv.classList.add('hidden');
      
      try {
        console.log('Calling Supabase signInWithPassword...');
        var { data, error } = await App.db.auth.signInWithPassword({ email, password });
        
        if (error) {
          console.error('Login error:', error);
          throw error;
        }
        
        console.log('Login successful:', data);
      } catch (e) {
        console.error('Login catch error:', e);
        errorDiv.textContent = e.message || 'Login failed. Please try again.';
        errorDiv.classList.remove('hidden');
        btn.disabled = false;
        btn.innerHTML = '<i data-lucide="log-in" class="h-5 w-5"></i> ' + t('signIn');
        lucide.createIcons();
      }
    }

    function showLoginScreen() {
      document.getElementById('loginScreen').classList.remove('hidden');
      document.getElementById('mainApp').classList.add('hidden');
    }

    async function showMainApp() {
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');
      
      if (App.user) {
        document.getElementById('userEmail').textContent = App.user.email;
        document.getElementById('settingsUserEmail').textContent = App.user.email;
      }
      
      setupEventListeners();
      applyTranslations();
      loadData();
      
      // Initialize receipts store (Supabase-backed)
      setTimeout(() => ReceiptsStore.init(), 1000);
    }

    // ========== EVENT LISTENERS ==========
    function setupEventListeners() {
      // Logout
      document.getElementById('logoutBtn').addEventListener('click', () => App.db.auth.signOut());
      
      // Language selector
      document.getElementById('languageSelect').value = App.currentLang;
      document.getElementById('languageSelect').addEventListener('change', function(e) {
        setLanguage(e.target.value);
      });
      
      // Display Currency selector
      var savedCurrency = localStorage.getItem('bwanabet_acc_display_currency');
      if (savedCurrency) App.displayCurrency = savedCurrency;
      document.getElementById('displayCurrencySelect').value = App.displayCurrency;
      document.getElementById('displayCurrencySelect').addEventListener('change', function(e) {
        setDisplayCurrency(e.target.value);
      });
      
      // Tab switching
      ['overview', 'revenue', 'expenses', 'reports', 'settings'].forEach(tab => {
        document.getElementById('tab-' + tab).addEventListener('click', () => switchTab(tab));
      });
      
      // Keyboard shortcuts
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeAddExpenseModal();
          closeBulkUploadModal();
          closeParamsModal();
        }
      });
      
      lucide.createIcons();
    }

    // ========== TAB SWITCHING ==========
    function switchTab(tabName) {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.classList.add('text-slate-300');
      });
      
      var activeBtn = document.getElementById('tab-' + tabName);
      if (activeBtn) activeBtn.classList.add('active');
      
      document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
      var activeContent = document.getElementById('content-' + tabName);
      if (activeContent) activeContent.classList.remove('hidden');
      
      lucide.createIcons();
    }

    // ========== LANGUAGE FUNCTIONS ==========
    function t(key) {
      return TRANSLATIONS[App.currentLang][key] || TRANSLATIONS['en'][key] || key;
    }

    function setLanguage(lang) {
      App.currentLang = lang;
      localStorage.setItem('bwanabet_acc_lang', lang);
      document.getElementById('languageSelect').value = lang;
      document.getElementById('loginLanguageSelect').value = lang;
      applyTranslations();
    }

    function applyTranslations() {
      document.querySelectorAll('[data-translate]').forEach(el => {
        var key = el.getAttribute('data-translate');
        var translation = t(key);
        if (translation) el.textContent = translation;
      });
    }

    // ========== DATA LOADING ==========
    async function loadData() {
      showLoading('Loading data...');
      
      await refreshExchangeRates();
      
      try {
        var { data: expenses } = await App.db.from('acc_expenses').select('*').order('date', { ascending: false });
        if (expenses) App.expenses = expenses;
        
        var { data: revenue } = await App.db.from('acc_revenue').select('*').order('date', { ascending: false });
        if (revenue) App.revenue = revenue;
        
        var { data: audit } = await App.db.from('acc_audit_log').select('*').order('timestamp', { ascending: false }).limit(50);
        if (audit) App.auditLog = audit;
      } catch (e) {
        console.log('Accounting tables not yet created:', e.message);
      }
      
      updateDashboard();
      updateRevenueDisplay();
      updateExpensesDisplay();
      updateAuditLog();
      hideLoading();
    }

    // ========== EXCHANGE RATES ==========
    async function refreshExchangeRates() {
      try {
        var response = await fetch('https://open.er-api.com/v6/latest/USD');
        var data = await response.json();
        if (data && data.rates) {
          App.exchangeRates = {
            USD: data.rates.ZMW || 27.5,
            EUR: (data.rates.ZMW || 27.5) / (data.rates.EUR || 0.92)
          };
          App.ratesLastUpdated = new Date();
        }
      } catch (e) {
        console.log('Could not fetch exchange rates:', e.message);
      }
      
      document.getElementById('rate-usd').textContent = App.exchangeRates.USD.toFixed(2);
      document.getElementById('rate-eur').textContent = App.exchangeRates.EUR.toFixed(2);
      document.getElementById('rates-updated').textContent = App.ratesLastUpdated ? App.ratesLastUpdated.toLocaleString() : 'Using cached rates';
    }

    function convertToBase(amount, currency) {
      if (currency === 'ZMW') return amount;
      return amount * App.exchangeRates[currency];
    }

    // ========== DASHBOARD ==========
    function updateDashboard() {
      var totalRevenue = App.revenue.reduce((sum, r) => sum + (parseFloat(r.amount_base) || parseFloat(r.amount) || 0), 0);
      var totalExpenses = App.expenses.reduce((sum, e) => sum + (parseFloat(e.amount_base) || parseFloat(e.amount) || 0), 0);
      var netProfit = totalRevenue - totalExpenses;
      var transactionCount = App.revenue.length + App.expenses.length;
      
      document.getElementById('total-revenue').textContent = formatCurrency(totalRevenue);
      document.getElementById('total-expenses').textContent = formatCurrency(totalExpenses);
      document.getElementById('net-profit').textContent = formatCurrency(netProfit);
      document.getElementById('net-profit').className = 'text-2xl font-bold ' + (netProfit >= 0 ? 'text-blue-600' : 'text-red-600');
      document.getElementById('transaction-count').textContent = transactionCount;
      
      updateOverviewCharts();
      updateRecentTransactions();
    }

    function updateOverviewCharts() {
      // Revenue vs Expenses Chart
      var ctx1 = document.getElementById('revenueExpensesChart');
      if (ctx1) {
        if (App.charts['revExp']) App.charts['revExp'].destroy();
        
        var chartType = document.getElementById('chartTypeRevExp').value;
        var labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
        var revenueData = labels.map(() => Math.random() * 50000 + 20000);
        var expenseData = labels.map(() => Math.random() * 30000 + 10000);
        
        App.charts['revExp'] = new Chart(ctx1, {
          type: chartType,
          data: {
            labels: labels,
            datasets: [
              { label: t('revenue'), data: revenueData, borderColor: '#10B981', backgroundColor: chartType === 'line' ? 'rgba(16, 185, 129, 0.1)' : '#10B981', fill: chartType === 'line', tension: 0.4 },
              { label: t('expenses'), data: expenseData, borderColor: '#EF4444', backgroundColor: chartType === 'line' ? 'rgba(239, 68, 68, 0.1)' : '#EF4444', fill: chartType === 'line', tension: 0.4 }
            ]
          },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
      }
      
      // Category Pie Chart
      var ctx2 = document.getElementById('categoryPieChart');
      if (ctx2) {
        if (App.charts['catPie']) App.charts['catPie'].destroy();
        
        var chartType = document.getElementById('chartTypeCat').value;
        var catData = calculateExpensesByCategory();
        
        App.charts['catPie'] = new Chart(ctx2, {
          type: chartType,
          data: {
            labels: [t('gamingOperations'), t('shopOperating'), t('officeOperations'), t('administrative')],
            datasets: [{
              data: [catData.gaming || 1, catData.shop || 1, catData.office || 1, catData.admin || 1],
              backgroundColor: ['#8B5CF6', '#F59E0B', '#3B82F6', '#10B981']
            }]
          },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
      }
    }

    function calculateExpensesByCategory() {
      var result = { gaming: 0, shop: 0, office: 0, admin: 0 };
      App.expenses.forEach(e => {
        var amount = parseFloat(e.amount_base) || parseFloat(e.amount) || 0;
        if (e.category_id === 'gaming_operations') result.gaming += amount;
        else if (e.category_id === 'shop_operating') result.shop += amount;
        else if (e.category_id === 'office_operations') result.office += amount;
        else if (e.category_id === 'administrative') result.admin += amount;
      });
      return result;
    }

    function updateRecentTransactions() {
      var tbody = document.getElementById('recentTransactionsBody');
      var transactions = [];
      
      App.expenses.slice(0, 5).forEach(e => {
        transactions.push({
          date: e.date,
          type: 'expense',
          description: e.description || e.vendor || 'Expense',
          category: getCategoryName(e.category_id),
          amountBase: -(parseFloat(e.amount_base) || parseFloat(e.amount) || 0)
        });
      });
      
      App.revenue.slice(0, 5).forEach(r => {
        transactions.push({
          date: r.date,
          type: 'revenue',
          description: r.description || r.type || 'Revenue',
          category: r.type || 'Revenue',
          amountBase: parseFloat(r.amount_base) || parseFloat(r.amount) || 0
        });
      });
      
      transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
      transactions = transactions.slice(0, 5);
      
      if (transactions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-slate-400">' + t('noTransactions') + '</td></tr>';
        return;
      }
      
      tbody.innerHTML = transactions.map(tx => {
        var amountClass = tx.amountBase >= 0 ? 'text-emerald-600' : 'text-red-600';
        var amountStr = formatCurrencyWithSign(tx.amountBase);
        var typeClass = tx.type === 'revenue' ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700';
        return '<tr class="border-b hover:bg-slate-50">' +
          '<td class="px-4 py-3 text-sm">' + (tx.date || '-') + '</td>' +
          '<td class="px-4 py-3"><span class="px-2 py-1 rounded-full text-xs font-medium ' + typeClass + '">' + tx.type + '</span></td>' +
          '<td class="px-4 py-3 text-sm">' + tx.description + '</td>' +
          '<td class="px-4 py-3 text-sm">' + tx.category + '</td>' +
          '<td class="px-4 py-3 text-sm text-right font-medium ' + amountClass + '">' + amountStr + '</td>' +
          '</tr>';
      }).join('');
    }

    function getCategoryName(key) {
      var names = {
        gaming_operations: t('gamingOperations'),
        shop_operating: t('shopOperating'),
        office_operations: t('officeOperations'),
        administrative: t('administrative')
      };
      return names[key] || key || '-';
    }

    // ========== REVENUE FUNCTIONS ==========
    function updateRevenueDisplay() {
      var sports = App.revenue.filter(r => r.type === 'sports').reduce((sum, r) => sum + (parseFloat(r.amount_base) || parseFloat(r.amount) || 0), 0);
      var casino = App.revenue.filter(r => r.type === 'casino').reduce((sum, r) => sum + (parseFloat(r.amount_base) || parseFloat(r.amount) || 0), 0);
      var other = App.revenue.filter(r => r.type !== 'sports' && r.type !== 'casino').reduce((sum, r) => sum + (parseFloat(r.amount_base) || parseFloat(r.amount) || 0), 0);
      
      document.getElementById('sports-revenue').textContent = formatCurrency(sports);
      document.getElementById('casino-revenue').textContent = formatCurrency(casino);
      document.getElementById('other-revenue').textContent = formatCurrency(other);
      
      updateRevenueTable();
    }

    function updateRevenueTable() {
      var tbody = document.getElementById('revenueTableBody');
      
      if (App.revenue.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-slate-400">' + t('noRevenue') + '</td></tr>';
        return;
      }
      
      tbody.innerHTML = App.revenue.map(r => {
        var amountBase = parseFloat(r.amount_base) || parseFloat(r.amount) || 0;
        return '<tr class="border-b hover:bg-slate-50">' +
          '<td class="px-4 py-3 text-sm">' + (r.date || '-') + '</td>' +
          '<td class="px-4 py-3"><span class="px-2 py-1 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700">' + (r.type || '-') + '</span></td>' +
          '<td class="px-4 py-3 text-sm">' + (r.description || '-') + '</td>' +
          '<td class="px-4 py-3 text-sm">' + (r.reference_number || '-') + '</td>' +
          '<td class="px-4 py-3 text-sm text-right font-medium text-emerald-600">' + formatCurrency(amountBase) + '</td>' +
          '<td class="px-4 py-3 text-center"><button onclick="deleteRevenue(\'' + r.id + '\')" class="text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="h-4 w-4"></i></button></td>' +
          '</tr>';
      }).join('');
      
      lucide.createIcons();
    }

    async function addRevenue() {
      var revenue = {
        date: document.getElementById('revDate').value || new Date().toISOString().split('T')[0],
        type: document.getElementById('revType').value,
        amount: parseFloat(document.getElementById('revAmount').value) || 0,
        currency: document.getElementById('revCurrency').value,
        description: document.getElementById('revDescription').value,
        reference_number: document.getElementById('revReference').value,
        created_by: App.user?.id
      };
      
      if (revenue.currency !== 'ZMW') {
        revenue.amount_base = convertToBase(revenue.amount, revenue.currency);
        revenue.exchange_rate = App.exchangeRates[revenue.currency];
      } else {
        revenue.amount_base = revenue.amount;
        revenue.exchange_rate = 1;
      }
      
      try {
        var { data, error } = await App.db.from('acc_revenue').insert([revenue]).select();
        if (error) throw error;
        
        App.revenue.unshift(data[0]);
        await logAudit('revenue_created', 'revenue', data[0].id, null, revenue);
        
        document.getElementById('revAmount').value = '';
        document.getElementById('revDescription').value = '';
        document.getElementById('revReference').value = '';
        
        updateDashboard();
        updateRevenueDisplay();
        showNotification(t('addRevenue') + ' ‚úì', 'success');
      } catch (e) {
        console.error('Error saving revenue:', e);
        showNotification('Error: ' + e.message, 'error');
      }
    }

    async function deleteRevenue(id) {
      if (!confirm('Delete this revenue entry?')) return;
      
      try {
        var { error } = await App.db.from('acc_revenue').delete().eq('id', id);
        if (error) throw error;
        
        App.revenue = App.revenue.filter(r => r.id !== id);
        await logAudit('revenue_deleted', 'revenue', id, null, null);
        
        updateDashboard();
        updateRevenueDisplay();
        showNotification('Revenue deleted', 'success');
      } catch (e) {
        showNotification('Error: ' + e.message, 'error');
      }
    }

    // ========== EXPENSE FUNCTIONS ==========
    // Current selected expense category
    var selectedExpenseCategory = 'all';
    var filteredExpenses = [];

    function updateExpensesDisplay() {
      var catData = calculateExpensesByCategory();
      
      // Update category tab counts
      var allCount = App.expenses.length;
      var gamingCount = App.expenses.filter(e => e.category_id === 'gaming_operations').length;
      var shopCount = App.expenses.filter(e => e.category_id === 'shop_operating').length;
      var officeCount = App.expenses.filter(e => e.category_id === 'office_operations').length;
      var adminCount = App.expenses.filter(e => e.category_id === 'administrative').length;
      
      document.getElementById('expCount-all').textContent = allCount;
      document.getElementById('expCount-gaming_operations').textContent = gamingCount;
      document.getElementById('expCount-shop_operating').textContent = shopCount;
      document.getElementById('expCount-office_operations').textContent = officeCount;
      document.getElementById('expCount-administrative').textContent = adminCount;
      
      // Apply filters
      filterExpenses();
    }

    function selectExpenseCategory(category) {
      selectedExpenseCategory = category;
      
      // Update tab styles
      document.querySelectorAll('.exp-cat-tab').forEach(tab => {
        tab.classList.remove('active');
        tab.classList.add('border-transparent');
      });
      
      var activeTab = document.getElementById('expCatTab-' + category);
      if (activeTab) {
        activeTab.classList.add('active');
        activeTab.classList.remove('border-transparent');
      }
      
      // Show/hide category detail card
      var detailCard = document.getElementById('categoryDetailCard');
      if (category === 'all') {
        detailCard.classList.add('hidden');
      } else {
        detailCard.classList.remove('hidden');
        updateCategoryDetailCard(category);
      }
      
      filterExpenses();
    }

    function updateCategoryDetailCard(category) {
      var catNames = {
        gaming_operations: { name: t('gamingOperations'), color: 'text-purple-600', budget: App.params.gamingBudget },
        shop_operating: { name: t('shopOperating'), color: 'text-amber-600', budget: App.params.shopBudget },
        office_operations: { name: t('officeOperations'), color: 'text-blue-600', budget: App.params.officeBudget },
        administrative: { name: t('administrative'), color: 'text-emerald-600', budget: App.params.adminBudget }
      };
      
      var catInfo = catNames[category] || { name: category, color: 'text-slate-600', budget: 0 };
      var catTotal = App.expenses.filter(e => e.category_id === category).reduce((sum, e) => sum + (parseFloat(e.amount_base) || parseFloat(e.amount) || 0), 0);
      
      document.getElementById('selectedCategoryName').textContent = catInfo.name;
      document.getElementById('selectedCategoryName').className = 'font-bold text-lg ' + catInfo.color;
      document.getElementById('selectedCategoryDesc').textContent = App.expenses.filter(e => e.category_id === category).length + ' expenses in this category';
      document.getElementById('selectedCategoryTotal').textContent = formatCurrency(catTotal);
      document.getElementById('selectedCategoryTotal').className = 'text-2xl font-bold ' + catInfo.color;
      document.getElementById('selectedCategoryBudget').textContent = formatCurrency(catInfo.budget);
    }

    function filterExpenses() {
      var fromDate = document.getElementById('expFilterFrom').value;
      var toDate = document.getElementById('expFilterTo').value;
      var currency = document.getElementById('expFilterCurrency').value;
      
      filteredExpenses = App.expenses.filter(e => {
        // Category filter (from tabs)
        if (selectedExpenseCategory !== 'all' && e.category_id !== selectedExpenseCategory) {
          return false;
        }
        
        // Date filters
        if (fromDate && e.date < fromDate) return false;
        if (toDate && e.date > toDate) return false;
        
        // Currency filter
        if (currency && e.currency !== currency) return false;
        
        return true;
      });
      
      updateExpensesTable();
    }

    function clearExpenseFilters() {
      document.getElementById('expFilterFrom').value = '';
      document.getElementById('expFilterTo').value = '';
      document.getElementById('expFilterCurrency').value = '';
      selectedExpenseCategory = 'all';
      
      // Reset tab styles
      document.querySelectorAll('.exp-cat-tab').forEach(tab => {
        tab.classList.remove('active');
        tab.classList.add('border-transparent');
      });
      document.getElementById('expCatTab-all').classList.add('active');
      document.getElementById('expCatTab-all').classList.remove('border-transparent');
      document.getElementById('categoryDetailCard').classList.add('hidden');
      
      filterExpenses();
      showNotification('Filters cleared', 'success');
    }

    function updateExpensesTable() {
      var tbody = document.getElementById('expensesTableBody');
      var total = 0;
      var expenses = filteredExpenses.length > 0 || App.expenses.length === 0 ? filteredExpenses : App.expenses;
      
      if (expenses.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-slate-400">' + t('noExpenses') + '</td></tr>';
        document.getElementById('expensesCount').textContent = '0 ' + t('expenses');
        document.getElementById('expensesTotal').textContent = formatCurrency(0);
        return;
      }
      
      tbody.innerHTML = expenses.map(e => {
        var amountBase = parseFloat(e.amount_base) || parseFloat(e.amount) || 0;
        total += amountBase;
        var catColors = {
          gaming_operations: 'bg-purple-100 text-purple-700',
          shop_operating: 'bg-amber-100 text-amber-700',
          office_operations: 'bg-blue-100 text-blue-700',
          administrative: 'bg-emerald-100 text-emerald-700'
        };
        
        return '<tr class="border-b hover:bg-slate-50">' +
          '<td class="px-4 py-3 text-sm">' + (e.date || '-') + '</td>' +
          '<td class="px-4 py-3"><span class="px-2 py-1 rounded-full text-xs font-medium ' + (catColors[e.category_id] || 'bg-slate-100') + '">' + getCategoryName(e.category_id) + '</span></td>' +
          '<td class="px-4 py-3 text-sm">' + (e.vendor || '-') + '</td>' +
          '<td class="px-4 py-3 text-sm">' + (e.description || '-') + '</td>' +
          '<td class="px-4 py-3 text-sm text-right font-medium text-red-600">' + formatCurrency(amountBase) + '</td>' +
          '<td class="px-4 py-3 text-center">' + (e.receipt_number ? '<span class="text-slate-500">' + e.receipt_number + '</span>' : '-') + '</td>' +
          '<td class="px-4 py-3 text-center"><button onclick="deleteExpense(\'' + e.id + '\')" class="text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="h-4 w-4"></i></button></td>' +
          '</tr>';
      }).join('');
      
      document.getElementById('expensesCount').textContent = expenses.length + ' ' + t('expenses');
      document.getElementById('expensesTotal').textContent = formatCurrency(total);
      
      lucide.createIcons();
    }

    // ========== EXPORT FUNCTIONS ==========
    function toggleExportDropdown() {
      var dropdown = document.getElementById('exportDropdown');
      dropdown.classList.toggle('hidden');
      lucide.createIcons();
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      var container = document.getElementById('exportDropdownContainer');
      var dropdown = document.getElementById('exportDropdown');
      if (container && dropdown && !container.contains(e.target)) {
        dropdown.classList.add('hidden');
      }
    });

    function exportExpenses(format) {
      var expenses = filteredExpenses.length > 0 ? filteredExpenses : App.expenses;
      
      if (expenses.length === 0) {
        showNotification('No expenses to export', 'error');
        return;
      }
      
      var filename = 'expenses_' + (selectedExpenseCategory !== 'all' ? selectedExpenseCategory + '_' : '') + new Date().toISOString().split('T')[0];
      
      if (format === 'csv') {
        exportToCSV(expenses, filename);
      } else if (format === 'excel') {
        exportToExcel(expenses, filename);
      } else if (format === 'json') {
        exportToJSON(expenses, filename);
      }
      
      document.getElementById('exportDropdown').classList.add('hidden');
    }

    function exportToCSV(data, filename) {
      var headers = ['Date', 'Category', 'Vendor', 'Description', 'Amount', 'Currency', 'Amount (ZMW)', 'Receipt Number', 'Payment Method'];
      var csv = headers.join(',') + '\n';
      
      data.forEach(e => {
        var row = [
          e.date || '',
          getCategoryName(e.category_id),
          '"' + (e.vendor || '').replace(/"/g, '""') + '"',
          '"' + (e.description || '').replace(/"/g, '""') + '"',
          e.amount || 0,
          e.currency || 'ZMW',
          e.amount_base || e.amount || 0,
          e.receipt_number || '',
          e.payment_method || ''
        ];
        csv += row.join(',') + '\n';
      });
      
      downloadFile(csv, filename + '.csv', 'text/csv');
      showNotification('Exported ' + data.length + ' expenses to CSV', 'success');
    }

    function exportToExcel(data, filename) {
      // Create Excel-compatible XML
      var xml = '<?xml version="1.0"?>\n';
      xml += '<?mso-application progid="Excel.Sheet"?>\n';
      xml += '<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"\n';
      xml += ' xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">\n';
      xml += '<Worksheet ss:Name="Expenses">\n<Table>\n';
      
      // Headers
      xml += '<Row>\n';
      ['Date', 'Category', 'Vendor', 'Description', 'Amount', 'Currency', 'Amount (ZMW)', 'Receipt Number', 'Payment Method'].forEach(h => {
        xml += '<Cell><Data ss:Type="String">' + h + '</Data></Cell>\n';
      });
      xml += '</Row>\n';
      
      // Data rows
      data.forEach(e => {
        xml += '<Row>\n';
        xml += '<Cell><Data ss:Type="String">' + (e.date || '') + '</Data></Cell>\n';
        xml += '<Cell><Data ss:Type="String">' + getCategoryName(e.category_id) + '</Data></Cell>\n';
        xml += '<Cell><Data ss:Type="String">' + escapeXML(e.vendor || '') + '</Data></Cell>\n';
        xml += '<Cell><Data ss:Type="String">' + escapeXML(e.description || '') + '</Data></Cell>\n';
        xml += '<Cell><Data ss:Type="Number">' + (e.amount || 0) + '</Data></Cell>\n';
        xml += '<Cell><Data ss:Type="String">' + (e.currency || 'ZMW') + '</Data></Cell>\n';
        xml += '<Cell><Data ss:Type="Number">' + (e.amount_base || e.amount || 0) + '</Data></Cell>\n';
        xml += '<Cell><Data ss:Type="String">' + (e.receipt_number || '') + '</Data></Cell>\n';
        xml += '<Cell><Data ss:Type="String">' + (e.payment_method || '') + '</Data></Cell>\n';
        xml += '</Row>\n';
      });
      
      xml += '</Table>\n</Worksheet>\n</Workbook>';
      
      downloadFile(xml, filename + '.xls', 'application/vnd.ms-excel');
      showNotification('Exported ' + data.length + ' expenses to Excel', 'success');
    }

    function exportToJSON(data, filename) {
      var exportData = {
        exportDate: new Date().toISOString(),
        category: selectedExpenseCategory === 'all' ? 'All Categories' : getCategoryName(selectedExpenseCategory),
        totalRecords: data.length,
        totalAmount: data.reduce((sum, e) => sum + (parseFloat(e.amount_base) || parseFloat(e.amount) || 0), 0),
        currency: App.displayCurrency,
        expenses: data.map(e => ({
          date: e.date,
          category: getCategoryName(e.category_id),
          category_id: e.category_id,
          vendor: e.vendor,
          description: e.description,
          amount: e.amount,
          currency: e.currency,
          amount_base_zmw: e.amount_base || e.amount,
          receipt_number: e.receipt_number,
          payment_method: e.payment_method
        }))
      };
      
      var json = JSON.stringify(exportData, null, 2);
      downloadFile(json, filename + '.json', 'application/json');
      showNotification('Exported ' + data.length + ' expenses to JSON', 'success');
    }

    function escapeXML(str) {
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function downloadFile(content, filename, mimeType) {
      var blob = new Blob([content], { type: mimeType });
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // ========== REVENUE EXPORT FUNCTIONS ==========
    function toggleRevenueExportDropdown() {
      var dropdown = document.getElementById('revenueExportDropdown');
      dropdown.classList.toggle('hidden');
      lucide.createIcons();
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      var container = document.getElementById('revenueExportDropdownContainer');
      var dropdown = document.getElementById('revenueExportDropdown');
      if (container && dropdown && !container.contains(e.target)) {
        dropdown.classList.add('hidden');
      }
    });

    function exportRevenue(format) {
      if (App.revenue.length === 0) {
        showNotification('No revenue to export', 'error');
        return;
      }
      
      var filename = 'revenue_' + new Date().toISOString().split('T')[0];
      
      if (format === 'csv') {
        exportRevenueToCSV(App.revenue, filename);
      } else if (format === 'excel') {
        exportRevenueToExcel(App.revenue, filename);
      } else if (format === 'json') {
        exportRevenueToJSON(App.revenue, filename);
      }
      
      document.getElementById('revenueExportDropdown').classList.add('hidden');
    }

    function exportRevenueToCSV(data, filename) {
      var headers = ['Date', 'Type', 'Description', 'Reference', 'Amount', 'Currency', 'Amount (ZMW)'];
      var csv = headers.join(',') + '\n';
      
      data.forEach(r => {
        var row = [
          r.date || '',
          r.type || '',
          '"' + (r.description || '').replace(/"/g, '""') + '"',
          r.reference_number || '',
          r.amount || 0,
          r.currency || 'ZMW',
          r.amount_base || r.amount || 0
        ];
        csv += row.join(',') + '\n';
      });
      
      downloadFile(csv, filename + '.csv', 'text/csv');
      showNotification('Exported ' + data.length + ' revenue records to CSV', 'success');
    }

    function exportRevenueToExcel(data, filename) {
      var xml = '<?xml version="1.0"?>\n';
      xml += '<?mso-application progid="Excel.Sheet"?>\n';
      xml += '<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"\n';
      xml += ' xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">\n';
      xml += '<Worksheet ss:Name="Revenue">\n<Table>\n';
      
      // Headers
      xml += '<Row>\n';
      ['Date', 'Type', 'Description', 'Reference', 'Amount', 'Currency', 'Amount (ZMW)'].forEach(h => {
        xml += '<Cell><Data ss:Type="String">' + h + '</Data></Cell>\n';
      });
      xml += '</Row>\n';
      
      // Data rows
      data.forEach(r => {
        xml += '<Row>\n';
        xml += '<Cell><Data ss:Type="String">' + (r.date || '') + '</Data></Cell>\n';
        xml += '<Cell><Data ss:Type="String">' + (r.type || '') + '</Data></Cell>\n';
        xml += '<Cell><Data ss:Type="String">' + escapeXML(r.description || '') + '</Data></Cell>\n';
        xml += '<Cell><Data ss:Type="String">' + (r.reference_number || '') + '</Data></Cell>\n';
        xml += '<Cell><Data ss:Type="Number">' + (r.amount || 0) + '</Data></Cell>\n';
        xml += '<Cell><Data ss:Type="String">' + (r.currency || 'ZMW') + '</Data></Cell>\n';
        xml += '<Cell><Data ss:Type="Number">' + (r.amount_base || r.amount || 0) + '</Data></Cell>\n';
        xml += '</Row>\n';
      });
      
      xml += '</Table>\n</Worksheet>\n</Workbook>';
      
      downloadFile(xml, filename + '.xls', 'application/vnd.ms-excel');
      showNotification('Exported ' + data.length + ' revenue records to Excel', 'success');
    }

    function exportRevenueToJSON(data, filename) {
      var exportData = {
        exportDate: new Date().toISOString(),
        totalRecords: data.length,
        totalAmount: data.reduce((sum, r) => sum + (parseFloat(r.amount_base) || parseFloat(r.amount) || 0), 0),
        currency: App.displayCurrency,
        revenue: data.map(r => ({
          date: r.date,
          type: r.type,
          description: r.description,
          reference_number: r.reference_number,
          amount: r.amount,
          currency: r.currency,
          amount_base_zmw: r.amount_base || r.amount
        }))
      };
      
      var json = JSON.stringify(exportData, null, 2);
      downloadFile(json, filename + '.json', 'application/json');
      showNotification('Exported ' + data.length + ' revenue records to JSON', 'success');
    }

    function showAddExpenseModal() {
      document.getElementById('expDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('addExpenseModal').classList.remove('hidden');
      lucide.createIcons();
    }

    function closeAddExpenseModal() {
      document.getElementById('addExpenseModal').classList.add('hidden');
    }

    function loadSubcategoriesDropdown() {
      var category = document.getElementById('expCategory').value;
      var subcatSelect = document.getElementById('expSubcategory');
      var subcats = App.expenseCategories[category]?.subcategories || [];
      
      subcatSelect.innerHTML = '<option value="">Select subcategory...</option>';
      subcats.forEach(s => {
        subcatSelect.innerHTML += '<option value="' + s.id + '">' + s.name + '</option>';
      });
    }

    async function saveExpense() {
      var expense = {
        date: document.getElementById('expDate').value,
        category_id: document.getElementById('expCategory').value,
        subcategory_id: document.getElementById('expSubcategory').value || null,
        amount: parseFloat(document.getElementById('expAmount').value) || 0,
        currency: document.getElementById('expCurrency').value,
        vendor: document.getElementById('expVendor').value,
        description: document.getElementById('expDescription').value,
        receipt_number: document.getElementById('expReceiptNum').value,
        payment_method: document.getElementById('expPaymentMethod').value,
        created_by: App.user?.id
      };
      
      if (expense.currency !== 'ZMW') {
        expense.amount_base = convertToBase(expense.amount, expense.currency);
        expense.exchange_rate = App.exchangeRates[expense.currency];
      } else {
        expense.amount_base = expense.amount;
        expense.exchange_rate = 1;
      }
      
      try {
        var { data, error } = await App.db.from('acc_expenses').insert([expense]).select();
        if (error) throw error;
        
        App.expenses.unshift(data[0]);
        await logAudit('expense_created', 'expense', data[0].id, null, expense);
        
        closeAddExpenseModal();
        updateDashboard();
        updateExpensesDisplay();
        showNotification(t('saveExpense') + ' ‚úì', 'success');
      } catch (e) {
        console.error('Error saving expense:', e);
        showNotification('Error: ' + e.message, 'error');
      }
    }

    async function deleteExpense(id) {
      if (!confirm('Delete this expense?')) return;
      
      try {
        var { error } = await App.db.from('acc_expenses').delete().eq('id', id);
        if (error) throw error;
        
        App.expenses = App.expenses.filter(e => e.id !== id);
        await logAudit('expense_deleted', 'expense', id, null, null);
        
        updateDashboard();
        updateExpensesDisplay();
        showNotification('Expense deleted', 'success');
      } catch (e) {
        showNotification('Error: ' + e.message, 'error');
      }
    }

    // ========== BULK UPLOAD ==========
    function showBulkUploadModal() {
      document.getElementById('bulkUploadModal').classList.remove('hidden');
      lucide.createIcons();
    }

    function closeBulkUploadModal() {
      document.getElementById('bulkUploadModal').classList.add('hidden');
      document.getElementById('bulkUploadPreview').classList.add('hidden');
      document.getElementById('bulkUploadPreview').innerHTML = '';
      document.getElementById('confirmBulkUploadBtn').disabled = true;
    }

    function handleBulkUpload(file) {
      var reader = new FileReader();
      reader.onload = function(e) {
        var content = e.target.result;
        var lines = content.split('\n').slice(0, 6);
        
        var preview = '<table class="w-full text-xs"><thead class="bg-slate-100"><tr>';
        var headers = lines[0].split(',');
        headers.forEach(h => preview += '<th class="px-2 py-1 text-left">' + h.trim() + '</th>');
        preview += '</tr></thead><tbody>';
        
        lines.slice(1).forEach(line => {
          if (line.trim()) {
            preview += '<tr>';
            line.split(',').forEach(cell => preview += '<td class="px-2 py-1 border-t">' + cell.trim() + '</td>');
            preview += '</tr>';
          }
        });
        preview += '</tbody></table>';
        
        document.getElementById('bulkUploadPreview').innerHTML = preview;
        document.getElementById('bulkUploadPreview').classList.remove('hidden');
        document.getElementById('confirmBulkUploadBtn').disabled = false;
      };
      reader.readAsText(file);
    }

    function confirmBulkUpload() {
      showNotification('Bulk upload feature coming soon', 'success');
      closeBulkUploadModal();
    }

    function downloadExpenseTemplate() {
      var csv = 'Date,Category,Subcategory,Amount,Currency,Vendor,Description,Receipt Number,Payment Method\n';
      csv += '2026-01-15,gaming_operations,,5000,ZMW,Vendor Name,Description here,REC-001,cash\n';
      csv += '2026-01-16,shop_operating,,2500,USD,Another Vendor,Another expense,REC-002,bank_transfer\n';
      
      var blob = new Blob([csv], { type: 'text/csv' });
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = 'expense_template.csv';
      a.click();
    }

    // ========== REPORTS ==========
    function generateReports() {
      updateReportCharts();
      showNotification(t('financialReports') + ' ‚úì', 'success');
    }

    function updateReportCharts() {
      var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
      
      // Trend Chart
      var ctx1 = document.getElementById('reportTrendChart');
      if (ctx1) {
        if (App.charts['trend']) App.charts['trend'].destroy();
        App.charts['trend'] = new Chart(ctx1, {
          type: 'line',
          data: {
            labels: months,
            datasets: [
              { label: t('revenue'), data: months.map(() => Math.random() * 50000 + 20000), borderColor: '#10B981', tension: 0.4 },
              { label: t('expenses'), data: months.map(() => Math.random() * 30000 + 10000), borderColor: '#EF4444', tension: 0.4 }
            ]
          },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
      }
      
      // Profit Chart
      var ctx2 = document.getElementById('reportProfitChart');
      if (ctx2) {
        if (App.charts['profit']) App.charts['profit'].destroy();
        var profitData = months.map(() => Math.random() * 30000 - 10000);
        App.charts['profit'] = new Chart(ctx2, {
          type: 'bar',
          data: {
            labels: months,
            datasets: [{
              label: t('profitLoss'),
              data: profitData,
              backgroundColor: profitData.map(v => v >= 0 ? '#10B981' : '#EF4444')
            }]
          },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
      }
      
      // Revenue Source Chart
      var ctx3 = document.getElementById('reportRevenueSourceChart');
      if (ctx3) {
        if (App.charts['source']) App.charts['source'].destroy();
        App.charts['source'] = new Chart(ctx3, {
          type: 'doughnut',
          data: {
            labels: [t('sportsRevenue'), t('casinoRevenue'), t('otherRevenue')],
            datasets: [{ data: [55, 35, 10], backgroundColor: ['#10B981', '#8B5CF6', '#3B82F6'] }]
          },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
      }
      
      // Currency Chart
      var ctx4 = document.getElementById('reportCurrencyChart');
      if (ctx4) {
        if (App.charts['currency']) App.charts['currency'].destroy();
        App.charts['currency'] = new Chart(ctx4, {
          type: 'doughnut',
          data: {
            labels: ['ZMW', 'USD', 'EUR'],
            datasets: [{ data: [70, 20, 10], backgroundColor: ['#FDF104', '#3B82F6', '#10B981'] }]
          },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
      }
      
      // Projection Chart
      var ctx5 = document.getElementById('reportProjectionChart');
      if (ctx5) {
        if (App.charts['projection']) App.charts['projection'].destroy();
        var days = Array.from({length: 30}, (_, i) => 'Day ' + (i + 1));
        App.charts['projection'] = new Chart(ctx5, {
          type: 'line',
          data: {
            labels: days,
            datasets: [
              { label: t('revenue') + ' (Projected)', data: days.map(() => Math.random() * 5000 + 2000), borderColor: '#10B981', borderDash: [5, 5], tension: 0.4 },
              { label: t('expenses') + ' (Projected)', data: days.map(() => Math.random() * 3000 + 1000), borderColor: '#EF4444', borderDash: [5, 5], tension: 0.4 }
            ]
          },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
      }
      
      lucide.createIcons();
    }

    function exportReportCSV() {
      var csv = 'Date,Type,Category,Description,Amount,Currency\n';
      
      App.revenue.forEach(r => {
        csv += [r.date, 'Revenue', r.type, r.description || '', r.amount, r.currency].join(',') + '\n';
      });
      
      App.expenses.forEach(e => {
        csv += [e.date, 'Expense', e.category_id, e.description || '', e.amount, e.currency].join(',') + '\n';
      });
      
      var blob = new Blob([csv], { type: 'text/csv' });
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = 'financial_report_' + new Date().toISOString().split('T')[0] + '.csv';
      a.click();
      
      showNotification(t('exportCsv') + ' ‚úì', 'success');
    }

    function printReport() {
      window.print();
    }

    // ========== SETTINGS & SUBCATEGORIES ==========
    function addSubcategory(categoryKey) {
      var name = prompt('Enter subcategory name:');
      if (name) {
        App.expenseCategories[categoryKey].subcategories.push({ id: Date.now().toString(), name: name });
        saveSubcategories();
        updateSubcategoryDisplay(categoryKey);
        showNotification('Subcategory added', 'success');
      }
    }

    function updateSubcategoryDisplay(categoryKey) {
      var container = document.getElementById('subcats-' + categoryKey);
      if (!container) return;
      
      var subcats = App.expenseCategories[categoryKey].subcategories;
      if (subcats.length === 0) {
        container.innerHTML = '<p class="text-slate-400">' + t('noSubcategories') + '</p>';
      } else {
        container.innerHTML = subcats.map(s => 
          '<div class="flex items-center justify-between p-2 bg-slate-50 rounded">' +
          '<span>' + s.name + '</span>' +
          '<button onclick="deleteSubcategory(\'' + categoryKey + '\', \'' + s.id + '\')" class="text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="h-3 w-3"></i></button>' +
          '</div>'
        ).join('');
        lucide.createIcons();
      }
    }

    function deleteSubcategory(categoryKey, subcatId) {
      App.expenseCategories[categoryKey].subcategories = App.expenseCategories[categoryKey].subcategories.filter(s => s.id !== subcatId);
      saveSubcategories();
      updateSubcategoryDisplay(categoryKey);
    }

    function saveSubcategories() {
      localStorage.setItem('bwanabet_acc_subcats', JSON.stringify(App.expenseCategories));
    }

    function loadSubcategories() {
      var saved = localStorage.getItem('bwanabet_acc_subcats');
      if (saved) {
        try {
          App.expenseCategories = JSON.parse(saved);
        } catch (e) {}
      }
      
      Object.keys(App.expenseCategories).forEach(key => {
        updateSubcategoryDisplay(key);
      });
    }

    // ========== AUDIT LOG ==========
    async function logAudit(action, entityType, entityId, oldValues, newValues) {
      try {
        await App.db.from('acc_audit_log').insert([{
          user_id: App.user?.id,
          user_email: App.user?.email,
          action: action,
          entity_type: entityType,
          entity_id: entityId,
          old_values: oldValues,
          new_values: newValues
        }]);
      } catch (e) {
        console.log('Could not log audit:', e.message);
      }
    }

    function updateAuditLog() {
      var tbody = document.getElementById('auditLogBody');
      
      if (App.auditLog.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-slate-400">' + t('noAuditLogs') + '</td></tr>';
        return;
      }
      
      tbody.innerHTML = App.auditLog.map(log => {
        return '<tr class="border-b">' +
          '<td class="px-4 py-3 text-sm">' + new Date(log.timestamp).toLocaleString() + '</td>' +
          '<td class="px-4 py-3 text-sm">' + (log.user_email || '-') + '</td>' +
          '<td class="px-4 py-3"><span class="px-2 py-1 rounded text-xs bg-slate-100">' + log.action + '</span></td>' +
          '<td class="px-4 py-3 text-sm text-slate-500">' + log.entity_type + ' ' + (log.entity_id ? log.entity_id.substring(0, 8) + '...' : '') + '</td>' +
          '</tr>';
      }).join('');
    }

    // ========== PARAMETERS ==========
    function loadParams() {
      var saved = localStorage.getItem('bwanabet_acc_params');
      if (saved) {
        try {
          App.params = { ...App.params, ...JSON.parse(saved) };
        } catch (e) {}
      }
      updateParamDisplays();
      loadSubcategories();
    }

    function saveParamsToStorage() {
      localStorage.setItem('bwanabet_acc_params', JSON.stringify(App.params));
    }

    function updateParamDisplays() {
      var symbol = CURRENCY_SYMBOLS[App.displayCurrency] || 'K';
      var displays = {
        'paramSportsTarget': symbol + convertToDisplayCurrency(App.params.sportsTarget).toLocaleString(undefined, {maximumFractionDigits: 0}),
        'paramCasinoTarget': symbol + convertToDisplayCurrency(App.params.casinoTarget).toLocaleString(undefined, {maximumFractionDigits: 0}),
        'paramOtherTarget': symbol + convertToDisplayCurrency(App.params.otherTarget).toLocaleString(undefined, {maximumFractionDigits: 0}),
        'paramGamingBudget': symbol + convertToDisplayCurrency(App.params.gamingBudget).toLocaleString(undefined, {maximumFractionDigits: 0}),
        'paramShopBudget': symbol + convertToDisplayCurrency(App.params.shopBudget).toLocaleString(undefined, {maximumFractionDigits: 0}),
        'paramOfficeBudget': symbol + convertToDisplayCurrency(App.params.officeBudget).toLocaleString(undefined, {maximumFractionDigits: 0}),
        'paramAdminBudget': symbol + convertToDisplayCurrency(App.params.adminBudget).toLocaleString(undefined, {maximumFractionDigits: 0})
      };
      
      Object.keys(displays).forEach(id => {
        var el = document.getElementById(id);
        if (el) el.textContent = displays[id];
      });
    }

    function openParamsModal(tab) {
      App.currentParamsTab = tab;
      var content = '';
      
      if (tab === 'revenue') {
        content = '<h4 class="font-medium text-slate-800 mb-4">' + t('revenueTargets') + '</h4>' +
          '<div class="space-y-4">' +
          '<div><label class="block text-sm font-medium text-slate-700 mb-1">' + t('sportsRevenue') + ' ' + t('target') + '</label>' +
          '<input type="number" id="paramInputSportsTarget" value="' + App.params.sportsTarget + '" class="w-full px-3 py-2 border rounded-lg"></div>' +
          '<div><label class="block text-sm font-medium text-slate-700 mb-1">' + t('casinoRevenue') + ' ' + t('target') + '</label>' +
          '<input type="number" id="paramInputCasinoTarget" value="' + App.params.casinoTarget + '" class="w-full px-3 py-2 border rounded-lg"></div>' +
          '<div><label class="block text-sm font-medium text-slate-700 mb-1">' + t('otherRevenue') + ' ' + t('target') + '</label>' +
          '<input type="number" id="paramInputOtherTarget" value="' + App.params.otherTarget + '" class="w-full px-3 py-2 border rounded-lg"></div>' +
          '</div>';
      } else if (tab === 'expenses') {
        content = '<h4 class="font-medium text-slate-800 mb-4">' + t('expenseBudgets') + '</h4>' +
          '<div class="space-y-4">' +
          '<div><label class="block text-sm font-medium text-slate-700 mb-1">' + t('gamingOperations') + ' ' + t('budget') + '</label>' +
          '<input type="number" id="paramInputGamingBudget" value="' + App.params.gamingBudget + '" class="w-full px-3 py-2 border rounded-lg"></div>' +
          '<div><label class="block text-sm font-medium text-slate-700 mb-1">' + t('shopOperating') + ' ' + t('budget') + '</label>' +
          '<input type="number" id="paramInputShopBudget" value="' + App.params.shopBudget + '" class="w-full px-3 py-2 border rounded-lg"></div>' +
          '<div><label class="block text-sm font-medium text-slate-700 mb-1">' + t('officeOperations') + ' ' + t('budget') + '</label>' +
          '<input type="number" id="paramInputOfficeBudget" value="' + App.params.officeBudget + '" class="w-full px-3 py-2 border rounded-lg"></div>' +
          '<div><label class="block text-sm font-medium text-slate-700 mb-1">' + t('administrative') + ' ' + t('budget') + '</label>' +
          '<input type="number" id="paramInputAdminBudget" value="' + App.params.adminBudget + '" class="w-full px-3 py-2 border rounded-lg"></div>' +
          '</div>';
      } else {
        content = '<p class="text-slate-500">No parameters to edit for this section.</p>';
      }
      
      document.getElementById('paramsModalContent').innerHTML = content;
      document.getElementById('paramsModal').classList.remove('hidden');
      lucide.createIcons();
    }

    function closeParamsModal() {
      document.getElementById('paramsModal').classList.add('hidden');
    }

    function saveParams() {
      if (App.currentParamsTab === 'revenue') {
        App.params.sportsTarget = parseInt(document.getElementById('paramInputSportsTarget').value) || 0;
        App.params.casinoTarget = parseInt(document.getElementById('paramInputCasinoTarget').value) || 0;
        App.params.otherTarget = parseInt(document.getElementById('paramInputOtherTarget').value) || 0;
      } else if (App.currentParamsTab === 'expenses') {
        App.params.gamingBudget = parseInt(document.getElementById('paramInputGamingBudget').value) || 0;
        App.params.shopBudget = parseInt(document.getElementById('paramInputShopBudget').value) || 0;
        App.params.officeBudget = parseInt(document.getElementById('paramInputOfficeBudget').value) || 0;
        App.params.adminBudget = parseInt(document.getElementById('paramInputAdminBudget').value) || 0;
      }
      
      saveParamsToStorage();
      updateParamDisplays();
      closeParamsModal();
      showNotification(t('saveAndApply') + ' ‚úì', 'success');
    }

    // ========== UI HELPERS ==========
    function showLoading(text) {
      document.getElementById('loadingText').textContent = text || 'Loading...';
      document.getElementById('loadingOverlay').classList.remove('hidden');
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').classList.add('hidden');
    }

    function showNotification(message, type) {
      var notif = document.getElementById('notification');
      notif.className = 'fixed top-4 right-4 left-4 sm:left-auto z-50 px-4 py-3 rounded-lg shadow-xl flex items-center gap-3 notification ' +
        (type === 'success' ? 'bg-emerald-500 text-white' : 'bg-red-500 text-white');
      notif.innerHTML = '<i data-lucide="' + (type === 'success' ? 'check-circle' : 'alert-circle') + '" class="h-5 w-5"></i>' + message;
      notif.classList.remove('hidden');
      lucide.createIcons();
      
      setTimeout(() => notif.classList.add('hidden'), 3000);
    }

    // ========== CSV IMPORT FUNCTIONS ==========
    var pendingImport = { type: null, data: [] };

    function downloadRevenueTemplate() {
      var csv = 'date,type,amount,currency,description,reference_number\n';
      csv += '2026-01-15,sports,25000,ZMW,Daily sports betting revenue,REV-001\n';
      csv += '2026-01-15,casino,15000,ZMW,Daily casino revenue,REV-002\n';
      csv += '2026-01-16,sports,28000,ZMW,Weekend sports revenue,REV-003\n';
      
      downloadCSV(csv, 'revenue_template.csv');
    }

    function downloadExpensesTemplate() {
      var csv = 'date,category_id,amount,currency,vendor,description,receipt_number,payment_method\n';
      csv += '2026-01-15,gaming_operations,5000,ZMW,Gaming Supplier Ltd,Software license fee,EXP-001,bank_transfer\n';
      csv += '2026-01-15,shop_operating,2500,ZMW,Zesco,Electricity bill,EXP-002,mobile_money\n';
      csv += '2026-01-16,office_operations,1500,ZMW,Office Supplies Co,Stationery,EXP-003,cash\n';
      
      downloadCSV(csv, 'expenses_template.csv');
    }

    function downloadCSV(content, filename) {
      var blob = new Blob([content], { type: 'text/csv' });
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    function parseCSV(text) {
      var lines = text.trim().split('\n');
      var headers = lines[0].split(',').map(h => h.trim().toLowerCase());
      var data = [];
      
      for (var i = 1; i < lines.length; i++) {
        if (!lines[i].trim()) continue;
        var values = lines[i].split(',');
        var row = {};
        headers.forEach((h, idx) => {
          row[h] = values[idx] ? values[idx].trim() : '';
        });
        data.push(row);
      }
      return { headers, data };
    }

    function importRevenueCSV(file) {
      if (!file) return;
      var reader = new FileReader();
      reader.onload = function(e) {
        var parsed = parseCSV(e.target.result);
        pendingImport = { type: 'revenue', data: parsed.data };
        showImportPreview(parsed.headers, parsed.data, 'revenue');
      };
      reader.readAsText(file);
    }

    function importExpensesCSV(file) {
      if (!file) return;
      var reader = new FileReader();
      reader.onload = function(e) {
        var parsed = parseCSV(e.target.result);
        pendingImport = { type: 'expenses', data: parsed.data };
        showImportPreview(parsed.headers, parsed.data, 'expenses');
      };
      reader.readAsText(file);
    }

    function showImportPreview(headers, data, type) {
      var preview = document.getElementById('importPreview');
      var table = document.getElementById('importPreviewTable');
      var count = document.getElementById('importPreviewCount');
      
      var html = '<table class="w-full text-xs">';
      html += '<thead class="bg-slate-100 sticky top-0"><tr>';
      headers.forEach(h => html += '<th class="px-2 py-1 text-left">' + h + '</th>');
      html += '</tr></thead><tbody>';
      
      data.forEach((row, idx) => {
        html += '<tr class="' + (idx % 2 ? 'bg-slate-50' : '') + '">';
        headers.forEach(h => html += '<td class="px-2 py-1 border-t">' + (row[h] || '-') + '</td>');
        html += '</tr>';
      });
      html += '</tbody></table>';
      
      table.innerHTML = html;
      count.textContent = data.length + ' rows';
      preview.classList.remove('hidden');
      lucide.createIcons();
    }

    function cancelImport() {
      pendingImport = { type: null, data: [] };
      document.getElementById('importPreview').classList.add('hidden');
    }

    async function confirmImport() {
      if (!pendingImport.data.length) return;
      
      showLoading('Importing data...');
      
      try {
        if (pendingImport.type === 'revenue') {
          var revenueRecords = pendingImport.data.map(row => ({
            date: row.date,
            type: row.type || 'other',
            amount: parseFloat(row.amount) || 0,
            currency: row.currency || 'ZMW',
            amount_base: parseFloat(row.amount) || 0,
            exchange_rate: 1,
            description: row.description || '',
            reference_number: row.reference_number || '',
            created_by: App.user?.id
          }));
          
          // Convert non-ZMW currencies
          revenueRecords.forEach(r => {
            if (r.currency !== 'ZMW') {
              r.amount_base = r.amount * (App.exchangeRates[r.currency] || 1);
              r.exchange_rate = App.exchangeRates[r.currency] || 1;
            }
          });
          
          var { data, error } = await App.db.from('acc_revenue').insert(revenueRecords).select();
          if (error) throw error;
          
          App.revenue = [...(data || []), ...App.revenue];
          showNotification('Imported ' + revenueRecords.length + ' revenue records', 'success');
          
        } else if (pendingImport.type === 'expenses') {
          var expenseRecords = pendingImport.data.map(row => ({
            date: row.date,
            category_id: row.category_id || 'administrative',
            amount: parseFloat(row.amount) || 0,
            currency: row.currency || 'ZMW',
            amount_base: parseFloat(row.amount) || 0,
            exchange_rate: 1,
            vendor: row.vendor || '',
            description: row.description || '',
            receipt_number: row.receipt_number || '',
            payment_method: row.payment_method || 'cash',
            created_by: App.user?.id
          }));
          
          // Convert non-ZMW currencies
          expenseRecords.forEach(e => {
            if (e.currency !== 'ZMW') {
              e.amount_base = e.amount * (App.exchangeRates[e.currency] || 1);
              e.exchange_rate = App.exchangeRates[e.currency] || 1;
            }
          });
          
          var { data, error } = await App.db.from('acc_expenses').insert(expenseRecords).select();
          if (error) throw error;
          
          App.expenses = [...(data || []), ...App.expenses];
          showNotification('Imported ' + expenseRecords.length + ' expense records', 'success');
        }
        
        cancelImport();
        updateDashboard();
        updateRevenueDisplay();
        updateExpensesDisplay();
        
      } catch (e) {
        console.error('Import error:', e);
        showNotification('Import failed: ' + e.message, 'error');
      }
      
      hideLoading();
    }

    function loadMockData() {
      // Generate mock revenue data
      var mockRevenue = [
        { date: '2026-01-01', type: 'sports', amount: 45000, currency: 'ZMW', description: 'New Year sports betting', reference_number: 'REV-0101' },
        { date: '2026-01-02', type: 'casino', amount: 32000, currency: 'ZMW', description: 'Casino slots revenue', reference_number: 'REV-0102' },
        { date: '2026-01-03', type: 'sports', amount: 38000, currency: 'ZMW', description: 'Football matches', reference_number: 'REV-0103' },
        { date: '2026-01-04', type: 'casino', amount: 28500, currency: 'ZMW', description: 'Table games revenue', reference_number: 'REV-0104' },
        { date: '2026-01-05', type: 'sports', amount: 52000, currency: 'ZMW', description: 'Weekend premier league', reference_number: 'REV-0105' },
        { date: '2026-01-06', type: 'other', amount: 5000, currency: 'ZMW', description: 'VIP membership fees', reference_number: 'REV-0106' },
        { date: '2026-01-07', type: 'sports', amount: 41000, currency: 'ZMW', description: 'Tennis tournaments', reference_number: 'REV-0107' },
        { date: '2026-01-08', type: 'casino', amount: 35000, currency: 'ZMW', description: 'Online casino games', reference_number: 'REV-0108' },
        { date: '2026-01-09', type: 'sports', amount: 48000, currency: 'ZMW', description: 'Basketball betting', reference_number: 'REV-0109' },
        { date: '2026-01-10', type: 'casino', amount: 29000, currency: 'ZMW', description: 'Jackpot contributions', reference_number: 'REV-0110' },
        { date: '2026-01-11', type: 'sports', amount: 1500, currency: 'USD', description: 'International bets (USD)', reference_number: 'REV-0111' },
        { date: '2026-01-12', type: 'casino', amount: 800, currency: 'EUR', description: 'Euro player deposits', reference_number: 'REV-0112' }
      ];

      // Generate mock expense data
      var mockExpenses = [
        { date: '2026-01-01', category_id: 'gaming_operations', amount: 15000, currency: 'ZMW', vendor: 'BetRadar Ltd', description: 'Sports data feed subscription', receipt_number: 'EXP-0101', payment_method: 'bank_transfer' },
        { date: '2026-01-02', category_id: 'shop_operating', amount: 8500, currency: 'ZMW', vendor: 'Zesco Limited', description: 'Monthly electricity - All shops', receipt_number: 'EXP-0102', payment_method: 'bank_transfer' },
        { date: '2026-01-03', category_id: 'office_operations', amount: 3200, currency: 'ZMW', vendor: 'Airtel Zambia', description: 'Internet and phone services', receipt_number: 'EXP-0103', payment_method: 'mobile_money' },
        { date: '2026-01-04', category_id: 'administrative', amount: 25000, currency: 'ZMW', vendor: 'Staff Payroll', description: 'January salaries - Admin staff', receipt_number: 'EXP-0104', payment_method: 'bank_transfer' },
        { date: '2026-01-05', category_id: 'gaming_operations', amount: 7500, currency: 'ZMW', vendor: 'Casino Supplies Co', description: 'Gaming equipment maintenance', receipt_number: 'EXP-0105', payment_method: 'cash' },
        { date: '2026-01-06', category_id: 'shop_operating', amount: 4200, currency: 'ZMW', vendor: 'Landlord - Cairo Road', description: 'Shop rent - Main branch', receipt_number: 'EXP-0106', payment_method: 'bank_transfer' },
        { date: '2026-01-07', category_id: 'office_operations', amount: 1800, currency: 'ZMW', vendor: 'Office Mart', description: 'Printer ink and paper supplies', receipt_number: 'EXP-0107', payment_method: 'cash' },
        { date: '2026-01-08', category_id: 'administrative', amount: 12000, currency: 'ZMW', vendor: 'Tax Authority', description: 'Monthly tax payment', receipt_number: 'EXP-0108', payment_method: 'bank_transfer' },
        { date: '2026-01-09', category_id: 'gaming_operations', amount: 500, currency: 'USD', vendor: 'Software Vendor Inc', description: 'Platform license (USD)', receipt_number: 'EXP-0109', payment_method: 'card' },
        { date: '2026-01-10', category_id: 'shop_operating', amount: 2800, currency: 'ZMW', vendor: 'Security Services Ltd', description: 'Monthly security contract', receipt_number: 'EXP-0110', payment_method: 'bank_transfer' },
        { date: '2026-01-11', category_id: 'office_operations', amount: 350, currency: 'EUR', vendor: 'Cloud Services EU', description: 'Server hosting (EUR)', receipt_number: 'EXP-0111', payment_method: 'card' },
        { date: '2026-01-12', category_id: 'administrative', amount: 5500, currency: 'ZMW', vendor: 'Marketing Agency', description: 'Social media advertising', receipt_number: 'EXP-0112', payment_method: 'bank_transfer' }
      ];

      // Process and add to App state
      mockRevenue.forEach(r => {
        r.amount_base = r.currency === 'ZMW' ? r.amount : r.amount * (App.exchangeRates[r.currency] || 1);
        r.exchange_rate = r.currency === 'ZMW' ? 1 : (App.exchangeRates[r.currency] || 1);
      });

      mockExpenses.forEach(e => {
        e.amount_base = e.currency === 'ZMW' ? e.amount : e.amount * (App.exchangeRates[e.currency] || 1);
        e.exchange_rate = e.currency === 'ZMW' ? 1 : (App.exchangeRates[e.currency] || 1);
      });

      App.revenue = mockRevenue;
      App.expenses = mockExpenses;

      updateDashboard();
      updateRevenueDisplay();
      updateExpensesDisplay();
      
      showNotification('Loaded ' + mockRevenue.length + ' revenue + ' + mockExpenses.length + ' expense records', 'success');
    }

    // =================================================================
    // IMPORT DATA FUNCTIONALITY
    // =================================================================
    var ImportState = {
      type: null, // 'revenue', 'expenses', or 'reports'
      activeTab: 'csv',
      csvData: [],
      excelData: [],
      manualEntries: [],
      scannedReceipts: []
    };

    function openImportModal(type) {
      ImportState.type = type;
      ImportState.csvData = [];
      ImportState.excelData = [];
      ImportState.manualEntries = [];
      ImportState.scannedReceipts = [];
      
      // Update modal title based on type
      var titles = {
        revenue: 'Import Revenue Data',
        expenses: 'Import Expense Data',
        reports: 'Import Financial Data'
      };
      document.getElementById('importModalTitle').textContent = titles[type] || 'Import Data';
      document.getElementById('importModalSubtitle').textContent = 'Import ' + type + ' records from various sources';
      
      // Reset all tabs and previews
      switchImportTab('csv');
      resetImportPreviews();
      initManualEntryForm();
      updateImportSummary();
      
      document.getElementById('importModal').classList.remove('hidden');
      lucide.createIcons();
    }

    function closeImportModal() {
      document.getElementById('importModal').classList.add('hidden');
      resetImportPreviews();
    }

    function switchImportTab(tab) {
      ImportState.activeTab = tab;
      
      // Update tab buttons
      ['csv', 'excel', 'manual', 'receipt'].forEach(t => {
        var btn = document.getElementById('importTab-' + t);
        var content = document.getElementById('importContent-' + t);
        if (t === tab) {
          btn.classList.add('active');
          content.classList.remove('hidden');
        } else {
          btn.classList.remove('active');
          content.classList.add('hidden');
        }
      });
      
      updateImportSummary();
      lucide.createIcons();
    }

    function resetImportPreviews() {
      document.getElementById('csvPreview').classList.add('hidden');
      document.getElementById('excelPreview').classList.add('hidden');
      document.getElementById('manualEntriesPreview').classList.add('hidden');
      document.getElementById('scannedReceiptsContainer').classList.add('hidden');
      document.getElementById('scanningProgress').classList.add('hidden');
      document.getElementById('csvPreviewTable').innerHTML = '';
      document.getElementById('excelPreviewTable').innerHTML = '';
      document.getElementById('scannedReceiptsGrid').innerHTML = '';
    }

    // ========== DRAG AND DROP ==========
    function handleDragOver(e) {
      e.preventDefault();
      e.stopPropagation();
      e.currentTarget.classList.add('dragover');
    }

    function handleDragLeave(e) {
      e.preventDefault();
      e.stopPropagation();
      e.currentTarget.classList.remove('dragover');
    }

    // ========== CSV IMPORT ==========
    function handleCsvDrop(e) {
      e.preventDefault();
      e.stopPropagation();
      e.currentTarget.classList.remove('dragover');
      var files = e.dataTransfer.files;
      if (files.length > 0) handleCsvFile(files[0]);
    }

    function handleCsvFile(file) {
      if (!file || !file.name.endsWith('.csv')) {
        showNotification('Please select a valid CSV file', 'error');
        return;
      }
      
      var reader = new FileReader();
      reader.onload = function(e) {
        var content = e.target.result;
        var lines = content.split('\n').filter(line => line.trim());
        var headers = lines[0].split(',').map(h => h.trim().toLowerCase());
        
        ImportState.csvData = [];
        for (var i = 1; i < lines.length; i++) {
          var values = lines[i].split(',');
          var row = {};
          headers.forEach((h, idx) => {
            row[h] = values[idx] ? values[idx].trim() : '';
          });
          ImportState.csvData.push(row);
        }
        
        displayCsvPreview(headers, ImportState.csvData);
        updateImportSummary();
      };
      reader.readAsText(file);
    }

    function displayCsvPreview(headers, data) {
      var html = '<table class="w-full text-xs"><thead class="bg-slate-100 sticky top-0"><tr>';
      headers.forEach(h => html += '<th class="px-3 py-2 text-left font-medium text-slate-700">' + h + '</th>');
      html += '</tr></thead><tbody>';
      
      data.slice(0, 10).forEach((row, i) => {
        html += '<tr class="' + (i % 2 === 0 ? 'bg-white' : 'bg-slate-50') + '">';
        headers.forEach(h => html += '<td class="px-3 py-2 border-t">' + (row[h] || '-') + '</td>');
        html += '</tr>';
      });
      
      if (data.length > 10) {
        html += '<tr><td colspan="' + headers.length + '" class="px-3 py-2 text-center text-slate-500 bg-slate-100">... and ' + (data.length - 10) + ' more rows</td></tr>';
      }
      html += '</tbody></table>';
      
      document.getElementById('csvPreviewTable').innerHTML = html;
      document.getElementById('csvRowCount').textContent = data.length + ' rows';
      document.getElementById('csvPreview').classList.remove('hidden');
    }

    // ========== EXCEL IMPORT ==========
    function handleExcelDrop(e) {
      e.preventDefault();
      e.stopPropagation();
      e.currentTarget.classList.remove('dragover');
      var files = e.dataTransfer.files;
      if (files.length > 0) handleExcelFile(files[0]);
    }

    function handleExcelFile(file) {
      if (!file || (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls'))) {
        showNotification('Please select a valid Excel file (.xlsx or .xls)', 'error');
        return;
      }
      
      // Using SheetJS library (need to include it)
      var reader = new FileReader();
      reader.onload = function(e) {
        try {
          // Simple Excel parsing using basic structure
          // For full Excel support, we'd use SheetJS
          showNotification('Excel file loaded. Processing...', 'success');
          
          // Simulate Excel data (in production, use SheetJS)
          ImportState.excelData = [];
          
          // Show message about Excel support
          document.getElementById('excelPreviewTable').innerHTML = `
            <div class="p-8 text-center">
              <i data-lucide="file-spreadsheet" class="h-12 w-12 mx-auto text-slate-400 mb-3"></i>
              <p class="text-slate-600 font-medium">Excel file: ${file.name}</p>
              <p class="text-sm text-slate-500 mt-2">For best results, please save as CSV and use the CSV import option.</p>
              <p class="text-xs text-slate-400 mt-4">File size: ${(file.size / 1024).toFixed(1)} KB</p>
            </div>
          `;
          document.getElementById('excelRowCount').textContent = 'Processing...';
          document.getElementById('excelPreview').classList.remove('hidden');
          lucide.createIcons();
          
        } catch (err) {
          showNotification('Error processing Excel file: ' + err.message, 'error');
        }
      };
      reader.readAsArrayBuffer(file);
    }

    // ========== MANUAL ENTRY ==========
    function initManualEntryForm() {
      ImportState.manualEntries = [];
      var container = document.getElementById('manualEntriesContainer');
      container.innerHTML = '';
      addManualEntryRow();
    }

    function addManualEntryRow() {
      var container = document.getElementById('manualEntriesContainer');
      var entryId = 'manual_' + Date.now();
      
      var isRevenue = ImportState.type === 'revenue';
      var isExpense = ImportState.type === 'expenses' || ImportState.type === 'reports';
      
      var html = `
        <div id="${entryId}" class="border rounded-lg p-4 mb-4 bg-white">
          <div class="flex justify-between items-start mb-3">
            <span class="text-sm font-medium text-slate-700">Entry #${container.children.length + 1}</span>
            <button onclick="removeManualEntry('${entryId}')" class="text-red-400 hover:text-red-600">
              <i data-lucide="trash-2" class="h-4 w-4"></i>
            </button>
          </div>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            <div>
              <label class="block text-xs font-medium text-slate-600 mb-1">Date</label>
              <input type="date" class="manual-date w-full px-2 py-1.5 text-sm border rounded" value="${new Date().toISOString().split('T')[0]}">
            </div>
            ${isRevenue ? `
              <div>
                <label class="block text-xs font-medium text-slate-600 mb-1">Type</label>
                <select class="manual-type w-full px-2 py-1.5 text-sm border rounded">
                  <option value="sports">Sports</option>
                  <option value="casino">Casino</option>
                  <option value="other">Other</option>
                </select>
              </div>
            ` : `
              <div>
                <label class="block text-xs font-medium text-slate-600 mb-1">Category</label>
                <select class="manual-category w-full px-2 py-1.5 text-sm border rounded">
                  <option value="gaming_operations">Gaming Operations</option>
                  <option value="shop_operating">Shop Operating</option>
                  <option value="office_operations">Office Operations</option>
                  <option value="administrative">Administrative</option>
                </select>
              </div>
            `}
            <div>
              <label class="block text-xs font-medium text-slate-600 mb-1">Amount</label>
              <div class="flex">
                <select class="manual-currency px-1 py-1.5 text-sm border border-r-0 rounded-l bg-slate-50">
                  <option value="ZMW">K</option>
                  <option value="USD">$</option>
                  <option value="EUR">‚Ç¨</option>
                </select>
                <input type="number" class="manual-amount w-full px-2 py-1.5 text-sm border rounded-r" placeholder="0.00">
              </div>
            </div>
            <div>
              <label class="block text-xs font-medium text-slate-600 mb-1">${isRevenue ? 'Reference' : 'Vendor'}</label>
              <input type="text" class="manual-ref w-full px-2 py-1.5 text-sm border rounded" placeholder="${isRevenue ? 'REF-001' : 'Vendor name'}">
            </div>
          </div>
          <div class="mt-3">
            <label class="block text-xs font-medium text-slate-600 mb-1">Description</label>
            <input type="text" class="manual-desc w-full px-2 py-1.5 text-sm border rounded" placeholder="Enter description...">
          </div>
        </div>
      `;
      
      container.insertAdjacentHTML('beforeend', html);
      lucide.createIcons();
      updateManualEntriesPreview();
    }

    function removeManualEntry(entryId) {
      var el = document.getElementById(entryId);
      if (el) el.remove();
      updateManualEntriesPreview();
      
      // Ensure at least one entry form exists
      var container = document.getElementById('manualEntriesContainer');
      if (container.children.length === 0) {
        addManualEntryRow();
      }
    }

    function updateManualEntriesPreview() {
      var container = document.getElementById('manualEntriesContainer');
      var entries = container.querySelectorAll('[id^="manual_"]');
      
      ImportState.manualEntries = [];
      entries.forEach(entry => {
        var amount = parseFloat(entry.querySelector('.manual-amount')?.value) || 0;
        if (amount > 0) {
          ImportState.manualEntries.push({
            date: entry.querySelector('.manual-date')?.value || '',
            type: entry.querySelector('.manual-type')?.value || '',
            category: entry.querySelector('.manual-category')?.value || '',
            currency: entry.querySelector('.manual-currency')?.value || 'ZMW',
            amount: amount,
            ref: entry.querySelector('.manual-ref')?.value || '',
            description: entry.querySelector('.manual-desc')?.value || ''
          });
        }
      });
      
      if (ImportState.manualEntries.length > 0) {
        document.getElementById('manualEntryCount').textContent = ImportState.manualEntries.length;
        document.getElementById('manualEntriesPreview').classList.remove('hidden');
      } else {
        document.getElementById('manualEntriesPreview').classList.add('hidden');
      }
      
      updateImportSummary();
    }

    // ========== RECEIPT/INVOICE SCANNING ==========
    function handleReceiptDrop(e) {
      e.preventDefault();
      e.stopPropagation();
      e.currentTarget.classList.remove('dragover');
      var files = e.dataTransfer.files;
      if (files.length > 0) handleReceiptFiles(files);
    }

    async function handleReceiptFiles(files) {
      if (!files || files.length === 0) return;
      
      var validFiles = Array.from(files).filter(f => 
        f.type.startsWith('image/') || f.type === 'application/pdf'
      );
      
      if (validFiles.length === 0) {
        showNotification('Please select valid image files (JPG, PNG) or PDF', 'error');
        return;
      }
      
      // Show progress
      document.getElementById('scanningProgress').classList.remove('hidden');
      document.getElementById('scannedReceiptsContainer').classList.remove('hidden');
      
      var total = validFiles.length;
      var processed = 0;
      
      for (var file of validFiles) {
        processed++;
        document.getElementById('scanProgressText').textContent = processed + '/' + total;
        document.getElementById('scanProgressBar').style.width = ((processed / total) * 100) + '%';
        
        await scanReceiptWithAI(file, processed);
      }
      
      document.getElementById('scanningProgress').classList.add('hidden');
      updateImportSummary();
    }

    async function scanReceiptWithAI(file, index) {
      // Create receipt card placeholder
      var receiptId = 'receipt_' + Date.now() + '_' + index;
      var grid = document.getElementById('scannedReceiptsGrid');
      
      var cardHtml = `
        <div id="${receiptId}" class="receipt-card processing">
          <div class="p-3 bg-slate-50 border-b">
            <div class="flex items-center gap-2">
              <div class="spinner h-4 w-4 border-2 border-yellow-500 border-t-transparent rounded-full"></div>
              <span class="text-sm font-medium text-slate-700">Scanning...</span>
            </div>
          </div>
          <div class="p-4">
            <div class="flex justify-center mb-3">
              <img id="img_${receiptId}" class="receipt-preview" src="" alt="Receipt">
            </div>
            <div class="text-center text-sm text-slate-500">Processing with AI...</div>
          </div>
        </div>
      `;
      
      grid.insertAdjacentHTML('beforeend', cardHtml);
      
      // Load image preview
      var reader = new FileReader();
      var imageBase64 = await new Promise((resolve) => {
        reader.onload = function(e) {
          document.getElementById('img_' + receiptId).src = e.target.result;
          resolve(e.target.result);
        };
        reader.readAsDataURL(file);
      });
      
      // Call Claude API to analyze the receipt
      try {
        var extractedData = await analyzeReceiptWithClaude(imageBase64, file.type);
        displayScannedReceipt(receiptId, extractedData, imageBase64);
      } catch (error) {
        console.error('Receipt scan error:', error);
        displayScannedReceiptError(receiptId, error.message);
      }
    }

    async function analyzeReceiptWithClaude(imageBase64, mimeType) {
      var base64Data = imageBase64.split(',')[1];
      var mediaType = mimeType.startsWith('image/') ? mimeType : 'image/jpeg';
      
      var isExpense = ImportState.type === 'expenses' || ImportState.type === 'reports';
      
      var systemPrompt = isExpense ? 
        `You are a receipt/invoice data extractor. Analyze the image and extract:
- date (YYYY-MM-DD format)
- vendor (company/store name)
- amount (numeric value only)
- currency (ZMW, USD, EUR, or other - default to ZMW if unclear)
- category (one of: gaming_operations, shop_operating, office_operations, administrative)
- description (brief description of purchase)
- receipt_number (if visible)

Respond ONLY with a JSON object, no other text:
{"date":"","vendor":"","amount":0,"currency":"ZMW","category":"","description":"","receipt_number":""}` :
        `You are a receipt/invoice data extractor for revenue records. Analyze the image and extract:
- date (YYYY-MM-DD format)
- type (sports, casino, or other)
- amount (numeric value only)
- currency (ZMW, USD, EUR - default to ZMW if unclear)
- description (brief description)
- reference_number (if visible)

Respond ONLY with a JSON object, no other text:
{"date":"","type":"","amount":0,"currency":"ZMW","description":"","reference_number":""}`;

      var response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': AI_CONFIG.apiKey,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: AI_CONFIG.model,
          max_tokens: 500,
          messages: [{
            role: 'user',
            content: [
              {
                type: 'image',
                source: {
                  type: 'base64',
                  media_type: mediaType,
                  data: base64Data
                }
              },
              {
                type: 'text',
                text: systemPrompt
              }
            ]
          }]
        })
      });
      
      if (!response.ok) {
        var error = await response.json();
        throw new Error(error.error?.message || 'API request failed');
      }
      
      var data = await response.json();
      var responseText = data.content[0].text;
      
      // Extract JSON from response
      var jsonMatch = responseText.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        return JSON.parse(jsonMatch[0]);
      }
      
      throw new Error('Could not parse receipt data');
    }

    function displayScannedReceipt(receiptId, data, imageBase64) {
      var card = document.getElementById(receiptId);
      var isExpense = ImportState.type === 'expenses' || ImportState.type === 'reports';
      
      card.classList.remove('processing');
      card.classList.add('success');
      
      var html = `
        <div class="p-3 bg-green-50 border-b flex items-center justify-between">
          <div class="flex items-center gap-2">
            <i data-lucide="check-circle" class="h-4 w-4 text-green-500"></i>
            <span class="text-sm font-medium text-green-700">Scanned Successfully</span>
          </div>
          <button onclick="removeScannedReceipt('${receiptId}')" class="text-red-400 hover:text-red-600">
            <i data-lucide="trash-2" class="h-4 w-4"></i>
          </button>
        </div>
        <div class="p-4">
          <div class="flex gap-4">
            <img src="${imageBase64}" class="w-24 h-24 object-cover rounded-lg border">
            <div class="flex-1 space-y-2">
              <div class="grid grid-cols-2 gap-2">
                <div>
                  <label class="block text-xs text-slate-500">Date</label>
                  <input type="date" class="scanned-date editable-field w-full text-sm" value="${data.date || ''}" data-receipt="${receiptId}">
                </div>
                <div>
                  <label class="block text-xs text-slate-500">Amount</label>
                  <div class="flex">
                    <select class="scanned-currency px-1 text-sm border rounded-l bg-slate-50" data-receipt="${receiptId}">
                      <option value="ZMW" ${data.currency === 'ZMW' ? 'selected' : ''}>K</option>
                      <option value="USD" ${data.currency === 'USD' ? 'selected' : ''}>$</option>
                      <option value="EUR" ${data.currency === 'EUR' ? 'selected' : ''}>‚Ç¨</option>
                    </select>
                    <input type="number" class="scanned-amount editable-field flex-1 text-sm rounded-l-none" value="${data.amount || 0}" data-receipt="${receiptId}">
                  </div>
                </div>
              </div>
              ${isExpense ? `
                <div class="grid grid-cols-2 gap-2">
                  <div>
                    <label class="block text-xs text-slate-500">Vendor</label>
                    <input type="text" class="scanned-vendor editable-field w-full text-sm" value="${data.vendor || ''}" data-receipt="${receiptId}">
                  </div>
                  <div>
                    <label class="block text-xs text-slate-500">Category</label>
                    <select class="scanned-category editable-field w-full text-sm" data-receipt="${receiptId}">
                      <option value="gaming_operations" ${data.category === 'gaming_operations' ? 'selected' : ''}>Gaming Operations</option>
                      <option value="shop_operating" ${data.category === 'shop_operating' ? 'selected' : ''}>Shop Operating</option>
                      <option value="office_operations" ${data.category === 'office_operations' ? 'selected' : ''}>Office Operations</option>
                      <option value="administrative" ${data.category === 'administrative' ? 'selected' : ''}>Administrative</option>
                    </select>
                  </div>
                </div>
              ` : `
                <div class="grid grid-cols-2 gap-2">
                  <div>
                    <label class="block text-xs text-slate-500">Type</label>
                    <select class="scanned-type editable-field w-full text-sm" data-receipt="${receiptId}">
                      <option value="sports" ${data.type === 'sports' ? 'selected' : ''}>Sports</option>
                      <option value="casino" ${data.type === 'casino' ? 'selected' : ''}>Casino</option>
                      <option value="other" ${data.type === 'other' ? 'selected' : ''}>Other</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-xs text-slate-500">Reference</label>
                    <input type="text" class="scanned-ref editable-field w-full text-sm" value="${data.reference_number || ''}" data-receipt="${receiptId}">
                  </div>
                </div>
              `}
              <div>
                <label class="block text-xs text-slate-500">Description</label>
                <input type="text" class="scanned-desc editable-field w-full text-sm" value="${data.description || ''}" data-receipt="${receiptId}">
              </div>
            </div>
          </div>
        </div>
      `;
      
      card.innerHTML = html;
      lucide.createIcons();
      
      // Add to scanned receipts array
      ImportState.scannedReceipts.push({
        id: receiptId,
        data: data
      });
      
      document.getElementById('scannedReceiptCount').textContent = ImportState.scannedReceipts.length;
      updateImportSummary();
    }

    function displayScannedReceiptError(receiptId, errorMessage) {
      var card = document.getElementById(receiptId);
      card.classList.remove('processing');
      card.classList.add('error');
      
      card.innerHTML = `
        <div class="p-3 bg-red-50 border-b flex items-center justify-between">
          <div class="flex items-center gap-2">
            <i data-lucide="alert-circle" class="h-4 w-4 text-red-500"></i>
            <span class="text-sm font-medium text-red-700">Scan Failed</span>
          </div>
          <button onclick="removeScannedReceipt('${receiptId}')" class="text-red-400 hover:text-red-600">
            <i data-lucide="trash-2" class="h-4 w-4"></i>
          </button>
        </div>
        <div class="p-4">
          <p class="text-sm text-red-600">${errorMessage}</p>
          <p class="text-xs text-slate-500 mt-2">Try uploading a clearer image or enter data manually.</p>
        </div>
      `;
      lucide.createIcons();
    }

    function removeScannedReceipt(receiptId) {
      var el = document.getElementById(receiptId);
      if (el) el.remove();
      
      ImportState.scannedReceipts = ImportState.scannedReceipts.filter(r => r.id !== receiptId);
      document.getElementById('scannedReceiptCount').textContent = ImportState.scannedReceipts.length;
      
      if (ImportState.scannedReceipts.length === 0) {
        document.getElementById('scannedReceiptsContainer').classList.add('hidden');
      }
      
      updateImportSummary();
    }

    function clearScannedReceipts() {
      ImportState.scannedReceipts = [];
      document.getElementById('scannedReceiptsGrid').innerHTML = '';
      document.getElementById('scannedReceiptsContainer').classList.add('hidden');
      document.getElementById('scannedReceiptCount').textContent = '0';
      updateImportSummary();
    }

    // ========== IMPORT SUMMARY & EXECUTION ==========
    function updateImportSummary() {
      var count = 0;
      var source = '';
      
      switch (ImportState.activeTab) {
        case 'csv':
          count = ImportState.csvData.length;
          source = 'CSV';
          break;
        case 'excel':
          count = ImportState.excelData.length;
          source = 'Excel';
          break;
        case 'manual':
          // Re-collect manual entries
          updateManualEntriesPreview();
          count = ImportState.manualEntries.length;
          source = 'Manual';
          break;
        case 'receipt':
          count = ImportState.scannedReceipts.length;
          source = 'Scanned';
          break;
      }
      
      var btn = document.getElementById('executeImportBtn');
      if (count > 0) {
        document.getElementById('importSummary').textContent = count + ' ' + source.toLowerCase() + ' record(s) ready to import';
        btn.disabled = false;
      } else {
        document.getElementById('importSummary').textContent = 'No data to import';
        btn.disabled = true;
      }
    }

    function downloadImportTemplate() {
      var isRevenue = ImportState.type === 'revenue';
      var csv = '';
      
      if (isRevenue) {
        csv = 'date,type,amount,currency,description,reference_number\n';
        csv += '2026-01-15,sports,50000,ZMW,Sports betting revenue,REV-001\n';
        csv += '2026-01-16,casino,25000,ZMW,Casino games revenue,REV-002\n';
      } else {
        csv = 'date,category_id,amount,currency,vendor,description,receipt_number,payment_method\n';
        csv += '2026-01-15,gaming_operations,5000,ZMW,Vendor Name,Description here,REC-001,cash\n';
        csv += '2026-01-16,shop_operating,2500,ZMW,Another Vendor,Another expense,REC-002,bank_transfer\n';
      }
      
      var blob = new Blob([csv], { type: 'text/csv' });
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = ImportState.type + '_import_template.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    async function executeImport() {
      var records = [];
      var isRevenue = ImportState.type === 'revenue';
      
      showLoading('Importing data...');
      
      try {
        // Collect data based on active tab
        switch (ImportState.activeTab) {
          case 'csv':
            records = ImportState.csvData;
            break;
          case 'excel':
            records = ImportState.excelData;
            break;
          case 'manual':
            updateManualEntriesPreview();
            records = ImportState.manualEntries.map(e => {
              if (isRevenue) {
                return {
                  date: e.date,
                  type: e.type,
                  amount: e.amount,
                  currency: e.currency,
                  description: e.description,
                  reference_number: e.ref
                };
              } else {
                return {
                  date: e.date,
                  category_id: e.category,
                  amount: e.amount,
                  currency: e.currency,
                  vendor: e.ref,
                  description: e.description
                };
              }
            });
            break;
          case 'receipt':
            // Collect from scanned receipts UI and save images to gallery
            records = [];
            for (var r of ImportState.scannedReceipts) {
              var card = document.getElementById(r.id);
              if (!card) continue;
              
              // Get the receipt image
              var imgEl = card.querySelector('img');
              var imageBase64 = imgEl ? imgEl.src : '';
              
              if (isRevenue) {
                var data = {
                  date: card.querySelector('.scanned-date')?.value || '',
                  type: card.querySelector('.scanned-type')?.value || 'other',
                  amount: parseFloat(card.querySelector('.scanned-amount')?.value) || 0,
                  currency: card.querySelector('.scanned-currency')?.value || 'ZMW',
                  description: card.querySelector('.scanned-desc')?.value || '',
                  reference_number: card.querySelector('.scanned-ref')?.value || ''
                };
                // Save to receipts gallery (async)
                if (imageBase64 && imageBase64.startsWith('data:')) {
                  await saveReceiptToGallery(data, imageBase64, 'revenue');
                }
                records.push(data);
              } else {
                var data = {
                  date: card.querySelector('.scanned-date')?.value || '',
                  category_id: card.querySelector('.scanned-category')?.value || 'administrative',
                  amount: parseFloat(card.querySelector('.scanned-amount')?.value) || 0,
                  currency: card.querySelector('.scanned-currency')?.value || 'ZMW',
                  vendor: card.querySelector('.scanned-vendor')?.value || '',
                  description: card.querySelector('.scanned-desc')?.value || ''
                };
                // Save to receipts gallery (async)
                if (imageBase64 && imageBase64.startsWith('data:')) {
                  await saveReceiptToGallery(data, imageBase64, 'expense');
                }
                records.push(data);
              }
            }
            break;
        }
        
        if (records.length === 0) {
          throw new Error('No valid records to import');
        }
        
        // Process and import
        if (isRevenue) {
          var revenueRecords = records.map(row => ({
            date: row.date || new Date().toISOString().split('T')[0],
            type: row.type || 'other',
            amount: parseFloat(row.amount) || 0,
            currency: row.currency || 'ZMW',
            amount_base: parseFloat(row.amount) || 0,
            exchange_rate: 1,
            description: row.description || '',
            reference_number: row.reference_number || '',
            created_by: App.user?.id
          }));
          
          // Convert non-ZMW currencies
          revenueRecords.forEach(r => {
            if (r.currency !== 'ZMW') {
              r.amount_base = r.amount * (App.exchangeRates[r.currency] || 1);
              r.exchange_rate = App.exchangeRates[r.currency] || 1;
            }
          });
          
          var { data, error } = await App.db.from('acc_revenue').insert(revenueRecords).select();
          if (error) throw error;
          
          App.revenue = [...(data || []), ...App.revenue];
          showNotification('Imported ' + revenueRecords.length + ' revenue records', 'success');
          
        } else {
          var expenseRecords = records.map(row => ({
            date: row.date || new Date().toISOString().split('T')[0],
            category_id: row.category_id || row.category || 'administrative',
            amount: parseFloat(row.amount) || 0,
            currency: row.currency || 'ZMW',
            amount_base: parseFloat(row.amount) || 0,
            exchange_rate: 1,
            vendor: row.vendor || '',
            description: row.description || '',
            receipt_number: row.receipt_number || '',
            payment_method: row.payment_method || 'cash',
            created_by: App.user?.id
          }));
          
          // Convert non-ZMW currencies
          expenseRecords.forEach(e => {
            if (e.currency !== 'ZMW') {
              e.amount_base = e.amount * (App.exchangeRates[e.currency] || 1);
              e.exchange_rate = App.exchangeRates[e.currency] || 1;
            }
          });
          
          var { data, error } = await App.db.from('acc_expenses').insert(expenseRecords).select();
          if (error) throw error;
          
          App.expenses = [...(data || []), ...App.expenses];
          showNotification('Imported ' + expenseRecords.length + ' expense records', 'success');
        }
        
        // Refresh displays
        updateDashboard();
        updateRevenueDisplay();
        updateExpensesDisplay();
        
        // Close modal
        closeImportModal();
        
      } catch (e) {
        console.error('Import error:', e);
        showNotification('Import failed: ' + e.message, 'error');
      }
      
      hideLoading();
    }
    // =================================================================
    // END IMPORT FUNCTIONALITY
    // =================================================================

    // =================================================================
    // RECEIPTS GALLERY FUNCTIONALITY (SUPABASE STORAGE)
    // =================================================================
    var ReceiptsStore = {
      receipts: [],
      currentFilter: 'all',
      bucketName: 'receipts',
      initialized: false,
      
      // Initialize - create bucket if needed and load receipts
      async init() {
        if (this.initialized) return;
        
        try {
          // Try to create the storage bucket (will fail silently if exists)
          await App.db.storage.createBucket(this.bucketName, {
            public: true,
            fileSizeLimit: 10485760 // 10MB
          });
        } catch (e) {
          // Bucket likely already exists, that's fine
          console.log('Bucket check:', e.message);
        }
        
        // Load existing receipts from database
        await this.loadFromDatabase();
        this.initialized = true;
        this.updateBadge();
      },
      
      // Load receipts from Supabase database
      async loadFromDatabase() {
        try {
          var { data, error } = await App.db
            .from('acc_receipts')
            .select('*')
            .order('uploaded_at', { ascending: false });
          
          if (error) {
            console.warn('Could not load receipts:', error.message);
            // Table might not exist yet
            this.receipts = [];
            return;
          }
          
          this.receipts = data || [];
        } catch (e) {
          console.warn('Error loading receipts:', e);
          this.receipts = [];
        }
      },
      
      // Upload image to Supabase Storage and save metadata
      async add(receipt) {
        try {
          showLoading('Saving receipt...');
          
          var receiptId = 'rcpt_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          var imageUrl = null;
          
          // Upload image to Supabase Storage if we have one
          if (receipt.image && receipt.image.startsWith('data:')) {
            // Convert base64 to blob
            var base64Data = receipt.image.split(',')[1];
            var mimeType = receipt.image.split(';')[0].split(':')[1] || 'image/jpeg';
            var byteCharacters = atob(base64Data);
            var byteNumbers = new Array(byteCharacters.length);
            for (var i = 0; i < byteCharacters.length; i++) {
              byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            var byteArray = new Uint8Array(byteNumbers);
            var blob = new Blob([byteArray], { type: mimeType });
            
            // Generate filename
            var extension = mimeType.split('/')[1] || 'jpg';
            var fileName = receiptId + '.' + extension;
            
            // Upload to Supabase Storage
            var { data: uploadData, error: uploadError } = await App.db.storage
              .from(this.bucketName)
              .upload(fileName, blob, {
                contentType: mimeType,
                upsert: true
              });
            
            if (uploadError) {
              console.error('Upload error:', uploadError);
              throw new Error('Failed to upload image: ' + uploadError.message);
            }
            
            // Get public URL
            var { data: urlData } = App.db.storage
              .from(this.bucketName)
              .getPublicUrl(fileName);
            
            imageUrl = urlData.publicUrl;
          }
          
          // Save metadata to database
          var receiptRecord = {
            id: receiptId,
            type: receipt.type || 'expense',
            date: receipt.date || null,
            amount: parseFloat(receipt.amount) || 0,
            currency: receipt.currency || 'ZMW',
            vendor: receipt.vendor || null,
            category: receipt.category || null,
            revenue_type: receipt.revenueType || null,
            description: receipt.description || null,
            receipt_number: receipt.receiptNumber || null,
            image_url: imageUrl,
            uploaded_at: new Date().toISOString(),
            created_by: App.user?.id || null
          };
          
          var { data, error } = await App.db
            .from('acc_receipts')
            .insert([receiptRecord])
            .select();
          
          if (error) {
            throw new Error('Failed to save receipt: ' + error.message);
          }
          
          // Add to local array
          this.receipts.unshift(data[0]);
          this.updateBadge();
          
          hideLoading();
          return receiptId;
          
        } catch (e) {
          hideLoading();
          console.error('Error saving receipt:', e);
          showNotification('Error saving receipt: ' + e.message, 'error');
          return null;
        }
      },
      
      // Get all receipts
      getAll() {
        return this.receipts;
      },
      
      // Get filtered receipts
      getFiltered(filter, searchTerm) {
        var results = this.receipts;
        
        // Apply type filter
        if (filter && filter !== 'all') {
          results = results.filter(r => r.type === filter);
        }
        
        // Apply search
        if (searchTerm) {
          var term = searchTerm.toLowerCase();
          results = results.filter(r => 
            (r.vendor && r.vendor.toLowerCase().includes(term)) ||
            (r.description && r.description.toLowerCase().includes(term)) ||
            (r.category && r.category.toLowerCase().includes(term)) ||
            (r.date && r.date.includes(term))
          );
        }
        
        return results;
      },
      
      // Delete a receipt
      async delete(id) {
        try {
          showLoading('Deleting receipt...');
          
          // Find receipt to get image URL
          var receipt = this.receipts.find(r => r.id === id);
          
          // Delete from database
          var { error } = await App.db
            .from('acc_receipts')
            .delete()
            .eq('id', id);
          
          if (error) {
            throw new Error('Failed to delete receipt: ' + error.message);
          }
          
          // Delete image from storage if exists
          if (receipt && receipt.image_url) {
            var fileName = receipt.image_url.split('/').pop();
            await App.db.storage
              .from(this.bucketName)
              .remove([fileName]);
          }
          
          // Remove from local array
          this.receipts = this.receipts.filter(r => r.id !== id);
          this.updateBadge();
          
          hideLoading();
          return true;
          
        } catch (e) {
          hideLoading();
          console.error('Error deleting receipt:', e);
          showNotification('Error deleting receipt: ' + e.message, 'error');
          return false;
        }
      },
      
      // Clear all receipts
      async clearAll() {
        if (!confirm('Are you sure you want to delete ALL receipts? This cannot be undone.')) {
          return;
        }
        
        try {
          showLoading('Deleting all receipts...');
          
          // Delete all from database
          var { error } = await App.db
            .from('acc_receipts')
            .delete()
            .neq('id', ''); // Delete all rows
          
          if (error) {
            throw new Error('Failed to clear receipts: ' + error.message);
          }
          
          // Clear storage bucket
          var { data: files } = await App.db.storage
            .from(this.bucketName)
            .list();
          
          if (files && files.length > 0) {
            var fileNames = files.map(f => f.name);
            await App.db.storage
              .from(this.bucketName)
              .remove(fileNames);
          }
          
          this.receipts = [];
          this.updateBadge();
          
          hideLoading();
          showNotification('All receipts deleted', 'success');
          
        } catch (e) {
          hideLoading();
          console.error('Error clearing receipts:', e);
          showNotification('Error clearing receipts: ' + e.message, 'error');
        }
      },
      
      // Update badge count
      updateBadge() {
        var badge = document.getElementById('receiptsCountBadge');
        if (badge) {
          if (this.receipts.length > 0) {
            badge.textContent = this.receipts.length;
            badge.classList.remove('hidden');
          } else {
            badge.classList.add('hidden');
          }
        }
      },
      
      // Calculate total amount
      getTotalAmount() {
        return this.receipts.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
      },
      
      // Refresh from database
      async refresh() {
        await this.loadFromDatabase();
        this.updateBadge();
      }
    };

    // Initialize receipts store after login
    // (moved to showMainApp function)

    async function openReceiptsGallery() {
      document.getElementById('receiptsGalleryModal').classList.remove('hidden');
      
      // Initialize and refresh receipts from database
      if (!ReceiptsStore.initialized) {
        await ReceiptsStore.init();
      } else {
        await ReceiptsStore.refresh();
      }
      
      renderReceiptsGallery();
      lucide.createIcons();
    }

    function closeReceiptsGallery() {
      document.getElementById('receiptsGalleryModal').classList.add('hidden');
    }

    function filterReceipts(filter) {
      ReceiptsStore.currentFilter = filter;
      
      // Update filter button styles
      document.querySelectorAll('.receipt-filter-btn').forEach(btn => {
        if (btn.dataset.filter === filter) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
      
      renderReceiptsGallery();
    }

    function searchReceipts(term) {
      renderReceiptsGallery(term);
    }

    function renderReceiptsGallery(searchTerm) {
      var receipts = ReceiptsStore.getFiltered(ReceiptsStore.currentFilter, searchTerm || document.getElementById('receiptSearchInput')?.value);
      var grid = document.getElementById('receiptsGalleryGrid');
      var emptyState = document.getElementById('receiptsEmptyState');
      
      // Update count
      document.getElementById('receiptsGalleryCount').textContent = receipts.length;
      document.getElementById('receiptsTotalAmount').textContent = formatCurrency(
        receipts.reduce((sum, r) => {
          var amount = parseFloat(r.amount) || 0;
          if (r.currency && r.currency !== 'ZMW') {
            amount = amount * (App.exchangeRates[r.currency] || 1);
          }
          return sum + amount;
        }, 0)
      );
      
      if (receipts.length === 0) {
        grid.classList.add('hidden');
        emptyState.classList.remove('hidden');
        return;
      }
      
      grid.classList.remove('hidden');
      emptyState.classList.add('hidden');
      
      var html = receipts.map(r => {
        var categoryColors = {
          gaming_operations: 'bg-purple-100 text-purple-700',
          shop_operating: 'bg-amber-100 text-amber-700',
          office_operations: 'bg-blue-100 text-blue-700',
          administrative: 'bg-emerald-100 text-emerald-700',
          sports: 'bg-green-100 text-green-700',
          casino: 'bg-pink-100 text-pink-700',
          other: 'bg-slate-100 text-slate-700'
        };
        var colorClass = categoryColors[r.category] || categoryColors[r.revenue_type] || categoryColors.other;
        var typeLabel = r.type === 'expense' ? (r.category || 'Expense') : (r.revenue_type || 'Revenue');
        var displayAmount = r.currency === 'ZMW' ? formatCurrency(r.amount) : 
                           (CURRENCY_SYMBOLS[r.currency] || '') + parseFloat(r.amount).toLocaleString();
        
        // Use image_url from Supabase or placeholder
        var imageUrl = r.image_url || "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23f1f5f9' width='100' height='100'/><text x='50' y='55' text-anchor='middle' fill='%2394a3b8' font-size='12'>No Image</text></svg>";
        
        return `
          <div class="receipt-gallery-card" onclick="viewReceiptDetail('${r.id}')">
            <img src="${imageUrl}" alt="Receipt" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23f1f5f9%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22 fill=%22%2394a3b8%22 font-size=%2212%22>No Image</text></svg>'">
            <div class="p-4">
              <div class="flex items-center justify-between mb-2">
                <span class="text-lg font-bold ${r.type === 'expense' ? 'text-red-600' : 'text-emerald-600'}">${displayAmount}</span>
                <span class="px-2 py-0.5 rounded-full text-xs ${colorClass}">${typeLabel.replace(/_/g, ' ')}</span>
              </div>
              <p class="text-sm font-medium text-slate-800 truncate">${r.vendor || r.description || 'No description'}</p>
              <p class="text-xs text-slate-500 mt-1">${r.date || 'No date'}</p>
              <div class="flex items-center justify-between mt-3 pt-3 border-t">
                <span class="text-xs text-slate-400">${r.uploaded_at ? new Date(r.uploaded_at).toLocaleDateString() : ''}</span>
                <button onclick="event.stopPropagation(); deleteReceipt('${r.id}')" class="text-red-400 hover:text-red-600 p-1">
                  <i data-lucide="trash-2" class="h-4 w-4"></i>
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      grid.innerHTML = html;
      lucide.createIcons();
    }

    function viewReceiptDetail(id) {
      var receipt = ReceiptsStore.receipts.find(r => r.id === id);
      if (!receipt) return;
      
      var lightbox = document.getElementById('receiptLightbox');
      var image = document.getElementById('receiptLightboxImage');
      var details = document.getElementById('receiptLightboxDetails');
      
      // Use image_url from Supabase
      image.src = receipt.image_url || '';
      
      var displayAmount = receipt.currency === 'ZMW' ? formatCurrency(receipt.amount) : 
                         (CURRENCY_SYMBOLS[receipt.currency] || '') + parseFloat(receipt.amount).toLocaleString();
      
      details.innerHTML = `
        <div class="grid grid-cols-2 gap-3">
          <div>
            <span class="text-slate-500 text-xs">Date</span>
            <p class="font-medium">${receipt.date || 'N/A'}</p>
          </div>
          <div>
            <span class="text-slate-500 text-xs">Amount</span>
            <p class="font-bold ${receipt.type === 'expense' ? 'text-red-600' : 'text-emerald-600'}">${displayAmount}</p>
          </div>
          <div>
            <span class="text-slate-500 text-xs">${receipt.type === 'expense' ? 'Vendor' : 'Type'}</span>
            <p class="font-medium">${receipt.vendor || receipt.revenue_type || 'N/A'}</p>
          </div>
          <div>
            <span class="text-slate-500 text-xs">Category</span>
            <p class="font-medium">${(receipt.category || 'N/A').replace(/_/g, ' ')}</p>
          </div>
          <div class="col-span-2">
            <span class="text-slate-500 text-xs">Description</span>
            <p class="font-medium">${receipt.description || 'N/A'}</p>
          </div>
          ${receipt.receipt_number ? `
          <div class="col-span-2">
            <span class="text-slate-500 text-xs">Receipt Number</span>
            <p class="font-medium">${receipt.receipt_number}</p>
          </div>
          ` : ''}
        </div>
      `;
      
      lightbox.classList.remove('hidden');
      lucide.createIcons();
    }

    function closeReceiptLightbox() {
      document.getElementById('receiptLightbox').classList.add('hidden');
    }

    async function deleteReceipt(id) {
      if (!confirm('Delete this receipt?')) return;
      
      var success = await ReceiptsStore.delete(id);
      if (success) {
        renderReceiptsGallery();
        showNotification('Receipt deleted', 'success');
      }
    }

    function exportReceiptsData() {
      var receipts = ReceiptsStore.getFiltered(ReceiptsStore.currentFilter);
      if (receipts.length === 0) {
        showNotification('No receipts to export', 'error');
        return;
      }
      
      var csv = 'Date,Type,Category,Vendor,Amount,Currency,Description,Receipt Number,Image URL,Uploaded\n';
      receipts.forEach(r => {
        csv += `"${r.date || ''}","${r.type || ''}","${r.category || ''}","${r.vendor || ''}",${r.amount || 0},"${r.currency || 'ZMW'}","${r.description || ''}","${r.receipt_number || ''}","${r.image_url || ''}","${r.uploaded_at || ''}"\n`;
      });
      
      var blob = new Blob([csv], { type: 'text/csv' });
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = 'receipts_export_' + new Date().toISOString().split('T')[0] + '.csv';
      a.click();
      URL.revokeObjectURL(url);
      
      showNotification('Exported ' + receipts.length + ' receipts', 'success');
    }

    // Function to save receipt during import (called from executeImport)
    async function saveReceiptToGallery(data, imageBase64, type) {
      await ReceiptsStore.add({
        type: type, // 'expense' or 'revenue'
        date: data.date || '',
        amount: data.amount || 0,
        currency: data.currency || 'ZMW',
        vendor: data.vendor || '',
        category: data.category_id || data.category || '',
        revenueType: data.type || '',
        description: data.description || '',
        receiptNumber: data.receipt_number || data.reference_number || '',
        image: imageBase64
      });
    }
    // =================================================================
    // END RECEIPTS GALLERY FUNCTIONALITY
    // =================================================================

    // =================================================================
    // AI AGENT - CLAUDE INTEGRATION (ENHANCED FOR ACCOUNTING)
    // Features: Navigation, Transaction Lookup, Export, Conversation Memory
    // =================================================================
    const AI_CONFIG = {
      apiKey: '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',
      model: 'claude-sonnet-4-20250514',
      maxTokens: 1500
    };

    const AIAgent = {
      isOpen: false,
      isLoading: false,
      conversationHistory: [],
      storageKey: 'bwanabet_acc_ai_chat_history',
      
      // Initialize - load saved conversation
      init() {
        this.loadConversation();
      },
      
      // ================= CONVERSATION MEMORY (F) =================
      saveConversation() {
        try {
          const data = {
            history: this.conversationHistory,
            timestamp: Date.now()
          };
          localStorage.setItem(this.storageKey, JSON.stringify(data));
        } catch (e) {
          console.warn('Could not save conversation:', e);
        }
      },
      
      loadConversation() {
        try {
          const saved = localStorage.getItem(this.storageKey);
          if (saved) {
            const data = JSON.parse(saved);
            // Only load if less than 24 hours old
            if (Date.now() - data.timestamp < 24 * 60 * 60 * 1000) {
              this.conversationHistory = data.history || [];
              this.restoreMessagesToUI();
            } else {
              this.clearConversation();
            }
          }
        } catch (e) {
          console.warn('Could not load conversation:', e);
        }
      },
      
      restoreMessagesToUI() {
        const container = document.getElementById('aiChatMessages');
        if (!container || this.conversationHistory.length === 0) return;
        
        this.conversationHistory.forEach(msg => {
          const div = document.createElement('div');
          div.className = 'chat-message ' + msg.role;
          div.innerHTML = msg.role === 'assistant' ? this.formatMessage(msg.content) : msg.content;
          container.appendChild(div);
        });
        container.scrollTop = container.scrollHeight;
      },
      
      clearConversation() {
        this.conversationHistory = [];
        localStorage.removeItem(this.storageKey);
        const container = document.getElementById('aiChatMessages');
        if (container) {
          container.innerHTML = `
            <div class="chat-message assistant">
              üëã Hello! I'm your BwanaBet Accounting AI Assistant. I can help you with:
              <br><br>
              ‚Ä¢ <strong>Financial Analysis</strong> - Revenue, expenses, profit calculations
              <br>‚Ä¢ <strong>Navigation</strong> - Go to any tab or section
              <br>‚Ä¢ <strong>Transaction Lookup</strong> - Find any revenue or expense entry
              <br>‚Ä¢ <strong>Export Data</strong> - Export reports and transactions
              <br><br>
              How can I help you today?
            </div>
          `;
        }
        this.addMessage('üóëÔ∏è Conversation cleared.', 'system');
      },
      
      // ================= NAVIGATION ACTIONS (A) =================
      actions: {
        // Navigate to a specific tab
        navigateToTab(tabName) {
          const validTabs = ['overview', 'revenue', 'expenses', 'reports', 'settings'];
          const tab = tabName.toLowerCase().trim();
          if (validTabs.includes(tab)) {
            switchTab(tab);
            return { success: true, message: 'Navigated to ' + tab.charAt(0).toUpperCase() + tab.slice(1) + ' tab' };
          }
          return { success: false, message: 'Invalid tab: ' + tabName };
        },
        
        // Filter expenses by category
        filterExpenseCategory(category) {
          switchTab('expenses');
          setTimeout(() => {
            if (typeof selectExpenseCategory === 'function') {
              selectExpenseCategory(category);
            }
          }, 100);
          return { success: true, message: 'Filtering expenses by: ' + category };
        },
        
        // ================= TRANSACTION LOOKUP (D) =================
        lookupRevenue(searchTerm) {
          if (!App.revenue || App.revenue.length === 0) {
            return { success: false, message: 'No revenue data loaded' };
          }
          
          const term = String(searchTerm).toLowerCase().trim();
          const results = App.revenue.filter(r => 
            (r.reference_number && r.reference_number.toLowerCase().includes(term)) ||
            (r.description && r.description.toLowerCase().includes(term)) ||
            (r.type && r.type.toLowerCase().includes(term))
          ).slice(0, 5);
          
          if (results.length > 0) {
            return {
              success: true,
              transactions: results.map(r => ({
                date: r.date,
                type: r.type,
                amount: formatCurrency(r.amount_base || r.amount),
                description: r.description || 'N/A',
                reference: r.reference_number || 'N/A'
              }))
            };
          }
          return { success: false, message: 'No revenue found matching: ' + searchTerm };
        },
        
        lookupExpense(searchTerm) {
          if (!App.expenses || App.expenses.length === 0) {
            return { success: false, message: 'No expense data loaded' };
          }
          
          const term = String(searchTerm).toLowerCase().trim();
          const results = App.expenses.filter(e => 
            (e.receipt_number && e.receipt_number.toLowerCase().includes(term)) ||
            (e.description && e.description.toLowerCase().includes(term)) ||
            (e.vendor && e.vendor.toLowerCase().includes(term)) ||
            (e.category_id && e.category_id.toLowerCase().includes(term))
          ).slice(0, 5);
          
          if (results.length > 0) {
            return {
              success: true,
              transactions: results.map(e => ({
                date: e.date,
                category: e.category_id,
                vendor: e.vendor || 'N/A',
                amount: formatCurrency(e.amount_base || e.amount),
                description: e.description || 'N/A',
                receipt: e.receipt_number || 'N/A'
              }))
            };
          }
          return { success: false, message: 'No expenses found matching: ' + searchTerm };
        },
        
        // ================= EXPORT ASSISTANCE (E) =================
        exportRevenue(format) {
          if (typeof exportRevenue === 'function') {
            exportRevenue(format || 'csv');
            return { success: true, message: 'Exporting revenue data as ' + (format || 'CSV') };
          }
          return { success: false, message: 'Export function not available' };
        },
        
        exportExpenses(format) {
          if (typeof exportExpenses === 'function') {
            exportExpenses(format || 'csv');
            return { success: true, message: 'Exporting expenses data as ' + (format || 'CSV') };
          }
          return { success: false, message: 'Export function not available' };
        },
        
        // Get financial summary
        getFinancialSummary() {
          const totalRevenue = App.revenue.reduce((sum, r) => sum + (parseFloat(r.amount_base) || parseFloat(r.amount) || 0), 0);
          const totalExpenses = App.expenses.reduce((sum, e) => sum + (parseFloat(e.amount_base) || parseFloat(e.amount) || 0), 0);
          const netProfit = totalRevenue - totalExpenses;
          
          // Revenue breakdown
          const sportsRevenue = App.revenue.filter(r => r.type === 'sports').reduce((sum, r) => sum + (parseFloat(r.amount_base) || 0), 0);
          const casinoRevenue = App.revenue.filter(r => r.type === 'casino').reduce((sum, r) => sum + (parseFloat(r.amount_base) || 0), 0);
          const otherRevenue = App.revenue.filter(r => r.type !== 'sports' && r.type !== 'casino').reduce((sum, r) => sum + (parseFloat(r.amount_base) || 0), 0);
          
          // Expense breakdown
          const gamingExpenses = App.expenses.filter(e => e.category_id === 'gaming_operations').reduce((sum, e) => sum + (parseFloat(e.amount_base) || 0), 0);
          const shopExpenses = App.expenses.filter(e => e.category_id === 'shop_operating').reduce((sum, e) => sum + (parseFloat(e.amount_base) || 0), 0);
          const officeExpenses = App.expenses.filter(e => e.category_id === 'office_operations').reduce((sum, e) => sum + (parseFloat(e.amount_base) || 0), 0);
          const adminExpenses = App.expenses.filter(e => e.category_id === 'administrative').reduce((sum, e) => sum + (parseFloat(e.amount_base) || 0), 0);
          
          return {
            success: true,
            summary: {
              totalRevenue: formatCurrency(totalRevenue),
              totalExpenses: formatCurrency(totalExpenses),
              netProfit: formatCurrency(netProfit),
              profitMargin: totalRevenue > 0 ? ((netProfit / totalRevenue) * 100).toFixed(1) + '%' : '0%',
              revenueBreakdown: {
                sports: formatCurrency(sportsRevenue),
                casino: formatCurrency(casinoRevenue),
                other: formatCurrency(otherRevenue)
              },
              expenseBreakdown: {
                gaming: formatCurrency(gamingExpenses),
                shop: formatCurrency(shopExpenses),
                office: formatCurrency(officeExpenses),
                admin: formatCurrency(adminExpenses)
              },
              transactionCounts: {
                revenue: App.revenue.length,
                expenses: App.expenses.length
              }
            }
          };
        }
      },
      
      // Parse AI response for action commands and execute them
      parseAndExecuteActions(text) {
        const actionRegex = /\[ACTION:(\w+):([^\]]+)\]/g;
        let match;
        const results = [];
        
        while ((match = actionRegex.exec(text)) !== null) {
          const actionType = match[1];
          const actionParams = match[2].split(',').map(s => s.trim());
          
          let result;
          switch (actionType) {
            case 'navigate':
              result = this.actions.navigateToTab(actionParams[0]);
              break;
            case 'filterexpense':
              result = this.actions.filterExpenseCategory(actionParams[0]);
              break;
            case 'lookuprevenue':
              result = this.actions.lookupRevenue(actionParams[0]);
              break;
            case 'lookupexpense':
              result = this.actions.lookupExpense(actionParams[0]);
              break;
            case 'exportrevenue':
              result = this.actions.exportRevenue(actionParams[0]);
              break;
            case 'exportexpenses':
              result = this.actions.exportExpenses(actionParams[0]);
              break;
            case 'summary':
              result = this.actions.getFinancialSummary();
              break;
            default:
              result = { success: false, message: 'Unknown action: ' + actionType };
          }
          results.push(result);
        }
        
        // Remove action tags from displayed text
        const cleanText = text.replace(actionRegex, '').trim();
        
        return { cleanText, results };
      },
      
      toggle() {
        this.isOpen = !this.isOpen;
        const panel = document.getElementById('aiChatPanel');
        const dot = document.getElementById('aiNotificationDot');
        
        if (this.isOpen) {
          panel.classList.add('open');
          if (dot) dot.style.display = 'none';
          document.getElementById('aiChatInput').focus();
        } else {
          panel.classList.remove('open');
        }
      },
      
      handleKeydown(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
          event.preventDefault();
          this.send();
        }
      },
      
      autoResize(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
      },
      
      quickAction(message) {
        document.getElementById('aiChatInput').value = message;
        this.send();
      },
      
      addMessage(content, role) {
        const messagesContainer = document.getElementById('aiChatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'chat-message ' + role;
        
        if (role === 'assistant') {
          content = this.formatMessage(content);
        }
        
        messageDiv.innerHTML = content;
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      },
      
      formatMessage(text) {
        return text
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/\*(.*?)\*/g, '<em>$1</em>')
          .replace(/`([^`]+)`/g, '<code>$1</code>')
          .replace(/```([\s\S]*?)```/g, '<pre>$1</pre>')
          .replace(/\n/g, '<br>');
      },
      
      showTyping(show) {
        const messagesContainer = document.getElementById('aiChatMessages');
        const existingIndicator = document.getElementById('typingIndicator');
        
        if (show && !existingIndicator) {
          const indicator = document.createElement('div');
          indicator.id = 'typingIndicator';
          indicator.className = 'typing-indicator';
          indicator.innerHTML = '<span></span><span></span><span></span>';
          messagesContainer.appendChild(indicator);
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        } else if (!show && existingIndicator) {
          existingIndicator.remove();
        }
      },
      
      buildContext() {
        // Calculate financials
        const totalRevenue = App.revenue.reduce((sum, r) => sum + (parseFloat(r.amount_base) || parseFloat(r.amount) || 0), 0);
        const totalExpenses = App.expenses.reduce((sum, e) => sum + (parseFloat(e.amount_base) || parseFloat(e.amount) || 0), 0);
        const netProfit = totalRevenue - totalExpenses;
        
        // Revenue by type
        const sportsRev = App.revenue.filter(r => r.type === 'sports').reduce((sum, r) => sum + (parseFloat(r.amount_base) || 0), 0);
        const casinoRev = App.revenue.filter(r => r.type === 'casino').reduce((sum, r) => sum + (parseFloat(r.amount_base) || 0), 0);
        const otherRev = App.revenue.filter(r => r.type !== 'sports' && r.type !== 'casino').reduce((sum, r) => sum + (parseFloat(r.amount_base) || 0), 0);
        
        // Expenses by category
        const gamingExp = App.expenses.filter(e => e.category_id === 'gaming_operations').reduce((sum, e) => sum + (parseFloat(e.amount_base) || 0), 0);
        const shopExp = App.expenses.filter(e => e.category_id === 'shop_operating').reduce((sum, e) => sum + (parseFloat(e.amount_base) || 0), 0);
        const officeExp = App.expenses.filter(e => e.category_id === 'office_operations').reduce((sum, e) => sum + (parseFloat(e.amount_base) || 0), 0);
        const adminExp = App.expenses.filter(e => e.category_id === 'administrative').reduce((sum, e) => sum + (parseFloat(e.amount_base) || 0), 0);
        
        const activeTab = document.querySelector('.tab-btn.active span')?.textContent?.trim() || 'Overview';
        const displayCurrency = App.displayCurrency || 'ZMW';
        
        // Recent transactions
        const recentRevenue = App.revenue.slice(0, 3).map(r => r.date + ': ' + r.type + ' - ' + formatCurrency(r.amount_base || r.amount)).join('; ');
        const recentExpenses = App.expenses.slice(0, 3).map(e => e.date + ': ' + e.category_id + ' - ' + formatCurrency(e.amount_base || e.amount)).join('; ');
        
        return `You are the BwanaBet Accounting AI Assistant with ACTION capabilities. You can navigate, lookup transactions, and export data.

CURRENT STATE:
- Active Tab: ${activeTab}
- Display Currency: ${displayCurrency}
- Exchange Rates: 1 USD = ${App.exchangeRates.USD} ZMW, 1 EUR = ${App.exchangeRates.EUR} ZMW

FINANCIAL SUMMARY:
- Total Revenue: ${formatCurrency(totalRevenue)}
- Total Expenses: ${formatCurrency(totalExpenses)}
- Net Profit: ${formatCurrency(netProfit)}
- Profit Margin: ${totalRevenue > 0 ? ((netProfit / totalRevenue) * 100).toFixed(1) : 0}%

REVENUE BREAKDOWN:
- Sports Betting: ${formatCurrency(sportsRev)}
- Casino: ${formatCurrency(casinoRev)}
- Other: ${formatCurrency(otherRev)}
- Total Entries: ${App.revenue.length}

EXPENSE BREAKDOWN:
- Gaming Operations: ${formatCurrency(gamingExp)}
- Shop Operating: ${formatCurrency(shopExp)}
- Office Operations: ${formatCurrency(officeExp)}
- Administrative: ${formatCurrency(adminExp)}
- Total Entries: ${App.expenses.length}

RECENT REVENUE: ${recentRevenue || 'None'}
RECENT EXPENSES: ${recentExpenses || 'None'}

BUDGET TARGETS:
- Sports Target: K${App.params.sportsTarget.toLocaleString()}
- Casino Target: K${App.params.casinoTarget.toLocaleString()}
- Gaming Budget: K${App.params.gamingBudget.toLocaleString()}
- Shop Budget: K${App.params.shopBudget.toLocaleString()}

=== ACTION COMMANDS ===
Include these tags in your response to execute actions:

NAVIGATION:
[ACTION:navigate:overview] - Go to Overview/Dashboard
[ACTION:navigate:revenue] - Go to Revenue tab
[ACTION:navigate:expenses] - Go to Expenses tab
[ACTION:navigate:reports] - Go to Reports tab
[ACTION:navigate:settings] - Go to Settings tab

EXPENSE FILTERS:
[ACTION:filterexpense:all] - Show all expenses
[ACTION:filterexpense:gaming_operations] - Filter gaming expenses
[ACTION:filterexpense:shop_operating] - Filter shop expenses
[ACTION:filterexpense:office_operations] - Filter office expenses
[ACTION:filterexpense:administrative] - Filter admin expenses

TRANSACTION LOOKUP:
[ACTION:lookuprevenue:SEARCH_TERM] - Search revenue by reference, description, or type
[ACTION:lookupexpense:SEARCH_TERM] - Search expenses by receipt, vendor, description, or category

EXPORT:
[ACTION:exportrevenue:csv] - Export revenue as CSV
[ACTION:exportrevenue:excel] - Export revenue as Excel
[ACTION:exportexpenses:csv] - Export expenses as CSV
[ACTION:exportexpenses:excel] - Export expenses as Excel

=== RULES ===
1. When user asks to "go to", "show", "navigate" ‚Üí use navigate action
2. When user asks about specific expense category ‚Üí use filterexpense action
3. When user asks to "find", "search", "lookup" transaction ‚Üí use lookup actions
4. When user asks to "export", "download" ‚Üí use export actions
5. Always execute relevant actions, don't just describe how to do it
6. After actions, briefly confirm what you did
7. For lookups, display found transactions in a formatted way
8. Be concise - users want actions and data, not lengthy explanations
9. Only answer questions about the accounting system
10. Use actual financial data in your responses`;
      },
      
      async send() {
        const input = document.getElementById('aiChatInput');
        const sendBtn = document.getElementById('aiSendBtn');
        const message = input.value.trim();
        
        if (!message || this.isLoading) return;
        
        // Add user message
        this.addMessage(message, 'user');
        this.conversationHistory.push({ role: 'user', content: message });
        
        // Clear input
        input.value = '';
        input.style.height = 'auto';
        this.isLoading = true;
        sendBtn.disabled = true;
        this.showTyping(true);
        
        try {
          const response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': AI_CONFIG.apiKey,
              'anthropic-version': '2023-06-01',
              'anthropic-dangerous-direct-browser-access': 'true'
            },
            body: JSON.stringify({
              model: AI_CONFIG.model,
              max_tokens: AI_CONFIG.maxTokens,
              system: this.buildContext(),
              messages: this.conversationHistory
            })
          });
          
          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error?.message || 'API request failed');
          }
          
          const data = await response.json();
          let assistantMessage = data.content[0].text;
          
          // Parse and execute any actions
          const { cleanText, results } = this.parseAndExecuteActions(assistantMessage);
          
          // Store the clean version in history
          this.conversationHistory.push({ role: 'assistant', content: cleanText });
          
          // Save conversation to localStorage
          this.saveConversation();
          
          this.showTyping(false);
          this.addMessage(cleanText, 'assistant');
          
          // Show transaction results if any
          results.forEach(r => {
            if (r.success && r.transactions) {
              let html = '<div style="background:#f1f5f9;padding:12px;border-radius:8px;margin-top:8px;font-size:13px;">';
              html += '<strong>Found ' + r.transactions.length + ' transaction(s):</strong><br><br>';
              r.transactions.forEach((t, i) => {
                html += '<div style="padding:8px;background:white;border-radius:6px;margin-bottom:8px;">';
                if (t.type) {
                  // Revenue
                  html += 'üìÖ ' + t.date + ' | <strong>' + t.type.toUpperCase() + '</strong><br>';
                  html += 'üí∞ ' + t.amount + '<br>';
                  html += 'üìù ' + t.description + '<br>';
                  html += 'üîñ Ref: ' + t.reference;
                } else {
                  // Expense
                  html += 'üìÖ ' + t.date + ' | <strong>' + t.category + '</strong><br>';
                  html += 'üè¢ ' + t.vendor + '<br>';
                  html += 'üí∏ ' + t.amount + '<br>';
                  html += 'üìù ' + t.description + '<br>';
                  html += 'üßæ Receipt: ' + t.receipt;
                }
                html += '</div>';
              });
              html += '</div>';
              this.addMessage(html, 'assistant');
            } else if (r.success && r.summary) {
              // Financial summary
              const s = r.summary;
              let html = '<div style="background:#f1f5f9;padding:12px;border-radius:8px;margin-top:8px;font-size:13px;">';
              html += '<strong>üìä Financial Summary</strong><br><br>';
              html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">';
              html += '<div style="background:#d1fae5;padding:8px;border-radius:6px;">Revenue: ' + s.totalRevenue + '</div>';
              html += '<div style="background:#fee2e2;padding:8px;border-radius:6px;">Expenses: ' + s.totalExpenses + '</div>';
              html += '<div style="background:#dbeafe;padding:8px;border-radius:6px;">Net Profit: ' + s.netProfit + '</div>';
              html += '<div style="background:#fef3c7;padding:8px;border-radius:6px;">Margin: ' + s.profitMargin + '</div>';
              html += '</div>';
              html += '</div>';
              this.addMessage(html, 'assistant');
            }
          });
          
        } catch (error) {
          console.error('AI Agent Error:', error);
          this.showTyping(false);
          this.addMessage('‚ùå Error: ' + error.message, 'system');
        } finally {
          this.isLoading = false;
          sendBtn.disabled = false;
          input.focus();
        }
      }
    };
    
    // Initialize AI Agent when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(() => AIAgent.init(), 500);
    });
    // =================================================================
    // END AI AGENT
    // =================================================================
  </script>
</body>
</html>
 